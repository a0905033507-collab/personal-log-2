<!doctype html>
<!--
  Personal Log (Mobile Only)

  This singleâ€‘page web application replicates the functionality and design of the
  original multiâ€‘device Personal Log, but is simplified to run entirely on a
  single device with no dependencies on Firebase or any external backend.
  All data is stored in the browser's LocalStorage. The UI remains
  responsive but focuses on mobile usage â€” the layout defaults to a single
  column on small screens and collapses navigation into a simple list at
  the top of the page.

  To deploy this site for personal use, simply upload this file as
  index.html to any static host (GitHub Pages, Netlify, Vercel) or open it
  directly on your phone.
-->
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Personal Log (Mobile) | å¥èº«ãƒ»æ—¥è¨˜ãƒ»å­¸ç¿’ãƒ»æ”¶æ”¯</title>

  <!-- Chart.js for charts -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <!-- Markmap for mind maps -->
  <script src="https://cdn.jsdelivr.net/npm/markmap-lib@0.17.2/dist/browser/index.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/markmap-view@0.17.2/dist/browser/index.min.js"></script>
  <!-- Tesseract.js for OCR on uploaded images in the learning section -->
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@2.1.5/dist/tesseract.min.js"></script>

  <style>
    /*
      THEME & VARIABLES

      A warm palette with moderate brightness and lowâ€“medium saturation. Each
      functional category has its own accent colour. The layout adapts to
      mobile first: on small screens, content is presented in a single
      column, and navigation controls are stacked for easy thumb reach.
    */
    :root{
      --bg: #f6f2ee;
      --panel: #fffaf5;
      --card: #ffffff;
      --text: #2a2521;
      --muted: #6f655c;
      --border: rgba(60,45,35,.12);
      --shadow: 0 8px 20px rgba(30,20,10,.10);
      --shadow2: 0 4px 12px rgba(30,20,10,.08);

      --fit: #ffb277;
      --diary: #ff8ea1;
      --learn: #7fd2b8;
      --money: #7bb2ff;
      --accent: #d2794a;
      --danger: #c84c4c;
      /* New accent colour for the overview section */
      --overview: #c8a2ff;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans TC", "PingFang TC", "Microsoft JhengHei", Arial, sans-serif;
      background: radial-gradient(900px 500px at 30% -5%, rgba(210,121,74,.12), transparent 55%),
                  radial-gradient(700px 400px at 90% 15%, rgba(123,178,255,.12), transparent 50%),
                  var(--bg);
      color:var(--text);
    }
    /* Layout container: sidebar replaced by top nav for mobile. */
    .app{
      display:flex;
      flex-direction:column;
      min-height:100vh;
    }
    /* Top navigation bar */
    .topnav{
      display:flex;
      flex-direction:column;
      padding:12px 16px;
      background: linear-gradient(180deg, rgba(255,250,245,.92), rgba(246,242,238,.90));
      border-bottom:1px solid var(--border);
      position:sticky;
      top:0;
      z-index:10;
      backdrop-filter:blur(6px);
    }
    .brand{
      display:flex;
      align-items:center;
      gap:10px;
    }
    .brand h1{
      font-size:16px;
      margin:0;
    }
    .brand p{
      margin:2px 0 0;
      font-size:12px;
      color:var(--muted);
      line-height:1.4;
    }
    .nav{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-top:10px;
    }
    .nav button{
      flex:1 1 calc(50% - 8px);
      display:flex;
      align-items:center;
      gap:8px;
      padding:8px 12px;
      border-radius:12px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.60);
      cursor:pointer;
      text-align:left;
      transition:.15s transform, .15s background;
    }
    .nav button:hover{transform: translateY(-1px); background: rgba(255,255,255,.75);}    
    .nav button.active{
      background: rgba(255,255,255,.92);
      border-color: rgba(210,121,74,.35);
      box-shadow: var(--shadow2);
    }
    .dot{width:8px;height:8px;border-radius:99px;}
    .dot.fit{background:var(--fit)}
    .dot.diary{background:var(--diary)}
    .dot.learn{background:var(--learn)}
    .dot.money{background:var(--money)}
    .dot.overview{background:var(--overview)}
    .small{font-size:11px;color:var(--muted)}
    .top-actions{
      display:flex;
      gap:6px;
      margin-top:10px;
      flex-wrap:wrap;
    }
    .top-actions button, .top-actions label{
      flex:1 1 calc(50% - 6px);
      border:1px solid var(--border);
      background: rgba(255,255,255,.55);
      border-radius:10px;
      padding:8px 10px;
      cursor:pointer;
      font-size:12px;
      text-align:center;
    }
    .top-actions button:hover, .top-actions label:hover{background: rgba(255,255,255,.70);}    
    .top-actions input{display:none}

    /* Collapsible navigation bar styles */
    .topnav-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
    }
    .nav-toggle{
      background:none;
      border:1px solid var(--border);
      border-radius:8px;
      padding:6px 10px;
      font-size:18px;
      line-height:1;
      cursor:pointer;
      color:var(--text);
    }
    .nav-toggle:hover{
      background:rgba(255,255,255,.70);
    }

  /* Container for home and nav toggle buttons */
  .header-controls{
    display:flex;
    align-items:center;
    gap:6px;
  }

  /* Home button styles (same baseline as nav-toggle) */
  .home-toggle{
    background:none;
    border:1px solid var(--border);
    border-radius:8px;
    padding:6px 10px;
    font-size:18px;
    line-height:1;
    cursor:pointer;
    color:var(--text);
    display:flex;
    align-items:center;
    justify-content:center;
  }
  .home-toggle:hover{
    background:rgba(255,255,255,.70);
  }
    /* When navigation is collapsed, hide nav-content */
    .topnav.collapsed .nav-content{
      display:none;
    }

    .main{
      flex:1;
      padding:16px;
      width:100%;
      max-width:900px;
      margin:0 auto;
    }
    .header{
      display:flex;
      justify-content:space-between;
      align-items:flex-end;
      margin-bottom:12px;
    }
    .title h2{margin:0;font-size:20px;letter-spacing:.2px}
    .title p{margin:4px 0 0;color:var(--muted);font-size:12px}
    .pill{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:4px 8px;
      border-radius:99px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.65);
      font-size:12px;
      color:var(--muted);
    }
    .pill.fit{border-color:rgba(255,178,119,.35)}
    .pill.diary{border-color:rgba(255,142,161,.35)}
    .pill.learn{border-color:rgba(127,210,184,.35)}
    .pill.money{border-color:rgba(123,178,255,.35)}
    .pill.overview{border-color:rgba(200,162,255,.35)}
    .grid{
      display:flex;
      flex-direction:column;
      gap:14px;
    }
    .card{
      border:1px solid var(--border);
      background: rgba(255,255,255,.78);
      border-radius:16px;
      box-shadow: var(--shadow2);
      padding:12px;
    }
    .form{
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .row{
      display:flex;
      gap:8px;
      align-items:center;
    }
    .row label{
      width:90px;
      font-size:12px;
      color:var(--muted);
    }
    input, select, textarea{
      flex:1;
      border:1px solid var(--border);
      border-radius:10px;
      padding:8px 8px;
      background: rgba(255,255,255,.85);
      color:var(--text);
      outline:none;
      font-size:13px;
    }
    textarea{min-height:80px; resize:vertical; line-height:1.4}
    .btns{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
    }
    .btn{
      flex:1;
      border:1px solid var(--border);
      border-radius:10px;
      padding:8px 10px;
      cursor:pointer;
      background: rgba(255,255,255,.75);
      font-size:12px;
    }
    .btn.primary{
      background: rgba(210,121,74,.18);
      border-color: rgba(210,121,74,.35);
    }
    .btn.danger{
      background: rgba(200,76,76,.14);
      border-color: rgba(200,76,76,.30);
      color:#7a1f1f;
    }
    .btn:hover{background: rgba(255,255,255,.88)}
    .btn.primary:hover{background: rgba(210,121,74,.22)}
    .btn.danger:hover{background: rgba(200,76,76,.18)}

    .list{display:flex;flex-direction:column;gap:8px;}
    .item{
      border:1px solid var(--border);
      background: rgba(255,255,255,.78);
      border-radius:14px;
      padding:10px;
      box-shadow: var(--shadow2);
    }
    .meta{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      font-size:11px;
      color:var(--muted);
      margin-bottom:4px;
    }
    .meta b{color:var(--text); font-weight:600;}
    .tag{
      display:inline-flex;
      align-items:center;
      gap:4px;
      padding:2px 6px;
      border-radius:99px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.65);
      font-size:11px;
      color:var(--muted);
    }
    .kpi{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
    }
    .kpi .box{
      flex:1;
      border:1px solid var(--border);
      background: rgba(255,255,255,.70);
      border-radius:14px;
      padding:8px;
      min-width:70px;
    }
    .kpi .n{font-size:14px;font-weight:700;margin-top:2px}
    .kpi .t{font-size:11px;color:var(--muted)}

    .split{
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .folder{
      border:1px solid var(--border);
      border-radius:14px;
      background: rgba(255,255,255,.65);
      padding:8px;
    }
    .folder h4{
      margin:0 0 6px;
      font-size:11px;
      color:var(--muted);
      letter-spacing:.2px;
    }
    .tree{
      display:flex;
      flex-direction:column;
      gap:6px;
      max-height:260px;
      overflow:auto;
      padding-right:2px;
    }
    .tree button{
      border:1px solid var(--border);
      background: rgba(255,255,255,.70);
      border-radius:10px;
      padding:6px 8px;
      cursor:pointer;
      font-size:11px;
      color:var(--text);
      text-align:left;
    }
    .tree button.active{
      border-color: rgba(210,121,74,.35);
      background: rgba(255,255,255,.85);
    }
    .hint{font-size:11px;color:var(--muted);line-height:1.4}
    canvas{max-width:100%;}
    .chart-wrap{
      border:1px solid var(--border);
      background: rgba(255,255,255,.70);
      border-radius:14px;
      padding:8px;
      box-shadow: var(--shadow2);
    }

    /* Details list next to pie charts */
    .pie-details{
      /* Bigger bold text for percentage and category names. This matches the export style. */
      font-size:20px;
      font-weight:700;
      color:var(--text);
      line-height:1.6;
      /* Remove top margin so it can sit flush next to chart when in a flex row */
      margin-top:0;
    }

    /* Layout for chart and its details to appear side by side */
    .pie-row{
      display:flex;
      align-items:center;
      gap:12px;
      flex-wrap:nowrap;
    }
    /* Ensure chart and details each occupy roughly half of the row */
    .pie-row .chart-wrap{
      flex:0 0 50%;
    }
    .pie-row .pie-details{
      flex:0 0 50%;
      min-width:0;
    }

    /* Recommendation section styling */
    .recommendations{
      border:1px solid var(--border);
      background: rgba(255,255,255,.78);
      border-radius:16px;
      padding:10px;
      margin-top:14px;
      box-shadow: var(--shadow2);
    }
    .recommendations .rec-toggle{
      width:100%;
      display:flex;
      align-items:center;
      justify-content:space-between;
      background:none;
      border:none;
      font-size:14px;
      font-weight:600;
      color:var(--text);
      cursor:pointer;
      padding:6px 4px;
    }
    .recommendations .rec-toggle:hover{
      background: rgba(255,255,255,.70);
    }
    .recommendations.collapsed .rec-content{
      display:none;
    }
    .recommendations .rec-content p{
      margin:6px 0;
      font-size:14px;
      color:var(--text);
      line-height:1.5;
    }

    /* Collapsible card layout */
    .card.collapsed .card-body{
      /* When a card has the collapsed class, hide its body entirely. Use
         !important to ensure this takes precedence over any other display
         properties that might be applied by nested elements. */
      display:none !important;
    }
    .card-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      cursor:pointer;
      user-select:none;
    }
    .card-header h3{
      margin:0;
      font-size:14px;
    }
    .card-arrow{
      font-size:16px;
      transition:transform 0.2s ease;
    }
    .card.collapsed .card-arrow{
      transform:rotate(-90deg);
    }

    /* Home page layout */
    .home-page{
      display:flex;
      flex-direction:column;
      align-items:center;
      text-align:center;
      padding:40px 20px;
    }
    .home-page h1{
      font-size:28px;
      margin:0 0 16px;
    }
    .home-page p{
      font-size:16px;
      color:var(--muted);
      margin:0 0 24px;
    }
    .home-cats{
      display:flex;
      flex-direction:column;
      gap:12px;
      width:100%;
    }
    .home-cat{
      display:flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      padding:14px 16px;
      border:1px solid var(--border);
      border-radius:14px;
      background:rgba(255,255,255,.8);
      font-size:16px;
      font-weight:600;
      color:var(--text);
      cursor:pointer;
      box-shadow: var(--shadow2);
      transition:transform 0.1s, box-shadow 0.1s;
    }
    .home-cat:hover{
      transform: translateY(-2px);
      box-shadow: var(--shadow);
    }
    .home-cat.glow{
      box-shadow:0 0 12px rgba(210,121,74,0.7);
      border-color:rgba(210,121,74,0.5);
    }
    .recommendations .rec-content p strong{
      font-weight:700;
    }
    .recommendations .disclaimer{
      font-size:11px;
      color:var(--muted);
      margin-top:8px;
    }
    .table{
      width:100%;
      border-collapse:separate;
      border-spacing:0 4px;
      font-size:11px;
    }
    .table th{
      text-align:left;
      color:var(--muted);
      font-weight:600;
      padding:0 4px;
    }
    .table td{
      padding:6px 4px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.68);
      border-radius:8px;
    }
    .right{text-align:right;}
  </style>
</head>
<body>
<div class="app">
  <header class="topnav">
    <!-- Top navigation header with brand and toggle button -->
    <div class="topnav-header">
      <div class="brand">
        <div style="font-size:18px;line-height:1">ğŸ—‚ï¸</div>
        <div>
          <h1>Personal Log</h1>
          <p>å¥èº«ãƒ»æ—¥è¨˜ãƒ»å­¸ç¿’ãƒ»æ”¶æ”¯<br/>è³‡æ–™åƒ…å­˜æ–¼æœ¬æ©Ÿç€è¦½å™¨</p>
        </div>
      </div>
      <!-- Container for home and nav toggle buttons -->
      <div class="header-controls">
        <!-- Home button to return to the landing page -->
        <button id="homeBtn" class="home-toggle" aria-label="é¦–é ">
          <svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true" focusable="false"><path d="M3 10 L12 3 L21 10 V21 H14 V14 H10 V21 H3 Z" fill="none" stroke="currentColor" stroke-width="2" stroke-linejoin="round" stroke-linecap="round"/></svg>
        </button>
        <!-- Hamburger button to collapse or expand navigation; text will toggle via JS -->
        <button id="navToggle" class="nav-toggle" aria-label="åˆ‡æ›å°èˆª">â˜°</button>
      </div>
    </div>
    <!-- Collapsible navigation content: nav buttons, actions and hint -->
    <div class="nav-content">
      <div class="nav" id="nav">
        <!-- åˆå§‹ä¸è¨­ç½® activeï¼Œé¦–æ¬¡è¼‰å…¥æ™‚å°‡é è¨­é¡¯ç¤ºé¦–é ï¼ˆview-homeï¼‰ -->
        <button data-view="fitness"><span class="dot fit"></span> ğŸ‹ï¸ å¥èº« <span class="small">Workout</span></button>
        <button data-view="diary"><span class="dot diary"></span> ğŸ““ æ—¥è¨˜ <span class="small">Diary</span></button>
        <button data-view="learning"><span class="dot learn"></span> ğŸ“š å­¸ç¿’ <span class="small">Learning</span></button>
        <button data-view="finance"><span class="dot money"></span> ğŸ’° æ”¶æ”¯ <span class="small">Finance</span></button>
        <button data-view="overview"><span class="dot overview"></span> ğŸŒŸ ç¸½è¦½ <span class="small">Overview</span></button>
      </div>
      <div class="top-actions">
        <button id="btnExport">åŒ¯å‡ºè³‡æ–™</button>
        <button id="btnExportImage">åŒ¯å‡ºåœ–åƒ</button>
        <label for="importFile">åŒ¯å…¥è³‡æ–™<input id="importFile" type="file" accept="application/json"/></label>
        <button id="btnReset" class="danger" style="flex-basis:100%">æ¸…é™¤æ‰€æœ‰è³‡æ–™</button>
      </div>
      <div style="margin-top:8px" class="hint">å»ºè­°ï¼šå¶çˆ¾åŒ¯å‡ºå‚™ä»½ã€‚è‹¥æ¸…é™¤ç€è¦½å™¨è³‡æ–™ï¼Œæœ¬ç¶²ç«™è¨˜éŒ„ä¹Ÿæœƒä¸€ä½µæ¶ˆå¤±ã€‚</div>
    </div>
  </header>
  <main class="main">
    <div id="view-fitness" class="view"></div>
    <div id="view-diary" class="view" style="display:none"></div>
    <div id="view-learning" class="view" style="display:none"></div>
    <div id="view-finance" class="view" style="display:none"></div>
    <div id="view-overview" class="view" style="display:none"></div>
    <div id="view-home" class="view" style="display:none"></div>
  </main>

  <!-- Export Image Modal -->
  <div id="exportImageModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000; align-items:center; justify-content:center;">
    <div style="background:#fffaf5; border-radius:12px; padding:16px; width:90%; max-width:340px; box-shadow: var(--shadow2);">
      <h3 style="margin-top:0; font-size:16px;">é¸æ“‡åœ–åƒåŒ¯å‡ºåˆ†é¡</h3>
      <div style="display:flex; flex-direction:column; gap:8px; margin-bottom:12px;">
        <label style="display:flex; align-items:center; gap:6px;">
          <input type="checkbox" id="export_all" /> <span>å…¨é¸</span>
        </label>
        <label style="display:flex; align-items:center; gap:6px;">
          <input type="checkbox" class="export-cat" value="fitness" /> <span>å¥èº«</span>
        </label>
        <label style="display:flex; align-items:center; gap:6px;">
          <input type="checkbox" class="export-cat" value="diary" /> <span>æ—¥è¨˜</span>
        </label>
        <label style="display:flex; align-items:center; gap:6px;">
          <input type="checkbox" class="export-cat" value="learning" /> <span>å­¸ç¿’</span>
        </label>
        <label style="display:flex; align-items:center; gap:6px;">
          <input type="checkbox" class="export-cat" value="finance" /> <span>æ”¶æ”¯</span>
        </label>
      </div>
      <div style="display:flex; gap:10px; justify-content:flex-end;">
        <button id="exportImageCancel" class="btn" style="padding:6px 12px; border:1px solid var(--border); border-radius:10px; background: rgba(255,255,255,.60);">å–æ¶ˆ</button>
        <button id="exportImageConfirm" class="btn primary" style="padding:6px 12px; border:1px solid rgba(210,121,74,.35); border-radius:10px; background: rgba(210,121,74,.18);">åŒ¯å‡º</button>
      </div>
    </div>
  </div>
</div>

<script>
/* =========================
   Local Storage & State Management
   This mobile version stores all records in the browser's LocalStorage. Each
   category is stored as an array under a single key. There is no remote
   synchronisation.
========================= */
const STORAGE_KEY = 'personal_log_mobile_v1';
const defaultState = () => ({ workouts: [], diaries: [], learnings: [], transactions: [], subscriptions: [] });
let state = defaultState();
function saveStateLocal(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }
function loadStateLocal(){ try{ const raw = localStorage.getItem(STORAGE_KEY); if(!raw) return defaultState(); const parsed = JSON.parse(raw); return Object.assign(defaultState(), parsed); }catch(e){ return defaultState(); }}

/* =========================
   Utilities
========================= */
function uid(prefix='id'){ return prefix + '_' + Math.random().toString(16).slice(2) + '_' + Date.now().toString(16); }
function pad2(n){ return String(n).padStart(2,'0'); }
function toISODate(d){ const y=d.getFullYear(), m=pad2(d.getMonth()+1), day=pad2(d.getDate()); return `${y}-${m}-${day}`; }
function toMonthKey(dateStr){ const d=new Date(dateStr); const y=d.getFullYear(), m=pad2(d.getMonth()+1); return `${y}-${m}`; }
function fmtDateTime(dateStr){ const d=new Date(dateStr); if(Number.isNaN(d.getTime())) return dateStr; return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())} ${pad2(d.getHours())}:${pad2(d.getMinutes())}`; }
function fmtMinutes(min){ const h=Math.floor(min/60); const m=min%60; if(h<=0) return `${m} åˆ†`; if(m===0) return `${h} å°æ™‚`; return `${h} å°æ™‚ ${m} åˆ†`; }
function diffMinutes(startHHMM,endHHMM){ const [sh,sm]=startHHMM.split(':').map(Number); const [eh,em]=endHHMM.split(':').map(Number); let start=sh*60+sm; let end=eh*60+em; if(end<start) end+=24*60; return end-start; }

/*
  Fallback stubs for external libraries
  ------------------------------------
  When this site is opened without an internet connection, the external
  scripts for Chart.js and Markmap may fail to load, leaving the
  constructors undefined. Accessing an undefined `Chart` or
  `markmap` will throw errors and prevent the rest of the application
  from running, resulting in an empty interface. To guard against this,
  we define lightweight stubs when these globals are missing. The stubs
  implement the minimal API used by this app (returning objects with
  noâ€‘op methods) so that chart and mind map rendering calls do not
  throw. When the real libraries are available, these stubs are
  automatically ignored.
*/
if(typeof window.Chart === 'undefined'){
  window.Chart = function(){
    return {
      destroy(){},
      update(){},
      // ensure charts can be referenced safely
      data:{},
      options:{}
    };
  };
}
if(typeof window.markmap === 'undefined'){
  window.markmap = {
    Transformer: function(){
      return {
        transform(){ return { root: {} }; }
      };
    },
    Markmap: {
      create(){ return {}; }
    }
  };
}
function sum(arr){ return arr.reduce((a,b)=>a+b,0); }
function groupBy(arr,keyFn){ return arr.reduce((acc,x)=>{ const k=keyFn(x); (acc[k] ||= []).push(x); return acc; },{}); }
function escapeHtml(str){ return String(str).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'",'&#39;'); }

/* =========================
   Visited tracking (per day)
   Store which categories the user has opened today to highlight others on the home page.
========================= */
let visitedDate = {};
function loadVisitedDate(){
  try{
    const raw = localStorage.getItem('visitedDate');
    visitedDate = raw ? JSON.parse(raw) : {};
  }catch(e){ visitedDate = {}; }
}
function saveVisitedDate(){
  try{
    localStorage.setItem('visitedDate', JSON.stringify(visitedDate));
  }catch(e){}
}
function updateVisited(view){
  // record that the given view has been visited today
  const today = toISODate(new Date());
  visitedDate[view] = today;
  saveVisitedDate();
}

/* =========================
   Update tracking (per category)
   Determine whether a category has been updated (i.e. a record created) today.
   Used to decide whether to apply the glow highlight on the home page buttons.
========================= */
function hasUpdatesToday(view){
  const today = toISODate(new Date());
  try{
    if(view === 'fitness'){
      return (state.workouts || []).some(w => w.date === today);
    }
    if(view === 'diary'){
      return (state.diaries || []).some(d => {
        const dt = new Date(d.time);
        return !Number.isNaN(dt.getTime()) && dt.toISOString().slice(0,10) === today;
      });
    }
    if(view === 'learning'){
      return (state.learnings || []).some(l => l.date === today);
    }
    if(view === 'finance'){
      return (state.transactions || []).some(t => t.date === today);
    }
    if(view === 'overview'){
      // Overview is considered updated only if all categories have updates
      return hasUpdatesToday('fitness') && hasUpdatesToday('diary') && hasUpdatesToday('learning') && hasUpdatesToday('finance');
    }
  }catch(e){ /* ignore */ }
  return false;
}

/* =========================
   Navigation & Top Controls
========================= */
const nav = document.getElementById('nav');
nav.addEventListener('click', (e)=>{
  const btn = e.target.closest('button[data-view]');
  if(!btn) return;
  const view = btn.dataset.view;
  // record visited state (excluding home which has no nav button)
  updateVisited(view);
  // set active nav button
  document.querySelectorAll('.nav button').forEach(b=> b.classList.toggle('active', b===btn));
  // hide all views including home
  document.querySelectorAll('.view').forEach(v=> v.style.display='none');
  // show selected view
  const viewEl = document.getElementById('view-'+view);
  if(viewEl) viewEl.style.display='block';
  // update page
  renderAll();
});

document.getElementById('btnExport').addEventListener('click', ()=>{
  const blob = new Blob([JSON.stringify(state,null,2)], {type:'application/json'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `personal_log_mobile_backup_${toISODate(new Date())}.json`;
  a.click();
  URL.revokeObjectURL(a.href);
});

document.getElementById('importFile').addEventListener('change', async (e)=>{
  const f = e.target.files?.[0];
  if(!f) return;
  try{
    const text = await f.text();
    const imported = JSON.parse(text);
    state = Object.assign(defaultState(), imported);
    saveStateLocal();
    renderAll();
    alert('åŒ¯å…¥å®Œæˆ');
  }catch(err){ alert('åŒ¯å…¥å¤±æ•—ï¼šæª”æ¡ˆæ ¼å¼ä¸æ­£ç¢º'); }
  finally{ e.target.value=''; }
});

document.getElementById('btnReset').addEventListener('click', ()=>{
  if(!confirm('ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰è³‡æ–™ï¼Ÿæ­¤æ“ä½œä¸å¯é‚„åŸã€‚')) return;
  state = defaultState();
  saveStateLocal();
  renderAll();
});

// =========================
//   Export Image Feature
// =========================
document.getElementById('btnExportImage').addEventListener('click', ()=>{
  // Show modal and reset selections
  const modal = document.getElementById('exportImageModal');
  modal.style.display = 'flex';
  document.getElementById('export_all').checked = false;
  modal.querySelectorAll('.export-cat').forEach(ch => ch.checked = false);
});
// "Select All" checkbox toggles all categories
document.getElementById('export_all').addEventListener('change', (e)=>{
  const checked = e.target.checked;
  document.querySelectorAll('#exportImageModal .export-cat').forEach(ch => ch.checked = checked);
});
// Cancel export: hide modal
document.getElementById('exportImageCancel').addEventListener('click', ()=>{
  document.getElementById('exportImageModal').style.display = 'none';
});
// Confirm export: gather selected categories and export images
document.getElementById('exportImageConfirm').addEventListener('click', ()=>{
  const cats = [];
  document.querySelectorAll('#exportImageModal .export-cat:checked').forEach(ch => cats.push(ch.value));
  document.getElementById('exportImageModal').style.display = 'none';
  if(cats.length === 0){ alert('è«‹è‡³å°‘é¸æ“‡ä¸€å€‹åˆ†é¡'); return; }
  exportSelectedImages(cats);
});

function downloadURI(uri, name){
  const a = document.createElement('a');
  a.href = uri;
  a.download = name;
  a.click();
}
async function exportSelectedImages(cats){
  const date = toISODate(new Date());
  const tasks = [];
  // Export fitness chart as is
  if(cats.includes('fitness') && fitnessLineChart){
    try{
      const uri = fitnessLineChart.toBase64Image();
      downloadURI(uri, `fitness_chart_${date}.png`);
    }catch(err){ console.warn(err); }
  }
  // Export finance charts with details
  if(cats.includes('finance')){
    if(expensePie){ tasks.push(exportPieWithDetails('expense', `finance_expense_pie_${date}.png`)); }
    if(incomePie){ tasks.push(exportPieWithDetails('income', `finance_income_pie_${date}.png`)); }
  }
  // Wait for all async exports
  if(tasks.length){ await Promise.all(tasks); }
  // Notify for categories without charts
  const noChart = cats.filter(c => c === 'diary' || c === 'learning');
  if(noChart.length > 0){
    alert('æ‰€é¸åˆ†é¡ï¼ˆ' + noChart.join('ã€') + 'ï¼‰ç›®å‰æ²’æœ‰åœ–è¡¨å¯ä»¥åŒ¯å‡ºã€‚');
  }
}

// Helper: export pie chart with its details appended on the right.
function exportPieWithDetails(type, filename){
  return new Promise((resolve)=>{
    let chart = null;
    if(type === 'expense'){ chart = expensePie; }
    else if(type === 'income'){ chart = incomePie; }
    if(!chart){ resolve(); return; }
    const canvas = chart.canvas; // Chart.js instance exposes the underlying canvas
    const cw = canvas.width;
    const ch = canvas.height;
    // Compute details for this type from current state
    const items = state.transactions.filter(t => t.type === type);
    const byCat = groupBy(items, t => t.category);
    const labels = Object.keys(byCat).sort((a,b)=> a.localeCompare(b, 'zh-Hant'));
    const data = labels.map(l => sum(byCat[l].map(x => x.amount)));
    const total = data.reduce((a,b)=> a+b, 0) || 1;
    const detailLines = labels.map((lbl,i) => {
      const val = data[i];
      const perc = ((val/total)*100).toFixed(1);
      return `${lbl}: ${val} (${perc}%)`;
    });
    // Prepare new canvas: left half for chart, right half for details (50/50 split)
    const newCanvas = document.createElement('canvas');
    newCanvas.width = cw * 2;
    newCanvas.height = ch;
    const ctx = newCanvas.getContext('2d');
    // Fill background with white to avoid transparent background
    ctx.fillStyle = '#ffffff';
    ctx.fillRect(0, 0, newCanvas.width, newCanvas.height);
    const img = new Image();
    img.onload = function(){
      // Draw original chart in left half
      ctx.drawImage(img, 0, 0, cw, ch);
      // Draw details text occupying right half
      ctx.font = 'bold 20px sans-serif';
      ctx.fillStyle = '#000000';
      // Start drawing a bit lower to account for larger font
      let y = 50;
      const startX = cw + 20;
      const lineHeight = 34;
      detailLines.forEach(line => {
        ctx.fillText(line, startX, y);
        y += lineHeight;
      });
      const uri = newCanvas.toDataURL('image/png');
      downloadURI(uri, filename);
      resolve();
    };
    // Use Chart.js API to get image; fallback to canvas.toDataURL
    try{
      img.src = chart.toBase64Image();
    }catch(err){
      img.src = canvas.toDataURL('image/png');
    }
  });
}

/* =========================
   Recommendations
   This section generates simple nextâ€‘step suggestions for each category
   based on the user's existing data. Suggestions are categorised by
   timeframe (day/week/month) and can be collapsed to save space.
========================= */
let recCollapsed = {};
function loadRecCollapsed(){
  try{
    const raw = localStorage.getItem('recCollapsed');
    recCollapsed = raw ? JSON.parse(raw) : {};
  }catch(e){ recCollapsed = {}; }
}
function saveRecCollapsed(){
  localStorage.setItem('recCollapsed', JSON.stringify(recCollapsed));
}
function getRecommendations(view){
  const rec = { day:'', week:'', month:'' };
  if(view === 'fitness'){
    const items = state.workouts || [];
    if(items.length === 0){
      rec.day = 'é–‹å§‹è¨˜éŒ„ä½ çš„ç¬¬ä¸€ç­†å¥èº«è¨“ç·´å§ã€‚';
      rec.week = 'è¨ˆåŠƒæ¯é€±è‡³å°‘ 2â€“3 æ¬¡è¨“ç·´ï¼Œä¸¦è¨˜éŒ„æ¯æ¬¡æˆæœã€‚';
      rec.month = 'ç‚ºä¸‹å€‹æœˆè¨­å®šè¨“ç·´ç›®æ¨™ï¼Œä¾‹å¦‚å®Œæˆ 10 æ¬¡è¨“ç·´æˆ–æé«˜é‡é‡ã€‚';
    }else{
      const last = items[0];
      const lastWeight = last.weight || 0;
      rec.day = `æœ€è¿‘è¨“ç·´é‡é‡ç‚º ${lastWeight} kgï¼Œè«‹æ³¨æ„å§¿å‹¢ä¸¦é©åº¦å¢åŠ æˆ–ç¶­æŒå¼·åº¦ã€‚`;
      const now = new Date();
      const weekAgo = new Date();
      weekAgo.setDate(now.getDate() - 7);
      const countWeek = items.filter(w => new Date(w.date) >= weekAgo).length;
      const targetWeek = Math.max(3, countWeek);
      rec.week = `éå»ä¸€é€±ä½ è¨˜éŒ„äº† ${countWeek} æ¬¡è¨“ç·´ã€‚æœ¬é€±å»ºè­°å®‰æ’ç´„ ${targetWeek} æ¬¡ï¼ŒæŒçºŒé¤Šæˆç¿’æ…£ã€‚`;
      rec.month = 'æŒçºŒæ¯æœˆè¨“ç·´ä¸¦å˜—è©¦æŒ‘æˆ°æ–°çš„é‡é‡æˆ–å‹•ä½œï¼Œæ³¨æ„å¾ªåºæ¼¸é€²é¿å…å—å‚·ã€‚';
    }
  }else if(view === 'diary'){
    const items = state.diaries || [];
    if(items.length === 0){
      rec.day = 'å¯«ä¸‹ä»Šå¤©çš„å¿ƒæƒ…æˆ–å€¼å¾—æ„Ÿæ¿€çš„äº‹æƒ…ï¼Œé–‹å§‹ä½ çš„æ—¥è¨˜æ—…ç¨‹ã€‚';
      rec.week = 'æœ¬é€±è©¦è‘—æ¯å¤©è¨˜éŒ„å¿ƒæƒ…ï¼Œè§€å¯Ÿæƒ…ç·’çš„èµ·ä¼èˆ‡è§¸ç™¼å› ç´ ã€‚';
      rec.month = 'æ¯æœˆå›é¡§æ—¥è¨˜ä¸¦ç¸½çµè‡ªå·±çš„æ„Ÿå—èˆ‡æˆé•·ï¼Œä½œç‚ºåæ€ç´ æã€‚';
    }else{
      rec.day = 'ä»Šå¤©ä¹Ÿåˆ¥å¿˜äº†è¨˜éŒ„å¿ƒæƒ…å’Œç¶“æ­·ï¼Œä¿æŒå¯«æ—¥è¨˜çš„ç¿’æ…£ã€‚';
      rec.week = 'å›é¡§æœ¬é€±çš„æ—¥è¨˜ï¼Œæ‰¾å‡ºè®“ä½ é–‹å¿ƒæˆ–å£“åŠ›çš„ä¾†æºä¸¦èª¿æ•´ç”Ÿæ´»ã€‚';
      rec.month = 'æ•´ç†éå»ä¸€å€‹æœˆçš„æ—¥è¨˜ï¼Œç¸½çµå­¸åˆ°çš„ç¶“é©—ï¼Œèª¿æ•´ä¸‹å€‹æœˆçš„ç›®æ¨™ã€‚';
    }
  }else if(view === 'learning'){
    const items = state.learnings || [];
    if(items.length === 0){
      rec.day = 'æŒ‘é¸ä¸€å€‹æƒ³å­¸çš„ä¸»é¡Œï¼Œè¨˜éŒ„ç¬¬ä¸€ç­†å­¸ç¿’å…§å®¹ã€‚';
      rec.week = 'è¨­å®šæœ¬é€±çš„å­¸ç¿’è¨ˆç•«ï¼Œå®‰æ’å›ºå®šçš„å­¸ç¿’æ™‚é–“ä¸¦è¨˜éŒ„é‡é»ã€‚';
      rec.month = 'ä¸‹å€‹æœˆæŒ‘æˆ°æ–°çš„ä¸»é¡Œæˆ–æ›´æ·±å…¥çš„å…§å®¹ï¼Œä¸¦æ›´æ–°å¿ƒæ™ºåœ–ã€‚';
    }else{
      const last = items[0];
      rec.day = `è¤‡ç¿’æœ€è¿‘å­¸ç¿’çš„ã€Œ${last.title}ã€ï¼Œè©¦è‘—ç”¨è‡ªå·±çš„è©±æ•´ç†é‡é»ã€‚`;
      rec.week = 'æœ¬é€±ç‚ºç›®å‰çš„ç§‘ç›®å®‰æ’å­¸ç¿’è¨ˆç•«ï¼Œä¿æŒæ¯é€±è‡³å°‘å¹¾æ¬¡çš„ç·´ç¿’æˆ–é–±è®€ã€‚';
      rec.month = 'æ¯æœˆæ›´æ–°å¿ƒæ™ºåœ–ï¼Œæ¢³ç†å·²å­¸å…§å®¹ï¼Œè¦åŠƒä¸‹ä¸€æ­¥å­¸ç¿’è·¯å¾‘ã€‚';
    }
  }else if(view === 'finance'){
    const items = state.transactions || [];
    if(items.length === 0){
      rec.day = 'è¨˜éŒ„ç¬¬ä¸€ç­†æ”¶æ”¯ï¼Œé–‹å§‹æŒæ¡è‡ªå·±çš„è²¡å‹™æƒ…æ³ã€‚';
      rec.week = 'åˆ¶å®šæœ¬é€±çš„é ç®—ï¼Œä¸¦è¨˜éŒ„æ¯ä¸€ç­†èŠ±è²»ä»¥ä¾¿æª¢è¦–ã€‚';
      rec.month = 'è¨­å®šæœ¬æœˆå„²è“„ç›®æ¨™ä¸¦æª¢è¦–ä¸»è¦æ”¯å‡ºåˆ†é¡ï¼Œèª¿æ•´æ¶ˆè²»ç¿’æ…£ã€‚';
    }else{
      // find largest expense category for nextâ€‘day suggestion
      const expenses = items.filter(t => t.type === 'expense');
      let biggestCat = '';
      if(expenses.length > 0){
        const byCat = groupBy(expenses, t => t.category);
        let maxVal = 0;
        for(const cat in byCat){
          const sumVal = byCat[cat].reduce((a,b)=> a + b.amount, 0);
          if(sumVal > maxVal){ maxVal = sumVal; biggestCat = cat; }
        }
      }
      rec.day = biggestCat ? `æ³¨æ„æ§åˆ¶ã€Œ${biggestCat}ã€é¡å‹çš„æ”¯å‡ºï¼Œä»Šå¤©å¯ä»¥è©¦è‘—æ¸›å°‘ä¸å¿…è¦é–‹éŠ·ã€‚` : 'ä»Šå¤©è¨˜éŒ„ä½ çš„èŠ±è²»ï¼Œå¯©è¦–å¿…è¦èˆ‡éå¿…è¦æ”¯å‡ºã€‚';
      // compute weekly total expenses
      const now = new Date();
      const weekAgo = new Date(); weekAgo.setDate(now.getDate() - 7);
      const weekExpenses = expenses.filter(t => new Date(t.date) >= weekAgo);
      const weekTotal = weekExpenses.reduce((a,b)=> a + b.amount, 0);
      rec.week = `éå»ä¸€é€±ä¸»è¦æ”¯å‡ºç¸½é¡ç‚º ${weekTotal}ã€‚å»ºè­°è¨­å®šæ¯é€±æ”¯å‡ºä¸Šé™ï¼Œæª¢è¦–æœ€å¤§çš„èŠ±è²»åˆ†é¡ã€‚`;
      const totalExpense = expenses.reduce((a,b)=> a + b.amount, 0);
      rec.month = `æœ¬æœˆæ”¯å‡ºç´¯è¨ˆ ${totalExpense}ã€‚è€ƒæ…®è¨­ç«‹å„²è“„ç›®æ¨™ï¼Œä¸¦æ€è€ƒä¸‹æœˆå¦‚ä½•å„ªåŒ–é ç®—çµæ§‹ã€‚`;
    }
  } else if(view === 'overview'){
    /*
      For the overview page, we generate highâ€‘level suggestions that reflect
      the interplay between the four categories. We compute some basic
      metrics from the data and craft recommendations accordingly. The
      suggestions are separated by timeframe (day/week/month). Because this
      is a clientâ€‘side app, we rely on simple heuristics rather than
      machine learning: counts of recent workouts, mood distributions,
      learning frequency and net finance balance are used to derive advice.
    */
    // Helper to compute the number of workouts in the past 7 days
    const now = new Date();
    const weekAgo = new Date(); weekAgo.setDate(now.getDate() - 7);
    const workoutsWeek = (state.workouts || []).filter(w => new Date(w.date) >= weekAgo).length;
    // Compute mood distribution in the past 7 days
    const diaryWeek = (state.diaries || []).filter(d => new Date(d.time) >= weekAgo);
    const moodCounts = {};
    diaryWeek.forEach(d => { moodCounts[d.mood] = (moodCounts[d.mood] || 0) + 1; });
    const totalDiaryWeek = diaryWeek.length || 1;
    // Determine negative mood ratio
    const negativeMoods = ['ç„¦æ…®','ä½è½','æ†¤æ€’','ç–²å€¦','å…¶ä»–'];
    let negativeCount = 0;
    negativeMoods.forEach(m => { negativeCount += (moodCounts[m] || 0); });
    const negRatio = negativeCount / totalDiaryWeek;
    // Compute learning frequency in the past 7 days
    const learnWeek = (state.learnings || []).filter(l => new Date(l.date) >= weekAgo).length;
    // Compute finance balance for the past 30 days
    const monthAgo = new Date(); monthAgo.setDate(now.getDate() - 30);
    let incomeMonth = 0, expenseMonth = 0;
    (state.transactions || []).forEach(t => {
      const dt = new Date(t.date);
      if(dt >= monthAgo){
        if(t.type === 'income') incomeMonth += t.amount;
        else if(t.type === 'expense') expenseMonth += t.amount;
      }
    });
    const netMonth = incomeMonth - expenseMonth;
    // Build suggestions reflecting interplay between categories
    // Day: encourage small actions today based on current metrics.  When multiple
    // categories lag, suggest howä¸€ improvements in one mayå½±éŸ¿ others.
    const dayParts = [];
    if(workoutsWeek < 2) {
      dayParts.push('å®‰æ’ä¸€æ¬¡ç°¡çŸ­çš„é‹å‹•ï¼Œæœ‰åŠ©æ–¼æå‡å¿ƒæƒ…ä¸¦ç¶­æŒé«”èƒ½');
      if(negRatio > 0.5) dayParts.push('å¤šé‹å‹•æœ‰åŠ©æ–¼æ¸›è¼•è² é¢æƒ…ç·’');
    }
    if(negRatio > 0.5 && workoutsWeek >= 2) dayParts.push('å¯«ä¸‹ä»Šå¤©çš„æ„Ÿå—ï¼Œä¸¦é€éé‹å‹•æˆ–é–±è®€ä¾†ç´“å£“');
    if(learnWeek < 1) {
      dayParts.push('æŠ½ç©ºé–±è®€æˆ–è¨˜éŒ„ä¸€å‰‡æ–°çŸ¥è­˜');
      if(netMonth < 0) dayParts.push('å¢å¼·æŠ€èƒ½å°‡æœ‰åŠ©æ–¼æ”¹å–„è²¡å‹™');
    }
    if(netMonth < 0 && learnWeek >= 1) dayParts.push('ä»Šå¤©ç›¡é‡é¿å…ä¸å¿…è¦çš„é–‹éŠ·');
    rec.day = dayParts.length ? dayParts.join('ï¼›') + 'ã€‚' : 'æ­å–œï¼ä»Šæ—¥å„é …è¨˜éŒ„å‡è¡¡ï¼Œä¿æŒè‰¯å¥½ç¿’æ…£ã€‚';
    // Week: summarise and reflect patterns from the past week and highlight crossâ€‘category influences
    const weekParts = [];
    weekParts.push(`éå»ä¸€é€±å…±è¨˜éŒ„è¨“ç·´ ${workoutsWeek} æ¬¡`);
    weekParts.push(`è¨˜éŒ„æ—¥è¨˜ ${diaryWeek.length} å‰‡ï¼Œå…¶ä¸­æƒ…ç·’åè² é¢æ¯”ä¾‹ç‚º ${(negRatio*100).toFixed(0)}%`);
    weekParts.push(`å­¸ç¿’ç´€éŒ„ ${learnWeek} ç­†`);
    weekParts.push(`æœ¬æœˆæ”¶æ”¯å·®é¡ ${netMonth}`);
    // Crossâ€‘category reflections
    if(workoutsWeek < 2 && negRatio > 0.5) weekParts.push('é‹å‹•ä¸è¶³èˆ‡è² é¢æƒ…ç·’å¯èƒ½äº’æœ‰å½±éŸ¿ï¼Œå»ºè­°æœ¬é€±å¢åŠ æ´»å‹•é‡');
    if(learnWeek < 1 && netMonth < 0) weekParts.push('å­¸ç¿’æŠ•å…¥åä½èˆ‡è²¡å‹™å£“åŠ›å¯èƒ½ç›¸é—œï¼Œå»ºè­°æª¢è¦–æŠ€èƒ½æŠ•è³‡');
    if(netMonth < 0 && negRatio > 0.5) weekParts.push('è²¡å‹™å£“åŠ›å¯èƒ½å½±éŸ¿æƒ…ç·’ï¼Œå¯å˜—è©¦åˆ¶å®šé ç®—ä¸¦å°‹æ±‚æ¸›å£“æ–¹æ³•');
    weekParts.push('å»ºè­°æœ¬é€±å›é¡§ä»¥ä¸Šæ•¸æ“šï¼Œæ‰¾å‡ºéœ€è¦èª¿æ•´çš„é ˜åŸŸ');
    rec.week = weekParts.join('ï¼›') + 'ã€‚';
    // Month: set longerâ€‘term adjustments and goals focusing on balance across categories
    const monthParts = [];
    monthParts.push('ç¶œåˆå¥èº«ã€æ—¥è¨˜ã€å­¸ç¿’ã€æ”¶æ”¯è³‡æ–™ï¼Œè©•ä¼°å„é …æ˜¯å¦å¹³è¡¡');
    if(workoutsWeek < 2) monthParts.push('ä¸‹æœˆå¯è¨­å®šæ¯é€±è‡³å°‘ 2 æ¬¡è¨“ç·´ç›®æ¨™');
    if(negRatio > 0.5) monthParts.push('æŒçºŒæ¢ç´¢æ­£å‘ç´“å£“æ–¹å¼ï¼Œå¦‚é‹å‹•ã€é–±è®€æˆ–å†¥æƒ³');
    if(learnWeek < 2) monthParts.push('è¦åŠƒä¸€å€‹æ–°çš„å­¸ç¿’ä¸»é¡Œæˆ–æŠ€èƒ½ï¼Œæå‡è‡ªæˆ‘åƒ¹å€¼');
    if(netMonth < 0) monthParts.push('æª¢è¨é ç®—ä¸¦è¨‚å®šå„²è“„ç›®æ¨™ï¼Œä»¥æ¸›å°‘è²¡å‹™å£“åŠ›');
    // Additional crossâ€‘category goals
    if(workoutsWeek < 2 && learnWeek < 2) monthParts.push('å˜—è©¦å°‡å¥èº«èˆ‡å­¸ç¿’çµåˆï¼Œä¾‹å¦‚æ”¶è½å¥èº«æˆ–ç†è²¡ç›¸é—œçš„æ•™æ');
    rec.month = monthParts.join('ï¼›') + 'ã€‚';
  }
  return rec;
}
function renderRecommendations(view){
  const root = document.getElementById('view-' + view);
  if(!root) return;
  // remove existing recommendations for this view
  const old = root.querySelector('.recommendations');
  if(old) old.remove();
  const recs = getRecommendations(view);
  const collapsed = recCollapsed[view] === true;
  // Build container
  const container = document.createElement('div');
  container.className = 'recommendations' + (collapsed ? ' collapsed' : '');
  container.setAttribute('data-view', view);
  const arrowChar = collapsed ? 'â–¶' : 'â–¼';
  container.innerHTML = `\
    <button class="rec-toggle">${arrowChar} è¡Œå‹•å»ºè­°</button>\
    <div class="rec-content">\
      <p><strong>1å¤©ï¼š</strong>${escapeHtml(recs.day)}</p>\
      <p><strong>1é€±ï¼š</strong>${escapeHtml(recs.week)}</p>\
      <p><strong>1å€‹æœˆï¼š</strong>${escapeHtml(recs.month)}</p>\
      <p class="disclaimer">ä»¥ä¸Šå»ºè­°ç”±ç³»çµ±ä¾æ“šè¨˜éŒ„è‡ªå‹•ç”¢ç”Ÿï¼Œåƒ…ä¾›åƒè€ƒã€‚</p>\
    </div>`;
  // Toggle collapse on click
  container.querySelector('.rec-toggle').addEventListener('click', ()=>{
    const isCollapsed = !container.classList.contains('collapsed');
    container.classList.toggle('collapsed', isCollapsed);
    const newArrow = isCollapsed ? 'â–¶' : 'â–¼';
    container.querySelector('.rec-toggle').textContent = `${newArrow} è¡Œå‹•å»ºè­°`;
    recCollapsed[view] = isCollapsed;
    saveRecCollapsed();
  });
  root.appendChild(container);
}

/* =========================
   Collapsible Card Utility
   This helper rewrites each .card inside the given view to support
   collapsible headers. Cards that already contain a .card-header are
   skipped. The arrow rotates based on the collapsed state. Toggling
   simply adds or removes the 'collapsed' class on the card element.
========================= */
function applyCardCollapse(view){
  const root = document.getElementById('view-' + view);
  if(!root) return;
  const cards = root.querySelectorAll('.card');
  cards.forEach(card => {
    // Skip if already transformed
    if(card.querySelector('.card-header')) return;
    const titleEl = card.querySelector('h3');
    if(!titleEl) return;
    // Create header and arrow
    const header = document.createElement('div');
    header.className = 'card-header';
    const arrow = document.createElement('span');
    arrow.className = 'card-arrow';
    arrow.textContent = 'â–¼';
    // Move title element into header
    header.appendChild(titleEl);
    header.appendChild(arrow);
    // Create body and move remaining child nodes
    const body = document.createElement('div');
    body.className = 'card-body';
    while(card.firstChild){
      const node = card.firstChild;
      if(node !== header){
        body.appendChild(node);
      } else {
        break;
      }
    }
    // Empty original card and append header and body
    card.innerHTML = '';
    card.appendChild(header);
    card.appendChild(body);
    // Click toggle
    header.addEventListener('click', () => {
      const collapsed = card.classList.toggle('collapsed');
      arrow.textContent = collapsed ? 'â–¶' : 'â–¼';
    });
  });
}

/* =========================
   Home Page Rendering
   The landing page presents a friendly prompt and category buttons. Categories
   not visited today receive a glowing highlight. Clicking a button opens the
   corresponding view and records the visit.
========================= */
function renderHome(){
  const root = document.getElementById('view-home');
  if(!root) return;
  // Determine today's date for highlighting
  const today = toISODate(new Date());
  // Build HTML
  const cats = [
    {view:'fitness', icon:'ğŸ‹ï¸', label:'å¥èº«'},
    {view:'diary', icon:'ğŸ““', label:'æ—¥è¨˜'},
    {view:'learning', icon:'ğŸ“š', label:'å­¸ç¿’'},
    {view:'finance', icon:'ğŸ’°', label:'æ”¶æ”¯'},
    {view:'overview', icon:'ğŸŒŸ', label:'ç¸½è¦½'}
  ];
  let html = '<div class="home-page">';
  html += '<h1>Personal Log</h1>';
  html += '<p>ä½ ä»Šå¤©æƒ³åšäº›ä»€éº¼ï¼Ÿ</p>';
  html += '<div class="home-cats">';
  cats.forEach(cat => {
    // Determine highlight based on whether the category has been updated today
    const updated = hasUpdatesToday(cat.view);
    // If not updated today, apply glow highlight to prompt the user to add data
    const glowClass = updated ? '' : ' glow';
    html += `<div class="home-cat${glowClass}" data-view="${cat.view}">${cat.icon} ${cat.label}</div>`;
  });
  html += '</div></div>';
  root.innerHTML = html;
  // Attach click handlers to category buttons
  root.querySelectorAll('.home-cat').forEach(btn => {
    btn.addEventListener('click', () => {
      const view = btn.getAttribute('data-view');
      // update visited record and save
      updateVisited(view);
      // activate nav button if present
      const navBtn = document.querySelector(`.nav button[data-view="${view}"]`);
      document.querySelectorAll('.nav button').forEach(b => b.classList.toggle('active', b === navBtn));
      // hide all views
      document.querySelectorAll('.view').forEach(v => v.style.display='none');
      // show selected view
      const viewEl = document.getElementById('view-' + view);
      if(viewEl) viewEl.style.display = 'block';
      // render content and collapse cards if needed
      renderAll();
    });
  });
}

/* =========================
   Overview (äººç”Ÿç¸½è¦½) Page
   Combines data from all sections to show an overall picture. Displays
   bar charts for record counts and finance totals, and summarises
   recommendations across categories.
========================= */
let overviewCountChart = null;
let overviewFinanceChart = null;
function overviewTemplate(){
  return `\
    <div class="header">\
      <div class="title">\
        <h2>ğŸŒŸ äººç”Ÿç¸½è¦½</h2>\
        <p>æ•´åˆå¥èº«ã€æ—¥è¨˜ã€å­¸ç¿’ã€æ”¶æ”¯ï¼Œæ´å¯Ÿå½¼æ­¤çš„å½±éŸ¿</p>\
      </div>\
      <span class="pill overview">Overview</span>\
    </div>\
    <div class="card">\
      <h3>ç´€éŒ„æ•¸é‡æ¦‚è¦½</h3>\
      <canvas id="overview_count_chart" style="width:100%;height:240px;"></canvas>\
    </div>\
    <div class="card">\
      <h3>æ”¶æ”¯ç¸½é¡ï¼ˆæ”¶å…¥ vs æ”¯å‡ºï¼‰</h3>\
      <canvas id="overview_finance_chart" style="width:100%;height:240px;"></canvas>\
    </div>\
    <div class="card">\
      <h3>å¿ƒæƒ…åˆ†å¸ƒï¼ˆéå»7å¤©ï¼‰</h3>\
      <canvas id="overview_mood_chart" style="width:100%;height:240px;"></canvas>\
    </div>\
    <div class="card">\
      <h3>è·¨åˆ†é¡è¡Œå‹•å»ºè­°</h3>\
      <div class="overview-recs">\
        <p><strong>1å¤©ï¼š</strong><span id="overview_rec_day"></span></p>\
        <p><strong>1é€±ï¼š</strong><span id="overview_rec_week"></span></p>\
        <p><strong>1å€‹æœˆï¼š</strong><span id="overview_rec_month"></span></p>\
        <p class="disclaimer">ä»¥ä¸Šå»ºè­°ç”±ç³»çµ±æ•´åˆå„é¡åˆ¥å»ºè­°è‡ªå‹•ç”¢ç”Ÿï¼Œåƒ…ä¾›åƒè€ƒã€‚</p>\
      </div>\
    </div>`;
}
function renderOverview(){
  const root = document.getElementById('view-overview');
  if(!root) return;
  // Inject template
  root.innerHTML = overviewTemplate();
  // Compute counts per category
  const counts = {
    å¥èº«: state.workouts.length,
    æ—¥è¨˜: state.diaries.length,
    å­¸ç¿’: state.learnings.length,
    æ”¶æ”¯: state.transactions.length
  };
  // Destroy previous charts if exist
  if(overviewCountChart){ overviewCountChart.destroy(); overviewCountChart = null; }
  if(overviewFinanceChart){ overviewFinanceChart.destroy(); overviewFinanceChart = null; }
  // Draw counts bar chart
  const ctx1 = document.getElementById('overview_count_chart').getContext('2d');
  overviewCountChart = new Chart(ctx1, {
    type:'bar',
    data:{
      labels:Object.keys(counts),
      datasets:[{ label:'ç´€éŒ„æ•¸é‡', data:Object.values(counts) }]
    },
    options:{
      plugins:{ legend:{ display:false }, tooltip:{ callbacks:{ label: ctx => ` ${ctx.parsed.y}` } } },
      scales:{ y:{ beginAtZero:true, precision:0 } }
    }
  });
  // Compute finance totals
  const incomes = state.transactions.filter(t => t.type==='income').reduce((sum,t) => sum + t.amount, 0);
  const expenses = state.transactions.filter(t => t.type==='expense').reduce((sum,t) => sum + t.amount, 0);
  const ctx2 = document.getElementById('overview_finance_chart').getContext('2d');
  overviewFinanceChart = new Chart(ctx2, {
    type:'bar',
    data:{ labels:['æ”¶å…¥','æ”¯å‡º'], datasets:[{ label:'é‡‘é¡', data:[incomes, expenses] }] },
    options:{ plugins:{ legend:{ display:false }, tooltip:{ callbacks:{ label: ctx => ` ${ctx.parsed.y}` } } }, scales:{ y:{ beginAtZero:true } } }
  });

  // Draw mood distribution chart: counts of moods in the past 7 days
  const moodCtx = document.getElementById('overview_mood_chart').getContext('2d');
  // Gather diary entries in past 7 days
  const now = new Date();
  const weekAgo2 = new Date(); weekAgo2.setDate(now.getDate() - 7);
  const recentDiaries = (state.diaries || []).filter(d => new Date(d.time) >= weekAgo2);
  const moodCounts2 = {};
  recentDiaries.forEach(d => { moodCounts2[d.mood] = (moodCounts2[d.mood] || 0) + 1; });
  const moodLabels = Object.keys(moodCounts2).sort((a,b)=> a.localeCompare(b,'zh-Hant'));
  const moodData = moodLabels.map(l => moodCounts2[l]);
  // Destroy previous mood chart if exists
  if(window.overviewMoodChart){ window.overviewMoodChart.destroy(); window.overviewMoodChart = null; }
  window.overviewMoodChart = new Chart(moodCtx, {
    type:'bar',
    data:{ labels: moodLabels.length ? moodLabels : ['ï¼ˆå°šç„¡ç´€éŒ„ï¼‰'], datasets:[{ label:'æ¬¡æ•¸', data: moodLabels.length ? moodData : [1] }] },
    options:{ plugins:{ legend:{ display:false }, tooltip:{ callbacks:{ label:ctx=>` ${ctx.parsed.y}` } } }, scales:{ y:{ beginAtZero:true, precision:0 } } }
  });
  // Set recommendations
  const rec = getRecommendations('overview');
  document.getElementById('overview_rec_day').innerHTML = rec.day;
  document.getElementById('overview_rec_week').innerHTML = rec.week;
  document.getElementById('overview_rec_month').innerHTML = rec.month;
  // After rendering, apply card collapse behaviour on overview
  applyCardCollapse('overview');
}

/* =========================
   Fitness (Workout) Section
========================= */
let fitnessLineChart = null;
function fitnessTemplate(){
  return `\
    <div class="header">\
      <div class="title">\
        <h2>ğŸ‹ï¸ å¥èº«ç´€éŒ„</h2>\
        <p>è¼¸å…¥é–‹å§‹/çµæŸ/ä¼‘æ¯ï¼Œç³»çµ±è‡ªå‹•ç®—å¯¦éš›è¨“ç·´æ™‚é–“ï¼Œä¸¦ä»¥ã€Œæœˆã€ç‚ºå–®ä½æ•´ç†é‡é‡é€²æ­¥ã€‚</p>\
      </div>\
      <span class="pill fit">Workout</span>\
    </div>\
    <div class="grid">\
      <div class="card">\
        <h3>æ–°å¢è¨“ç·´</h3>\
        <div class="form">\
          <div class="row"><label>æ—¥æœŸ</label><input id="fit_date" type="date" /></div>\
          <div class="row"><label>å‹•ä½œ/é …ç›®</label><input id="fit_exercise" placeholder="ä¾‹ï¼šæ·±è¹² / å§æ¨ / ç¡¬èˆ‰" /></div>\
          <div class="row"><label>é–‹å§‹æ™‚é–“</label><input id="fit_start" type="time" /></div>\
          <div class="row"><label>çµæŸæ™‚é–“</label><input id="fit_end" type="time" /></div>\
          <div class="row"><label>ä¼‘æ¯æ™‚é–“</label><input id="fit_rest" type="number" min="0" step="1" placeholder="åˆ†é˜" /></div>\
          <div class="row"><label>é‡é‡</label><input id="fit_weight" type="number" min="0" step="0.5" placeholder="kg" /></div>\
          <div class="row"><label>å‚™è¨»</label><input id="fit_note" placeholder="å¯é¸" /></div>\
          <div class="btns">\
            <button class="btn primary" id="fit_add">æ–°å¢</button>\
            <button class="btn" id="fit_fill_now">è‡ªå‹•å¸¶å…¥ä»Šå¤©</button>\
          </div>\
          <div class="hint">\
            å¯¦éš›è¨“ç·´æ™‚é–“ = (çµæŸ-é–‹å§‹) - ä¼‘æ¯æ™‚é–“ã€‚<br/>\
            è‹¥çµæŸæ™‚é–“æ—©æ–¼é–‹å§‹æ™‚é–“ï¼Œè¦–ç‚ºè·¨æ—¥ï¼ˆä¾‹å¦‚ 23:30 åˆ° 00:30ï¼‰ã€‚\
          </div>\
        </div>\
      </div>\
      <div class="card">\
        <div class="split">\
          <div>\
            <h3>é€²æ­¥æŠ˜ç·šåœ–ï¼ˆé‡é‡ / æœˆï¼‰</h3>\
            <div class="row" style="gap:8px">\
              <label style="width:80px">é¸æ“‡å‹•ä½œ</label>\
              <select id="fit_chart_exercise"></select>\
            </div>\
            <div class="chart-wrap"><canvas id="fit_line"></canvas></div>\
          </div>\
          <div>\
            <h3>æœˆåº¦æ‘˜è¦</h3>\
            <div class="hint" style="margin-bottom:6px;">å³è¡¨é¡¯ç¤ºæ¯æœˆã€Œæœ€é«˜é‡é‡ã€èˆ‡ç›¸å°ä¸Šæœˆé€²æ­¥å¹…åº¦ï¼ˆÎ”ï¼‰ã€‚</div>\
            <table class="table" id="fit_table">\
              <thead><tr><th>æœˆä»½</th><th>é‡é‡</th><th>Î”</th></tr></thead>\
              <tbody></tbody>\
            </table>\
          </div>\
        </div>\
        <div style="margin-top:10px">\
          <h3>æœ€è¿‘ç´€éŒ„</h3>\
          <div class="list" id="fit_list"></div>\
        </div>\
      </div>\
    </div>\
  `;
}
function renderFitness(){
  const root = document.getElementById('view-fitness');
  root.innerHTML = fitnessTemplate();
  // defaults
  const today = new Date();
  document.getElementById('fit_date').value = toISODate(today);
  document.getElementById('fit_rest').value = 0;
  document.getElementById('fit_fill_now').addEventListener('click', ()=>{ document.getElementById('fit_date').value = toISODate(new Date()); });
  document.getElementById('fit_add').addEventListener('click', ()=>{
    const date = document.getElementById('fit_date').value;
    const exercise = document.getElementById('fit_exercise').value.trim();
    const start = document.getElementById('fit_start').value;
    const end = document.getElementById('fit_end').value;
    const rest = Number(document.getElementById('fit_rest').value || 0);
    const weight = Number(document.getElementById('fit_weight').value || 0);
    const note = document.getElementById('fit_note').value.trim();
    if(!date || !exercise || !start || !end){ alert('è«‹è‡³å°‘å¡«ï¼šæ—¥æœŸã€å‹•ä½œã€é–‹å§‹æ™‚é–“ã€çµæŸæ™‚é–“'); return; }
    const duration = Math.max(0, diffMinutes(start, end) - rest);
    const item = { id: uid('w'), date, exercise, start, end, restMinutes: rest, durationMinutes: duration, weight, note, createdAt: new Date().toISOString() };
    state.workouts.unshift(item);
    saveStateLocal();
    renderFitness();
  });
  // chart exercise dropdown
  const exSet = new Set(state.workouts.map(w=> w.exercise));
  const exList = Array.from(exSet).sort((a,b)=> a.localeCompare(b, 'zh-Hant'));
  const sel = document.getElementById('fit_chart_exercise');
  if(exList.length === 0){ sel.innerHTML = `<option value="">ï¼ˆå°šç„¡è³‡æ–™ï¼‰</option>`; }
  else{ sel.innerHTML = exList.map(x=> `<option value="${escapeHtml(x)}">${escapeHtml(x)}</option>`).join(''); }
  sel.addEventListener('change', ()=> drawFitnessChart(sel.value));
  drawFitnessChart(exList[0] || '');
  renderFitnessList();
  // After rendering lists, show recommendations section
  renderRecommendations('fitness');
}
function renderFitnessList(){
  const list = document.getElementById('fit_list');
  const items = state.workouts.slice(0, 12);
  list.innerHTML = items.map(w=>{
    const meta = [
      `<span class="tag"><b>${escapeHtml(w.exercise)}</b></span>`,
      `<span class="tag">${escapeHtml(w.date)}</span>`,
      `<span class="tag">${escapeHtml(w.start)}â€“${escapeHtml(w.end)}</span>`,
      `<span class="tag">ä¼‘æ¯ ${escapeHtml(String(w.restMinutes))} åˆ†</span>`,
      `<span class="tag">å¯¦éš› ${fmtMinutes(w.durationMinutes)}</span>`,
      `<span class="tag">é‡é‡ ${escapeHtml(String(w.weight))} kg</span>`
    ].join(' ');
    return `\
      <div class="item">\
        <div class="meta">${meta}</div>\
        ${w.note ? `<div class="hint">${escapeHtml(w.note)}</div>` : `<div class="hint">ï¼ˆç„¡å‚™è¨»ï¼‰</div>`}\
        <div class="btns" style="margin-top:6px"><button class="btn danger" onclick="deleteWorkout('${w.id}')">åˆªé™¤</button></div>\
      </div>\
    `;
  }).join('') || `<div class="hint">å°šç„¡å¥èº«ç´€éŒ„ã€‚</div>`;
}
function deleteWorkout(id){ state.workouts = state.workouts.filter(w=> w.id!==id); saveStateLocal(); renderAll(); }
function drawFitnessChart(exercise){
  if(fitnessLineChart){ fitnessLineChart.destroy(); fitnessLineChart = null; }
  const canvas = document.getElementById('fit_line');
  if(!exercise){ canvas.getContext('2d').clearRect(0,0,canvas.width,canvas.height); document.querySelector('#fit_table tbody').innerHTML = ''; return; }
  const filtered = state.workouts.filter(w=> w.exercise === exercise);
  const byMonth = groupBy(filtered, w=> toMonthKey(w.date));
  const months = Object.keys(byMonth).sort();
  const weights = months.map(m=>{
    const maxW = Math.max(...byMonth[m].map(x=> Number(x.weight || 0)));
    return maxW;
  });
  // build table
  const tbody = document.querySelector('#fit_table tbody');
  let prev = null;
  tbody.innerHTML = months.map((m,i)=>{
    const w = weights[i];
    const delta = (prev === null) ? '' : (w - prev);
    const deltaTxt = (prev === null) ? 'â€”' : (delta >= 0 ? `+${delta}` : `${delta}`);
    prev = w;
    return `<tr><td>${escapeHtml(m)}</td><td>${escapeHtml(String(w))} kg</td><td>${escapeHtml(deltaTxt)} kg</td></tr>`;
  }).join('');
  fitnessLineChart = new Chart(canvas, { type:'line', data:{ labels: months, datasets:[{ label:'æœˆæœ€é«˜é‡é‡ (kg)', data: weights, tension:0.25, pointRadius:3, pointHoverRadius:4, fill:false }] }, options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{ display:true }, tooltip:{ callbacks:{ label:(ctx)=>` ${ctx.parsed.y} kg` } } }, scales:{ y:{ beginAtZero:true } } } });
  canvas.parentElement.style.height = '240px';
}

/* =========================
   Diary Section
========================= */
let diaryFilter = { month:'ALL', mood:'ALL' };
function diaryTemplate(){
  return `\
    <div class="header">\
      <div class="title">\
        <h2>ğŸ““ æ—¥è¨˜</h2>\
        <p>è‡ªå‹•æŒ‰ã€Œæœˆä»½ã€èˆ‡ã€Œå¿ƒæƒ…ã€å»ºç«‹è³‡æ–™å¤¾ï¼Œæ–¹ä¾¿å›æº¯èˆ‡æŸ¥æ‰¾ã€‚</p>\
      </div>\
      <span class="pill diary">Diary</span>\
    </div>\
    <div class="grid">\
      <div class="card">\
        <h3>æ–°å¢æ—¥è¨˜</h3>\
        <div class="form">\
          <div class="row"><label>æ™‚é–“</label><input id="diary_time" type="datetime-local" /></div>\
          <div class="row"><label>å¿ƒæƒ…</label><select id="diary_mood">\
            <option value="é–‹å¿ƒ">é–‹å¿ƒ</option><option value="å¹³éœ">å¹³éœ</option><option value="ç„¦æ…®">ç„¦æ…®</option><option value="ä½è½">ä½è½</option><option value="æ†¤æ€’">æ†¤æ€’</option><option value="ç–²å€¦">ç–²å€¦</option><option value="å°ˆæ³¨">å°ˆæ³¨</option><option value="å…¶ä»–">å…¶ä»–</option>\
          </select></div>\
          <div class="row"><label>å…§å®¹</label><textarea id="diary_text" placeholder="å¯«é»ä»€éº¼â€¦"></textarea></div>\
          <div class="btns"><button class="btn primary" id="diary_add">æ–°å¢</button></div>\
        </div>\
      </div>\
      <div class="card">\
        <div class="split">\
          <div class="folder">\
            <h4>è³‡æ–™å¤¾ï¼ˆæœˆä»½ / å¿ƒæƒ…ï¼‰</h4>\
            <div class="tree" id="diary_tree"></div>\
            <div class="hint" style="margin-top:6px;">é»é¸è³‡æ–™å¤¾å³å¯å¥—ç”¨ç¯©é¸ã€‚</div>\
          </div>\
          <div>\
            <h3>æ¸…å–®</h3>\
            <div class="kpi">\
              <div class="box"><div class="t">ç›®å‰ç¯©é¸</div><div class="n" id="diary_kpi_filter">â€”</div></div>\
              <div class="box"><div class="t">ç­†æ•¸</div><div class="n" id="diary_kpi_count">0</div></div>\
              <div class="box"><div class="t">æœ€æ—©</div><div class="n" id="diary_kpi_min">â€”</div></div>\
              <div class="box"><div class="t">æœ€è¿‘</div><div class="n" id="diary_kpi_max">â€”</div></div>\
            </div>\
            <div class="btns" style="margin-top:8px"><button class="btn" id="diary_clear_filter">æ¸…é™¤ç¯©é¸</button></div>\
            <div class="list" id="diary_list" style="margin-top:8px"></div>\
          </div>\
        </div>\
      </div>\
    </div>\
  `;
}
function renderDiary(){
  const root = document.getElementById('view-diary');
  root.innerHTML = diaryTemplate();
  const now = new Date();
  const dt = `${toISODate(now)}T${pad2(now.getHours())}:${pad2(now.getMinutes())}`;
  document.getElementById('diary_time').value = dt;
  document.getElementById('diary_add').addEventListener('click', ()=>{
    const time = document.getElementById('diary_time').value;
    const mood = document.getElementById('diary_mood').value;
    const text = document.getElementById('diary_text').value.trim();
    if(!time || !text){ alert('è«‹è‡³å°‘å¡«ï¼šæ™‚é–“ã€å…§å®¹'); return; }
    state.diaries.unshift({ id: uid('d'), time: new Date(time).toISOString(), mood, text, createdAt: new Date().toISOString() });
    saveStateLocal();
    renderDiary();
  });
  document.getElementById('diary_clear_filter').addEventListener('click', ()=>{ diaryFilter = { month:'ALL', mood:'ALL' }; renderDiary(); });
  renderDiaryTree();
  renderDiaryList();
  // Show recommendations section for diary
  renderRecommendations('diary');
}
function renderDiaryTree(){
  const tree = document.getElementById('diary_tree');
  const diaries = state.diaries.slice().sort((a,b)=> new Date(b.time) - new Date(a.time));
  const byMonth = groupBy(diaries, d=> toMonthKey(d.time));
  const months = Object.keys(byMonth).sort().reverse();
  const buttons = [];
  buttons.push({ label:'å…¨éƒ¨', month:'ALL', mood:'ALL' });
  for(const m of months){
    buttons.push({ label:`ğŸ“ ${m}`, month:m, mood:'ALL' });
    const byMood = groupBy(byMonth[m], d=> d.mood);
    const moods = Object.keys(byMood).sort((a,b)=> a.localeCompare(b,'zh-Hant'));
    for(const mood of moods){
      buttons.push({ label:`â””â”€ ${mood} (${byMood[mood].length})`, month:m, mood });
    }
  }
  tree.innerHTML = buttons.map(b=>{
    const active = (diaryFilter.month===b.month && diaryFilter.mood===b.mood) ? 'active' : '';
    return `<button class="${active}" data-month="${escapeHtml(b.month)}" data-mood="${escapeHtml(b.mood)}">${escapeHtml(b.label)}</button>`;
  }).join('') || `<div class="hint">å°šç„¡æ—¥è¨˜ã€‚</div>`;
  tree.addEventListener('click', (e)=>{
    const btn = e.target.closest('button[data-month]');
    if(!btn) return;
    diaryFilter.month = btn.dataset.month;
    diaryFilter.mood = btn.dataset.mood;
    renderDiary();
  }, { once:true });
}
function renderDiaryList(){
  const list = document.getElementById('diary_list');
  let diaries = state.diaries.slice().sort((a,b)=> new Date(b.time) - new Date(a.time));
  if(diaryFilter.month !== 'ALL'){ diaries = diaries.filter(d=> toMonthKey(d.time)===diaryFilter.month); }
  if(diaryFilter.mood !== 'ALL'){ diaries = diaries.filter(d=> d.mood === diaryFilter.mood); }
  document.getElementById('diary_kpi_filter').textContent = (diaryFilter.month==='ALL' && diaryFilter.mood==='ALL') ? 'å…¨éƒ¨' : `${diaryFilter.month==='ALL' ? 'å…¨éƒ¨æœˆä»½' : diaryFilter.month} / ${diaryFilter.mood==='ALL' ? 'å…¨éƒ¨å¿ƒæƒ…' : diaryFilter.mood}`;
  document.getElementById('diary_kpi_count').textContent = String(diaries.length);
  if(diaries.length){
    const times = diaries.map(d=> new Date(d.time).getTime()).sort((a,b)=> a - b);
    document.getElementById('diary_kpi_min').textContent = new Date(times[0]).toISOString().slice(0,10);
    document.getElementById('diary_kpi_max').textContent = new Date(times[times.length-1]).toISOString().slice(0,10);
  } else {
    document.getElementById('diary_kpi_min').textContent = 'â€”';
    document.getElementById('diary_kpi_max').textContent = 'â€”';
  }
  list.innerHTML = diaries.slice(0, 30).map(d=>{
    return `\
      <div class="item">\
        <div class="meta">\
          <span class="tag"><b>${escapeHtml(d.mood)}</b></span>\
          <span class="tag">${escapeHtml(fmtDateTime(d.time))}</span>\
          <span class="tag">${escapeHtml(toMonthKey(d.time))}</span>\
        </div>\
        <div style="white-space:pre-wrap; line-height:1.4">${escapeHtml(d.text)}</div>\
        <div class="btns" style="margin-top:6px"><button class="btn danger" onclick="deleteDiary('${d.id}')">åˆªé™¤</button></div>\
      </div>\
    `;
  }).join('') || `<div class="hint">æ­¤ç¯©é¸ä¸‹æ²’æœ‰æ—¥è¨˜ã€‚</div>`;
}
function deleteDiary(id){ state.diaries = state.diaries.filter(d=> d.id!==id); saveStateLocal(); renderAll(); }

/* =========================
   Learning Section
========================= */
let learnSubjectFilter = 'ALL';
let markmapInstance = null;
function learningTemplate(){
  return `\
    <div class="header">\
      <div class="title">\
        <h2>ğŸ“š å­¸ç¿’ç´€éŒ„</h2>\
        <p>ä»¥ã€Œç§‘ç›®ã€è‡ªå‹•å»ºç«‹è³‡æ–™å¤¾ï¼›å¯ä¸€éµç”Ÿæˆå¿ƒæ™ºåœ–ï¼ˆç§‘ç›® â†’ æ¢ç›®ï¼‰ã€‚</p>\
      </div>\
      <span class="pill learn">Learning</span>\
    </div>\
    <div class="grid">\
      <!-- Card for adding a new learning entry (with collapsible header) -->\
      <div class="card">\
        <div class="card-header">\
          <h3>æ–°å¢å­¸ç¿’</h3>\
          <span class="card-arrow">â–¼</span>\
        </div>\
        <div class="card-body">\
          <div class="form">\
            <div class="row"><label>æ—¥æœŸ</label><input id="learn_date" type="date" /></div>\
            <div class="row"><label>ç§‘ç›®</label><input id="learn_subject" placeholder="ä¾‹ï¼šè‹±æ–‡ / æŠ•è³‡ / ç¨‹å¼ / å’–å•¡" /></div>\
            <div class="row"><label>æ¨™é¡Œ</label><input id="learn_title" placeholder="ä¾‹ï¼šETF å†å¹³è¡¡åŸå‰‡" /></div>\
            <div class="row"><label>å…§å®¹</label><textarea id="learn_notes" placeholder="æ‘˜è¦ã€é‡é»ã€é€£çµâ€¦"></textarea></div>\
            <div class="btns"><button class="btn primary" id="learn_add">æ–°å¢</button></div>\
          </div>\
        </div>\
      </div>\
      <!-- Card for listing and mind map with collapsible header -->\
      <div class="card">\
        <div class="card-header">\
          <h3>ç§‘ç›®æ¸…å–®èˆ‡å¿ƒæ™ºåœ–</h3>\
          <span class="card-arrow">â–¼</span>\
        </div>\
        <div class="card-body">\
          <div class="split">\
            <div class="folder">\
              <h4>ç§‘ç›®è³‡æ–™å¤¾</h4>\
              <div class="tree" id="learn_tree"></div>\
              <div class="btns" style="margin-top:8px">\
                <button class="btn" id="learn_clear_filter">æ¸…é™¤ç¯©é¸</button>\
                <button class="btn primary" id="learn_render_mindmap">ç”Ÿæˆå¿ƒæ™ºåœ–</button>\
              </div>\
              <div class="hint" style="margin-top:6px;">å¿ƒæ™ºåœ–ä»¥ã€Œç§‘ç›® â†’ æ¨™é¡Œã€çµ„ç¹”ï¼Œé©åˆåšå›é¡§ç´¢å¼•ã€‚</div>\
            </div>\
            <div>\
              <h4>æ¸…å–®</h4>\
              <div class="list" id="learn_list"></div>\
              <h4 style="margin-top:10px;">å¿ƒæ™ºåœ–</h4>\
              <div class="chart-wrap" style="height:280px; overflow:hidden;">\
                <svg id="mindmap" style="width:100%;height:100%;"></svg>\
              </div>\
            </div>\
          </div>\
        </div>\
      </div>\
      <!-- Card for uploading an image and generating a note via OCR (collapsible) -->\
      <div class="card">\
        <div class="card-header">\
          <h3>åœ–ç‰‡ç­†è¨˜</h3>\
          <span class="card-arrow">â–¼</span>\
        </div>\
        <div class="card-body">\
          <div class="form">\
            <div class="row"><label>ä¸Šå‚³åœ–ç‰‡</label><input id="learn_photo" type="file" accept="image/*" /></div>\
            <div class="hint" style="margin-top:6px;">é¸æ“‡ä¸€å¼µç…§ç‰‡å¾Œï¼Œç³»çµ±æœƒè‡ªå‹•è­˜åˆ¥å…¶ä¸­çš„æ–‡å­—ä¸¦ç”Ÿæˆç­†è¨˜æ‘˜è¦ã€‚</div>\
            <div id="learn_photo_status" class="hint" style="margin-top:4px;"></div>\
          </div>\
        </div>\
      </div>\
    </div>\
  `;
}
function renderLearning(){
  const root = document.getElementById('view-learning');
  root.innerHTML = learningTemplate();
  document.getElementById('learn_date').value = toISODate(new Date());
  document.getElementById('learn_add').addEventListener('click', ()=>{
    const date = document.getElementById('learn_date').value;
    const subject = document.getElementById('learn_subject').value.trim();
    const title = document.getElementById('learn_title').value.trim();
    const notes = document.getElementById('learn_notes').value.trim();
    if(!date || !subject || !title){ alert('è«‹è‡³å°‘å¡«ï¼šæ—¥æœŸã€ç§‘ç›®ã€æ¨™é¡Œ'); return; }
    state.learnings.unshift({ id: uid('l'), date, subject, title, notes, createdAt: new Date().toISOString() });
    saveStateLocal();
    renderLearning();
  });
  document.getElementById('learn_clear_filter').addEventListener('click', ()=>{ learnSubjectFilter = 'ALL'; renderLearning(); });
  document.getElementById('learn_render_mindmap').addEventListener('click', ()=>{ renderMindMap(); });
  renderLearningTree();
  renderLearningList();
  renderMindMap();
  // Show recommendations section for learning
  renderRecommendations('learning');

  // Apply collapsible card behaviour after rendering the learning page.
  // Use a timeout to ensure the DOM has been fully updated before transformation.
  setTimeout(() => {
    applyCardCollapse('learning');
  }, 0);

  // Handle image upload and OCR for generating a learning note
  const photoInput = document.getElementById('learn_photo');
  if(photoInput){
    photoInput.addEventListener('change', ()=>{
      const statusEl = document.getElementById('learn_photo_status');
      const file = photoInput.files && photoInput.files[0];
      if(!file){ return; }
      // Display processing status
      if(statusEl) statusEl.textContent = 'æ­£åœ¨è­˜åˆ¥ï¼Œè«‹ç¨å€™...';
      const reader = new FileReader();
      reader.onload = function(){
        const dataURL = reader.result;
        // Default to English; tesseract.js will auto load traineddata
        const lang = 'eng';
        Tesseract.recognize(dataURL, lang, { logger: m => {} })
          .then(({ data }) => {
            const rawText = (data && data.text) ? data.text.trim() : '';
            // Generate a concise summary from the recognized text. We split
            // the OCR result into lines, filter out empty ones, and take
            // the first few lines to form a short summary. If the text is
            // long, this helps condense the content into a manageable
            // length for the note field. If no text is recognised, we
            // provide a default message.
            let summary = '';
            if(rawText){
              const lines = rawText.split(/\r?\n/).map(l => l.trim()).filter(l => l);
              summary = lines.slice(0, 5).join(' / ');
              // If summary is still too long, truncate to 300 characters with ellipsis
              if(summary.length > 300){
                summary = summary.slice(0, 297) + '...';
              }
            }
            // Derive title from the filename without extension
            let title = file.name ? file.name.replace(/\.[^/.]+$/, '') : 'åœ–ç‰‡ç­†è¨˜';
            const date = toISODate(new Date());
            const note = summary || '(ç„¡æ–‡å­—è­˜åˆ¥çµæœ)';
            state.learnings.unshift({ id: uid('l'), date, subject:'åœ–ç‰‡ç­†è¨˜', title, notes: note, createdAt: new Date().toISOString() });
            saveStateLocal();
            if(statusEl) statusEl.textContent = 'è­˜åˆ¥å®Œæˆï¼Œå·²æ–°å¢ç­†è¨˜ã€‚';
            // Re-render the learning page to show the new entry and rebind events
            renderLearning();
          })
          .catch(err => {
            if(statusEl) statusEl.textContent = 'è­˜åˆ¥å¤±æ•—ï¼Œè«‹é‡æ–°å˜—è©¦ã€‚';
          });
      };
      reader.readAsDataURL(file);
    });
  }

  // Bind collapse toggles for learning cards: clicking the header toggles
  // the collapsed state and updates the arrow direction. Because the
  // learning cards define their own .card-header elements in the
  // template, the generic applyCardCollapse will skip them. We
  // explicitly attach the toggle logic here.
  const rootEl = document.getElementById('view-learning');
  if(rootEl){
    const headers = rootEl.querySelectorAll('.card-header');
    headers.forEach(header => {
      header.addEventListener('click', () => {
        // Find the nearest card container to ensure we toggle the
        // correct element even if the DOM structure changes. Do not
        // assume the card is the immediate parent of the header.
        const card = header.closest('.card');
        if(!card) return;
        const collapsed = card.classList.toggle('collapsed');
        const arrowEl = header.querySelector('.card-arrow');
        if(arrowEl) arrowEl.textContent = collapsed ? 'â–¶' : 'â–¼';
      });
    });
  }
}
function renderLearningTree(){
  const tree = document.getElementById('learn_tree');
  const subjects = Array.from(new Set(state.learnings.map(x=> x.subject))).sort((a,b)=> a.localeCompare(b,'zh-Hant'));
  const items = [{ label:`å…¨éƒ¨ (${state.learnings.length})`, subject:'ALL' }].concat(subjects.map(s=>{ const n = state.learnings.filter(x=> x.subject===s).length; return { label:`ğŸ“ ${s} (${n})`, subject:s }; }));
  tree.innerHTML = items.map(it=>{
    const active = (learnSubjectFilter===it.subject) ? 'active' : '';
    return `<button class="${active}" data-subject="${escapeHtml(it.subject)}">${escapeHtml(it.label)}</button>`;
  }).join('') || `<div class="hint">å°šç„¡å­¸ç¿’ç´€éŒ„ã€‚</div>`;
  tree.addEventListener('click', (e)=>{
    const btn = e.target.closest('button[data-subject]');
    if(!btn) return;
    learnSubjectFilter = btn.dataset.subject;
    renderLearning();
  }, { once:true });
}
function renderLearningList(){
  const list = document.getElementById('learn_list');
  let arr = state.learnings.slice().sort((a,b)=> new Date(b.date) - new Date(a.date));
  if(learnSubjectFilter !== 'ALL'){ arr = arr.filter(x=> x.subject === learnSubjectFilter); }
  list.innerHTML = arr.slice(0,30).map(x=>{
    return `\
      <div class="item">\
        <div class="meta">\
          <span class="tag"><b>${escapeHtml(x.subject)}</b></span>\
          <span class="tag">${escapeHtml(x.date)}</span>\
        </div>\
        <div style="font-weight:700; margin-bottom:4px">${escapeHtml(x.title)}</div>\
        <div class="hint" style="white-space:pre-wrap">${x.notes ? escapeHtml(x.notes) : 'ï¼ˆç„¡å…§å®¹ï¼‰'}</div>\
        <div class="btns" style="margin-top:6px"><button class="btn danger" onclick="deleteLearning('${x.id}')">åˆªé™¤</button></div>\
      </div>\
    `;
  }).join('') || `<div class="hint">æ­¤ç¯©é¸ä¸‹æ²’æœ‰å­¸ç¿’ç´€éŒ„ã€‚</div>`;
}
function deleteLearning(id){ state.learnings = state.learnings.filter(x=> x.id !== id); saveStateLocal(); renderAll(); }
function renderMindMap(){
  const svg = document.getElementById('mindmap');
  if(!svg) return;
  const bySubject = groupBy(state.learnings, x=> x.subject);
  const subjects = Object.keys(bySubject).sort((a,b)=> a.localeCompare(b,'zh-Hant'));
  let md = '# å­¸ç¿’ç¸½è¦½\n';
  for(const s of subjects){ md += `## ${s}\n`; const items = bySubject[s].slice().sort((a,b)=> new Date(b.date)-new Date(a.date)).slice(0,20); for(const it of items){ md += `- ${it.title} (${it.date})\n`; } }
  svg.innerHTML = '';
  const { Transformer } = window.markmap;
  const transformer = new Transformer();
  const { root } = transformer.transform(md);
  markmapInstance = window.markmap.Markmap.create(svg,{ autoFit:true, duration:0, maxWidth:240 }, root);
}

/* =========================
   Finance Section
========================= */
let incomePie = null;
let expensePie = null;
function financeTemplate(){
  return `\
    <div class="header">\
      <div class="title">\
        <h2>ğŸ’° æ”¶æ”¯ç´€éŒ„</h2>\
        <p>æ”¶å…¥/æ”¯å‡ºåˆ†é–‹å‘ˆç¾åœ“é¤…åœ–ï¼›æ”¯æ´è¨‚é–±è‡ªå‹•æ‰£æ¬¾ï¼ˆæ¯æœˆæŒ‡å®šæ—¥ï¼‰ã€‚</p>\
      </div>\
      <span class="pill money">Finance</span>\
    </div>\
    <div class="grid">\
      <div class="card">\
        <h3>æ–°å¢äº¤æ˜“</h3>\
        <div class="form">\
          <div class="row"><label>æ—¥æœŸ</label><input id="fin_date" type="date" /></div>\
          <div class="row"><label>é¡å‹</label><select id="fin_type"><option value="expense">æ”¯å‡º</option><option value="income">æ”¶å…¥</option></select></div>\
          <div class="row"><label>åˆ†é¡</label><input id="fin_category" placeholder="ä¾‹ï¼šé¤é£² / äº¤é€š / æˆ¿ç§Ÿ / è–ªè³‡" /></div>\
          <div class="row"><label>é‡‘é¡</label><input id="fin_amount" type="number" min="0" step="1" /></div>\
          <div class="row"><label>å‚™è¨»</label><input id="fin_note" placeholder="å¯é¸" /></div>\
          <div class="btns"><button class="btn primary" id="fin_add">æ–°å¢</button></div>\
        </div>\
        <h3 style="margin-top:12px;">è¨‚é–±æ‰£æ¬¾ï¼ˆæ¯æœˆï¼‰</h3>\
        <div class="form">\
          <div class="row"><label>åç¨±</label><input id="sub_name" placeholder="ä¾‹ï¼šNetflix / iCloud / å¥èº«æˆ¿" /></div>\
          <div class="row"><label>åˆ†é¡</label><input id="sub_category" placeholder="ä¾‹ï¼šè¨‚é–± / å·¥å…· / å¥èº«" /></div>\
          <div class="row"><label>æ‰£æ¬¾æ—¥</label><input id="sub_day" type="number" min="1" max="28" step="1" placeholder="å»ºè­° 1-28" /></div>\
          <div class="row"><label>é‡‘é¡</label><input id="sub_amount" type="number" min="0" step="1" /></div>\
          <div class="btns">\
            <button class="btn primary" id="sub_add">æ–°å¢è¨‚é–±</button>\
            <button class="btn" id="sub_run">ç”Ÿæˆæœ¬æœˆè¨‚é–±æ‰£æ¬¾</button>\
          </div>\
          <div class="hint">ç³»çµ±æœƒåœ¨ä½ é–‹å•Ÿç¶²ç«™æ™‚è‡ªå‹•æª¢æŸ¥ï¼šè‹¥ã€Œä»Šå¤©å·²åˆ°æ‰£æ¬¾æ—¥ã€ä¸”æœ¬æœˆå°šæœªç”Ÿæˆï¼Œå°‡è‡ªå‹•æ–°å¢ä¸€ç­†æ”¯å‡ºã€‚</div>\
        </div>\
      </div>\
      <div class="card">\
        <div class="split">\
          <div>\
            <h3>åœ“é¤…åœ–ï¼šæ”¯å‡ºåˆ†é¡</h3>\
            <div class="pie-row">\
              <div class="chart-wrap" style="height:240px;"><canvas id="expense_pie"></canvas></div>\
              <div class="pie-details" id="expense_details"></div>\
            </div>\
          </div>\
          <div>\
            <h3>åœ“é¤…åœ–ï¼šæ”¶å…¥åˆ†é¡</h3>\
            <div class="pie-row">\
              <div class="chart-wrap" style="height:240px;"><canvas id="income_pie"></canvas></div>\
              <div class="pie-details" id="income_details"></div>\
            </div>\
          </div>\
        </div>\
        <div style="margin-top:10px"><h3>æœ€è¿‘äº¤æ˜“</h3><div class="list" id="fin_list"></div></div>\
        <div style="margin-top:10px"><h3>è¨‚é–±æ¸…å–®</h3><div class="list" id="sub_list"></div></div>\
      </div>\
    </div>\
  `;
}
function renderFinance(){
  const root = document.getElementById('view-finance');
  root.innerHTML = financeTemplate();
  document.getElementById('fin_date').value = toISODate(new Date());
  document.getElementById('fin_add').addEventListener('click', ()=>{
    const date = document.getElementById('fin_date').value;
    const type = document.getElementById('fin_type').value;
    const category = document.getElementById('fin_category').value.trim();
    const amount = Number(document.getElementById('fin_amount').value || 0);
    const note = document.getElementById('fin_note').value.trim();
    if(!date || !category || amount<=0){ alert('è«‹è‡³å°‘å¡«ï¼šæ—¥æœŸã€åˆ†é¡ã€é‡‘é¡(>0)'); return; }
    state.transactions.unshift({ id: uid('t'), date, type, category, amount, note, createdAt: new Date().toISOString() });
    saveStateLocal();
    renderFinance();
  });
  document.getElementById('sub_add').addEventListener('click', ()=>{
    const name = document.getElementById('sub_name').value.trim();
    const category = document.getElementById('sub_category').value.trim();
    const day = Number(document.getElementById('sub_day').value || 0);
    const amount = Number(document.getElementById('sub_amount').value || 0);
    if(!name || !category || day<1 || day>28 || amount<=0){ alert('è¨‚é–±éœ€å¡«ï¼šåç¨±ã€åˆ†é¡ã€æ‰£æ¬¾æ—¥(1-28)ã€é‡‘é¡(>0)'); return; }
    state.subscriptions.unshift({ id: uid('s'), name, category, dayOfMonth: day, amount, lastGeneratedMonth: null });
    saveStateLocal();
    renderFinance();
  });
  document.getElementById('sub_run').addEventListener('click', ()=>{ runSubscriptionAutopost(true); renderFinance(); });
  // auto run subscription generation
  runSubscriptionAutopost(false);
  renderFinanceCharts();
  renderFinanceList();
  renderSubscriptionList();
  // Show recommendations section for finance
  renderRecommendations('finance');
}
function runSubscriptionAutopost(manual){
  const now = new Date();
  const month = `${now.getFullYear()}-${pad2(now.getMonth()+1)}`;
  const day = now.getDate();
  let generated = 0;
  for(const s of state.subscriptions){
    const shouldGenerate = (day >= s.dayOfMonth) && (s.lastGeneratedMonth !== month);
    if(shouldGenerate){
      state.transactions.unshift({ id: uid('t'), date: toISODate(now), type:'expense', category: s.category, amount: s.amount, note: `è¨‚é–±ï¼š${s.name}ï¼ˆ${month}ï¼‰`, createdAt: new Date().toISOString() });
      s.lastGeneratedMonth = month;
      generated++;
    }
  }
  if(generated>0){ saveStateLocal(); if(manual) alert(`å·²ç”Ÿæˆ ${generated} ç­†æœ¬æœˆè¨‚é–±æ‰£æ¬¾ã€‚`); }
  else{ if(manual) alert('æœ¬æœˆè¨‚é–±æ‰£æ¬¾ç„¡éœ€ç”Ÿæˆï¼ˆå¯èƒ½å°šæœªåˆ°æ‰£æ¬¾æ—¥ï¼Œæˆ–å·²ç”Ÿæˆï¼‰ã€‚'); }
}
function renderFinanceCharts(){
  if(incomePie){ incomePie.destroy(); incomePie = null; }
  if(expensePie){ expensePie.destroy(); expensePie = null; }
  const expenses = state.transactions.filter(t=> t.type==='expense');
  const income = state.transactions.filter(t=> t.type==='income');
  const expenseByCat = groupBy(expenses, t=> t.category);
  const incomeByCat = groupBy(income, t=> t.category);
  const expLabels = Object.keys(expenseByCat).sort((a,b)=> a.localeCompare(b,'zh-Hant'));
  const incLabels = Object.keys(incomeByCat).sort((a,b)=> a.localeCompare(b,'zh-Hant'));
  const expData = expLabels.map(k=> sum(expenseByCat[k].map(x=> x.amount)));
  const incData = incLabels.map(k=> sum(incomeByCat[k].map(x=> x.amount)));
  const expCanvas = document.getElementById('expense_pie');
  const incCanvas = document.getElementById('income_pie');
  expensePie = new Chart(expCanvas, {
    type:'pie',
    data:{ labels: expLabels.length ? expLabels : ['ï¼ˆå°šç„¡æ”¯å‡ºï¼‰'], datasets:[{ data: expLabels.length ? expData : [1] }] },
    options:{
      plugins:{
        tooltip:{ callbacks:{ label:(ctx)=>{ if(!expLabels.length) return 'å°šç„¡è³‡æ–™'; const v = ctx.parsed; return ` ${ctx.label}: ${v}`; } } }
      }
    }
  });
  incomePie = new Chart(incCanvas, {
    type:'pie',
    data:{ labels: incLabels.length ? incLabels : ['ï¼ˆå°šç„¡æ”¶å…¥ï¼‰'], datasets:[{ data: incLabels.length ? incData : [1] }] },
    options:{
      plugins:{
        tooltip:{ callbacks:{ label:(ctx)=>{ if(!incLabels.length) return 'å°šç„¡è³‡æ–™'; const v = ctx.parsed; return ` ${ctx.label}: ${v}`; } } }
      }
    }
  });
  // update details lists
  const expDetailEl = document.getElementById('expense_details');
  const incDetailEl = document.getElementById('income_details');
  if(expDetailEl){
    if(expLabels.length){
      const totalExp = expData.reduce((a,b)=> a+b, 0) || 1;
      expDetailEl.innerHTML = expLabels.map((lbl, i)=>{
        const val = expData[i];
        const perc = totalExp ? ((val/totalExp)*100).toFixed(1) : '0.0';
        return `<div>${escapeHtml(lbl)}: ${escapeHtml(String(val))} (${perc}%)</div>`;
      }).join('');
    }else{
      expDetailEl.innerHTML = '<div>â€”</div>';
    }
  }
  if(incDetailEl){
    if(incLabels.length){
      const totalInc = incData.reduce((a,b)=> a+b, 0) || 1;
      incDetailEl.innerHTML = incLabels.map((lbl, i)=>{
        const val = incData[i];
        const perc = totalInc ? ((val/totalInc)*100).toFixed(1) : '0.0';
        return `<div>${escapeHtml(lbl)}: ${escapeHtml(String(val))} (${perc}%)</div>`;
      }).join('');
    }else{
      incDetailEl.innerHTML = '<div>â€”</div>';
    }
  }
}
function renderFinanceList(){
  const list = document.getElementById('fin_list');
  const items = state.transactions.slice().sort((a,b)=> new Date(b.date) - new Date(a.date)).slice(0, 16);
  list.innerHTML = items.map(t=>{
    const sign = (t.type==='expense') ? '-' : '+';
    const tag = (t.type==='expense') ? 'æ”¯å‡º' : 'æ”¶å…¥';
    return `\
      <div class="item">\
        <div class="meta">\
          <span class="tag"><b>${escapeHtml(tag)}</b></span>\
          <span class="tag">${escapeHtml(t.date)}</span>\
          <span class="tag">${escapeHtml(t.category)}</span>\
          <span class="tag">${sign}${escapeHtml(String(t.amount))}</span>\
        </div>\
        <div class="hint">${t.note ? escapeHtml(t.note) : 'ï¼ˆç„¡å‚™è¨»ï¼‰'}</div>\
        <div class="btns" style="margin-top:6px"><button class="btn danger" onclick="deleteTransaction('${t.id}')">åˆªé™¤</button></div>\
      </div>\
    `;
  }).join('') || `<div class="hint">å°šç„¡äº¤æ˜“ç´€éŒ„ã€‚</div>`;
}
function deleteTransaction(id){ state.transactions = state.transactions.filter(t=> t.id!==id); saveStateLocal(); renderAll(); }
function renderSubscriptionList(){
  const list = document.getElementById('sub_list');
  const subs = state.subscriptions.slice();
  list.innerHTML = subs.map(s=>{
    return `\
      <div class="item">\
        <div class="meta">\
          <span class="tag"><b>${escapeHtml(s.name)}</b></span>\
          <span class="tag">${escapeHtml(s.category)}</span>\
          <span class="tag">æ¯æœˆ ${escapeHtml(String(s.dayOfMonth))} æ—¥</span>\
          <span class="tag">${escapeHtml(String(s.amount))}</span>\
        </div>\
        <div class="hint">æœ¬æœˆç”Ÿæˆç‹€æ…‹ï¼š${s.lastGeneratedMonth ? escapeHtml(s.lastGeneratedMonth) : 'å°šæœªç”Ÿæˆ'}</div>\
        <div class="btns" style="margin-top:6px"><button class="btn danger" onclick="deleteSubscription('${s.id}')">åˆªé™¤</button></div>\
      </div>\
    `;
  }).join('') || `<div class="hint">å°šç„¡è¨‚é–±ã€‚</div>`;
}
function deleteSubscription(id){ state.subscriptions = state.subscriptions.filter(s=> s.id!==id); saveStateLocal(); renderAll(); }

/* =========================
   Render All
========================= */
function renderAll(){
  const active = document.querySelector('.nav button.active')?.dataset.view || 'home';
  if(active === 'fitness') renderFitness();
  else if(active === 'diary') renderDiary();
  else if(active === 'learning') renderLearning();
  else if(active === 'finance') renderFinance();
  else if(active === 'overview') renderOverview();
  else if(active === 'home') renderHome();
  // After rendering, apply collapsible card functionality except on home view
  if(active !== 'home'){
    applyCardCollapse(active);
  }
}

// On initial load, ensure the home page is visible. Without this, the
// home view remains hidden because it has display:none set in the HTML.
// We call this after renderAll in the boot sequence below.
function showHomeView(){
  const homeEl = document.getElementById('view-home');
  if(homeEl){ homeEl.style.display = 'block'; }
}

// Boot: load collapsed state for recommendations, load data and render
// Boot: load collapse and visited state, then render
loadRecCollapsed();
loadVisitedDate();
state = loadStateLocal();
renderAll();
// Ensure the home page is visible on initial load
showHomeView();
// Initialize navigation collapse toggle and restore previous state
(() => {
  const navBtn = document.getElementById('navToggle');
  const topnavEl = document.querySelector('.topnav');
  if(navBtn && topnavEl){
    // restore collapsed state from localStorage
    let collapsed = false;
    try{
      collapsed = localStorage.getItem('navCollapsed') === '1';
    }catch(e){ collapsed = false; }
    if(collapsed){ topnavEl.classList.add('collapsed'); navBtn.textContent = 'â˜°'; }
    else{ navBtn.textContent = 'âœ•'; }
    navBtn.addEventListener('click', ()=>{
      const isCollapsed = !topnavEl.classList.contains('collapsed');
      topnavEl.classList.toggle('collapsed', isCollapsed);
      navBtn.textContent = isCollapsed ? 'â˜°' : 'âœ•';
      try{
        localStorage.setItem('navCollapsed', isCollapsed ? '1' : '0');
      }catch(e){}
    });
  }
})();

// Attach click handler for the Home button to return to the landing page.
// This handler hides all other views, deselects any active nav buttons,
// shows the home view and re-renders it to update glow status based on
// whether each category has new entries today. It runs immediately
// during boot once the DOM is ready. Without this, clicking the home
// button would have no effect.
(function(){
  const homeBtn = document.getElementById('homeBtn');
  if(homeBtn){
    homeBtn.addEventListener('click', () => {
      // Hide all views
      document.querySelectorAll('.view').forEach(v => v.style.display = 'none');
      // Deselect all nav buttons
      document.querySelectorAll('.nav button').forEach(b => b.classList.remove('active'));
      // Show the home view
      const homeView = document.getElementById('view-home');
      if(homeView) homeView.style.display = 'block';
      // Render the home page to update highlights
      renderHome();
    });
  }
})();
</script>
</body>
</html>