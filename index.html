<!doctype html>
<!--
  Personal Log (Mobile Only)

  This single‚Äëpage web application replicates the functionality and design of the
  original multi‚Äëdevice Personal Log, but is simplified to run entirely on a
  single device with no dependencies on Firebase or any external backend.
  All data is stored in the browser's LocalStorage. The UI remains
  responsive but focuses on mobile usage ‚Äî the layout defaults to a single
  column on small screens and collapses navigation into a simple list at
  the top of the page.

  To deploy this site for personal use, simply upload this file as
  index.html to any static host (GitHub Pages, Netlify, Vercel) or open it
  directly on your phone.
-->
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Personal Log (Mobile) | ÂÅ•Ë∫´„ÉªÊó•Ë®ò„ÉªÂ≠∏Áøí„ÉªÊî∂ÊîØ</title>

  <!-- Chart.js for charts -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <!-- Markmap for mind maps -->
  <script src="https://cdn.jsdelivr.net/npm/markmap-lib@0.17.2/dist/browser/index.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/markmap-view@0.17.2/dist/browser/index.min.js"></script>
  <!-- Tesseract.js for OCR on uploaded images in the learning section -->
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@2.1.5/dist/tesseract.min.js"></script>

  <style>
    /*
      THEME & VARIABLES

      A warm palette with moderate brightness and low‚Äìmedium saturation. Each
      functional category has its own accent colour. The layout adapts to
      mobile first: on small screens, content is presented in a single
      column, and navigation controls are stacked for easy thumb reach.
    */
    :root{
      /* Cyberpunk Neon Color Scheme */
      --bg-dark: #0a0e27;
      --bg-mid: #1a1d3a;
      --bg-deep: #0f1419;
      --panel: rgba(26,29,58,.85);
      --card: rgba(20,25,45,.90);
      --text: #e6e6e6;
      --text-bright: #ffffff;
      --muted: #8b8b8b;
      --border: rgba(0,212,255,.3);
      --shadow: 0 0 20px rgba(0,212,255,.4);
      --shadow2: 0 0 15px rgba(181,55,242,.3);
      --shadow3: 0 0 30px rgba(255,0,110,.4);

      /* Neon Colors */
      --neon-cyan: #00d4ff;
      --neon-purple: #b537f2;
      --neon-pink: #ff006e;
      --neon-green: #39ff14;
      --neon-orange: #ff9e00;

      /* Category Colors with Neon */
      --fit: #ff9e00;
      --fit-glow: 0 0 10px #ff9e00, 0 0 20px #ff9e00, 0 0 30px #ff9e00;
      --fit-gradient: linear-gradient(135deg, #ff9e00 0%, #ff6e00 100%);

      --diary: #ff006e;
      --diary-glow: 0 0 10px #ff006e, 0 0 20px #ff006e, 0 0 30px #ff006e;
      --diary-gradient: linear-gradient(135deg, #ff006e 0%, #ff1744 100%);

      --learn: #00d4ff;
      --learn-glow: 0 0 10px #00d4ff, 0 0 20px #00d4ff, 0 0 30px #00d4ff;
      --learn-gradient: linear-gradient(135deg, #00d4ff 0%, #00b4d8 100%);

      --money: #39ff14;
      --money-glow: 0 0 10px #39ff14, 0 0 20px #39ff14, 0 0 30px #39ff14;
      --money-gradient: linear-gradient(135deg, #39ff14 0%, #00ff88 100%);

      --overview: #b537f2;
      --overview-glow: 0 0 10px #b537f2, 0 0 20px #b537f2, 0 0 30px #b537f2;
      --overview-gradient: linear-gradient(135deg, #b537f2 0%, #8b00ff 100%);

      --danger: #ff0040;
      --danger-glow: 0 0 10px #ff0040, 0 0 20px #ff0040;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: 'Courier New', 'Consolas', 'Monaco', monospace, "Noto Sans TC", "PingFang TC", "Microsoft JhengHei", sans-serif;
      background-color: var(--bg-dark);
      background-image:
        /* Cyberpunk grid */
        linear-gradient(rgba(0,212,255,.03) 1px, transparent 1px),
        linear-gradient(90deg, rgba(0,212,255,.03) 1px, transparent 1px),
        /* Neon glow spots */
        radial-gradient(ellipse 800px 600px at 10% 20%, rgba(181,55,242,.15), transparent 50%),
        radial-gradient(ellipse 700px 500px at 90% 10%, rgba(0,212,255,.12), transparent 50%),
        radial-gradient(ellipse 600px 400px at 50% 80%, rgba(255,0,110,.10), transparent 50%),
        radial-gradient(ellipse 500px 400px at 80% 90%, rgba(57,255,20,.08), transparent 50%);
      background-size: 40px 40px, 40px 40px, 100% 100%, 100% 100%, 100% 100%, 100% 100%;
      background-position: 0 0, 0 0, 0 0, 0 0, 0 0, 0 0;
      background-attachment: fixed;
      color:var(--text);
      min-height: 100vh;
      position: relative;
    }
    /* Scanline effect overlay */
    body::before{
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: repeating-linear-gradient(
        0deg,
        rgba(0,0,0,.15) 0px,
        transparent 1px,
        transparent 2px,
        rgba(0,0,0,.15) 3px
      );
      pointer-events: none;
      z-index: 9999;
      opacity: 0.3;
    }
    /* Layout container: sidebar replaced by top nav for mobile. */
    .app{
      display:flex;
      flex-direction:column;
      min-height:100vh;
    }
    /* Top navigation bar */
    .topnav{
      display:flex;
      flex-direction:column;
      padding:14px 18px;
      background: rgba(10,14,39,.92);
      border-bottom:2px solid var(--neon-cyan);
      border-top: 1px solid rgba(0,212,255,.2);
      position:sticky;
      top:0;
      z-index:10;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      box-shadow: 0 0 20px rgba(0,212,255,.3),
                  0 4px 30px rgba(0,0,0,.5);
    }
    .brand{
      display:flex;
      align-items:center;
      gap:10px;
    }
    .brand h1{
      font-size:18px;
      margin:0;
      color: var(--neon-cyan);
      text-shadow: 0 0 10px var(--neon-cyan),
                   0 0 20px var(--neon-cyan),
                   0 0 30px var(--neon-cyan);
      font-weight: 700;
      letter-spacing: 2px;
      text-transform: uppercase;
    }
    .brand p{
      margin:2px 0 0;
      font-size:11px;
      color:var(--muted);
      line-height:1.4;
      letter-spacing: 1px;
    }
    .nav{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-top:10px;
    }
    .nav button{
      flex:1 1 calc(50% - 8px);
      display:flex;
      align-items:center;
      gap:8px;
      padding:10px 14px;
      border-radius:4px;
      border:1px solid rgba(0,212,255,.4);
      background: rgba(20,25,45,.60);
      backdrop-filter: blur(5px);
      -webkit-backdrop-filter: blur(5px);
      cursor:pointer;
      text-align:left;
      transition: all .2s ease;
      font-weight: 600;
      color: var(--text);
      letter-spacing: 0.5px;
      position: relative;
    }
    .nav button:hover{
      transform: translateY(-1px);
      background: rgba(20,25,45,.80);
      border-color: var(--neon-cyan);
      box-shadow: 0 0 15px rgba(0,212,255,.4),
                  inset 0 0 10px rgba(0,212,255,.1);
    }
    .nav button.active{
      background: rgba(30,35,55,.90);
      border: 2px solid var(--neon-cyan);
      box-shadow: 0 0 20px rgba(0,212,255,.6),
                  0 0 40px rgba(0,212,255,.3),
                  inset 0 0 15px rgba(0,212,255,.2);
      color: var(--text-bright);
    }
    .nav button.active::before{
      content: '';
      position: absolute;
      left: -2px;
      top: -2px;
      right: -2px;
      bottom: -2px;
      background: var(--learn-gradient);
      border-radius: 4px;
      z-index: -1;
      opacity: 0.3;
      filter: blur(8px);
    }
    .dot{width:8px;height:8px;border-radius:99px;}
    .dot.fit{background:var(--fit)}
    .dot.diary{background:var(--diary)}
    .dot.learn{background:var(--learn)}
    .dot.money{background:var(--money)}
    .dot.overview{background:var(--overview)}
    .small{font-size:11px;color:var(--muted)}
    .top-actions{
      display:flex;
      gap:6px;
      margin-top:10px;
      flex-wrap:wrap;
    }
    .top-actions button, .top-actions label{
      flex:1 1 calc(50% - 6px);
      border:1.5px solid rgba(255,255,255,.40);
      background: rgba(255,255,255,.35);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      border-radius:12px;
      padding:9px 12px;
      cursor:pointer;
      font-size:12px;
      font-weight: 600;
      text-align:center;
      transition: all 0.25s ease;
      box-shadow: 0 2px 8px rgba(80,40,120,.08),
                  inset 0 1px 0 rgba(255,255,255,.4);
    }
    .top-actions button:hover, .top-actions label:hover{
      background: rgba(255,255,255,.50);
      border-color: rgba(255,255,255,.55);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(80,40,120,.12),
                  inset 0 1px 0 rgba(255,255,255,.5);
    }
    .top-actions input{display:none}

    /* Collapsible navigation bar styles */
    .topnav-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
    }
    .nav-toggle{
      background: rgba(255,255,255,.35);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      border:1.5px solid rgba(255,255,255,.40);
      border-radius:12px;
      padding:8px 12px;
      font-size:18px;
      line-height:1;
      cursor:pointer;
      color:var(--text);
      transition: all 0.25s ease;
      box-shadow: 0 2px 8px rgba(80,40,120,.08),
                  inset 0 1px 0 rgba(255,255,255,.4);
    }
    .nav-toggle:hover{
      background:rgba(255,255,255,.50);
      border-color: rgba(255,255,255,.55);
      box-shadow: 0 4px 12px rgba(80,40,120,.12),
                  inset 0 1px 0 rgba(255,255,255,.5);
    }

  /* Container for home and nav toggle buttons */
  .header-controls{
    display:flex;
    align-items:center;
    gap:8px;
  }

  /* Home button styles (same baseline as nav-toggle) */
  .home-toggle{
    background: rgba(255,255,255,.35);
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
    border:1.5px solid rgba(255,255,255,.40);
    border-radius:12px;
    padding:8px 12px;
    font-size:18px;
    line-height:1;
    cursor:pointer;
    color:var(--text);
    display:flex;
    align-items:center;
    justify-content:center;
    transition: all 0.25s ease;
    box-shadow: 0 2px 8px rgba(80,40,120,.08),
                  inset 0 1px 0 rgba(255,255,255,.4);
  }
  .home-toggle:hover{
    background:rgba(255,255,255,.50);
    border-color: rgba(255,255,255,.55);
    box-shadow: 0 4px 12px rgba(80,40,120,.12),
                  inset 0 1px 0 rgba(255,255,255,.5);
  }
    /* When navigation is collapsed, hide nav-content */
    .topnav.collapsed .nav-content{
      display:none;
    }

    .main{
      flex:1;
      padding:16px;
      width:100%;
      max-width:900px;
      margin:0 auto;
    }
    .header{
      display:flex;
      justify-content:space-between;
      align-items:flex-end;
      margin-bottom:12px;
    }
    .title h2{
      margin:0;
      font-size:22px;
      letter-spacing:2px;
      text-transform: uppercase;
      color: var(--text-bright);
      text-shadow: 0 0 10px rgba(0,212,255,.6),
                   0 0 20px rgba(0,212,255,.4);
      font-weight: 700;
    }
    .title p{margin:4px 0 0;color:var(--muted);font-size:12px;letter-spacing:0.5px;}
    .pill{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:4px 10px;
      border-radius:3px;
      border:1px solid rgba(0,212,255,.4);
      background: rgba(15,20,35,.70);
      backdrop-filter: blur(5px);
      -webkit-backdrop-filter: blur(5px);
      font-size:11px;
      font-weight: 700;
      color:var(--text);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      box-shadow: 0 0 8px rgba(0,212,255,.2);
    }
    .pill.fit{
      border-color:var(--fit);
      color: var(--fit);
      box-shadow: 0 0 10px rgba(255,158,0,.3);
    }
    .pill.diary{
      border-color:var(--diary);
      color: var(--diary);
      box-shadow: 0 0 10px rgba(255,0,110,.3);
    }
    .pill.learn{
      border-color:var(--learn);
      color: var(--learn);
      box-shadow: 0 0 10px rgba(0,212,255,.3);
    }
    .pill.money{
      border-color:var(--money);
      color: var(--money);
      box-shadow: 0 0 10px rgba(57,255,20,.3);
    }
    .pill.overview{
      border-color:var(--overview);
      color: var(--overview);
      box-shadow: 0 0 10px rgba(181,55,242,.3);
    }
    .grid{
      display:flex;
      flex-direction:column;
      gap:14px;
    }
    .card{
      border:2px solid rgba(0,212,255,.3);
      background: rgba(20,25,45,.85);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      border-radius:6px;
      box-shadow: 0 0 20px rgba(0,212,255,.2),
                  0 4px 20px rgba(0,0,0,.5),
                  inset 0 1px 0 rgba(0,212,255,.1);
      padding:18px;
      transition: all 0.3s ease;
      position: relative;
    }
    .card::before{
      content: '';
      position: absolute;
      top: -2px;
      left: -2px;
      right: -2px;
      bottom: -2px;
      border-radius: 6px;
      background: linear-gradient(135deg,
        rgba(0,212,255,.2) 0%,
        rgba(181,55,242,.2) 50%,
        rgba(255,0,110,.2) 100%);
      z-index: -1;
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    .card:hover{
      transform: translateY(-3px);
      box-shadow: 0 0 30px rgba(0,212,255,.4),
                  0 0 50px rgba(181,55,242,.2),
                  0 8px 30px rgba(0,0,0,.6),
                  inset 0 1px 0 rgba(0,212,255,.2);
      border-color: var(--neon-cyan);
    }
    .card:hover::before{
      opacity: 1;
    }
    .form{
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .row{
      display:flex;
      gap:8px;
      align-items:center;
    }
    .row label{
      width:90px;
      font-size:12px;
      color:var(--muted);
    }
    input, select, textarea{
      flex:1;
      border:2px solid rgba(0,212,255,.3);
      border-radius:4px;
      padding:10px 14px;
      background: rgba(15,20,35,.80);
      backdrop-filter: blur(5px);
      -webkit-backdrop-filter: blur(5px);
      color:var(--text);
      outline:none;
      font-size:13px;
      font-family: 'Courier New', 'Consolas', monospace, sans-serif;
      transition: all 0.25s ease;
      box-shadow: inset 0 0 10px rgba(0,0,0,.3);
    }
    input:focus, select:focus, textarea:focus{
      border-color: var(--neon-cyan);
      background: rgba(20,25,45,.90);
      box-shadow: 0 0 15px rgba(0,212,255,.5),
                  0 0 30px rgba(0,212,255,.2),
                  inset 0 0 10px rgba(0,212,255,.1);
      transform: translateY(-1px);
    }
    select{
      cursor: pointer;
      padding-right: 32px;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%2300d4ff' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 10px center;
    }
    select optgroup{
      font-weight: 700;
      font-size: 13px;
      color: #000;
      padding: 8px 0;
      background: #1a1d3a;
    }
    select option{
      padding: 8px 12px;
      font-size: 13px;
      background: #0f1419;
      color: var(--text);
      border-bottom: 1px solid rgba(0,212,255,.1);
    }
    textarea{min-height:80px; resize:vertical; line-height:1.4}
    .btns{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
    }
    .btn{
      flex:1;
      border:2px solid rgba(0,212,255,.4);
      border-radius:4px;
      padding:11px 16px;
      cursor:pointer;
      background: rgba(20,25,45,.70);
      backdrop-filter: blur(5px);
      -webkit-backdrop-filter: blur(5px);
      font-size:13px;
      font-weight: 700;
      transition: all 0.25s ease;
      font-family: 'Courier New', monospace, sans-serif;
      color: var(--text);
      text-transform: uppercase;
      letter-spacing: 1px;
      box-shadow: 0 0 10px rgba(0,212,255,.2),
                  inset 0 1px 0 rgba(0,212,255,.1);
      position: relative;
    }
    .btn.primary{
      background: rgba(20,25,45,.80);
      border: 2px solid var(--neon-purple);
      color: var(--text-bright);
      box-shadow: 0 0 15px rgba(181,55,242,.4),
                  inset 0 0 10px rgba(181,55,242,.1);
    }
    .btn.danger{
      background: rgba(20,25,45,.80);
      border: 2px solid var(--danger);
      color: var(--text-bright);
      box-shadow: 0 0 15px rgba(255,0,64,.4),
                  inset 0 0 10px rgba(255,0,64,.1);
    }
    .btn:hover{
      background: rgba(30,35,55,.85);
      transform: translateY(-2px);
      box-shadow: 0 0 20px rgba(0,212,255,.5),
                  0 0 40px rgba(0,212,255,.2),
                  inset 0 0 15px rgba(0,212,255,.15);
      border-color: var(--neon-cyan);
    }
    .btn.primary:hover{
      box-shadow: 0 0 25px rgba(181,55,242,.6),
                  0 0 50px rgba(181,55,242,.3),
                  inset 0 0 20px rgba(181,55,242,.2);
      border-color: var(--neon-purple);
      transform: translateY(-2px);
    }
    .btn.danger:hover{
      box-shadow: 0 0 25px rgba(255,0,64,.6),
                  0 0 50px rgba(255,0,64,.3),
                  inset 0 0 20px rgba(255,0,64,.2);
      border-color: var(--danger);
      transform: translateY(-2px);
    }
    .btn:active{
      transform: translateY(0);
    }

    .list{display:flex;flex-direction:column;gap:12px;}
    .item{
      border:2px solid rgba(0,212,255,.25);
      background: rgba(15,20,35,.75);
      backdrop-filter: blur(5px);
      -webkit-backdrop-filter: blur(5px);
      border-radius:4px;
      padding:14px;
      box-shadow: 0 0 15px rgba(0,212,255,.15),
                  inset 0 1px 0 rgba(0,212,255,.08);
      transition: all 0.25s ease;
      position: relative;
    }
    .item::before{
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      width: 3px;
      height: 100%;
      background: var(--learn-gradient);
      border-radius: 4px 0 0 4px;
      opacity: 0;
      transition: opacity 0.25s ease;
    }
    .item:hover{
      box-shadow: 0 0 25px rgba(0,212,255,.3),
                  0 0 50px rgba(181,55,242,.15),
                  inset 0 1px 0 rgba(0,212,255,.15);
      transform: translateX(5px);
      border-color: var(--neon-cyan);
      background: rgba(20,25,45,.85);
    }
    .item:hover::before{
      opacity: 1;
    }
    .meta{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      font-size:11px;
      color:var(--muted);
      margin-bottom:4px;
    }
    .meta b{color:var(--text); font-weight:600;}
    .tag{
      display:inline-flex;
      align-items:center;
      gap:4px;
      padding:3px 8px;
      border-radius:3px;
      border:1px solid rgba(0,212,255,.3);
      background: rgba(10,14,27,.60);
      backdrop-filter: blur(3px);
      -webkit-backdrop-filter: blur(3px);
      font-size:10px;
      font-weight: 600;
      color:var(--text);
      box-shadow: 0 0 5px rgba(0,212,255,.15);
    }
    .kpi{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
    }
    .kpi .box{
      flex:1;
      border:1.5px solid rgba(255,255,255,.45);
      background: rgba(255,255,255,.35);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border-radius:16px;
      padding:10px 12px;
      min-width:75px;
      box-shadow: 0 2px 10px rgba(80,40,120,.08),
                  inset 0 1px 0 rgba(255,255,255,.5);
      transition: all 0.25s ease;
    }
    .kpi .box:hover{
      transform: translateY(-2px);
      box-shadow: 0 4px 14px rgba(80,40,120,.12),
                  inset 0 1px 0 rgba(255,255,255,.6);
    }
    .kpi .n{font-size:14px;font-weight:700;margin-top:2px}
    .kpi .t{font-size:11px;color:var(--muted)}

    .split{
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .folder{
      border:1.5px solid rgba(255,255,255,.45);
      border-radius:16px;
      background: rgba(255,255,255,.30);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      padding:12px;
      box-shadow: 0 4px 16px rgba(80,40,120,.08),
                  inset 0 1px 0 rgba(255,255,255,.5);
    }
    .folder h4{
      margin:0 0 6px;
      font-size:11px;
      color:var(--muted);
      letter-spacing:.2px;
    }
    .tree{
      display:flex;
      flex-direction:column;
      gap:6px;
      max-height:260px;
      overflow:auto;
      padding-right:2px;
    }
    .tree button{
      border:1.5px solid rgba(255,255,255,.40);
      background: rgba(255,255,255,.35);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      border-radius:12px;
      padding:8px 12px;
      cursor:pointer;
      font-size:11px;
      font-weight: 600;
      color:var(--text);
      text-align:left;
      transition: all 0.25s ease;
      box-shadow: 0 1px 4px rgba(80,40,120,.06),
                  inset 0 0.5px 0 rgba(255,255,255,.4);
    }
    .tree button:hover{
      background: rgba(255,255,255,.45);
      border-color: rgba(255,255,255,.55);
      transform: translateX(2px);
    }
    .tree button.active{
      border-color: rgba(183,148,246,.50);
      background: linear-gradient(135deg, rgba(183,148,246,.30), rgba(200,162,255,.25));
      box-shadow: 0 2px 8px rgba(183,148,246,.15),
                  inset 0 1px 0 rgba(255,255,255,.6);
    }
    .hint{font-size:11px;color:var(--muted);line-height:1.4}
    canvas{max-width:100%;}
    .chart-wrap{
      border:1.5px solid rgba(255,255,255,.45);
      background: rgba(255,255,255,.35);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border-radius:16px;
      padding:12px;
      box-shadow: 0 4px 16px rgba(80,40,120,.10),
                  inset 0 1px 0 rgba(255,255,255,.5);
    }

    /* Details list next to pie charts */
    .pie-details{
      /* Bigger bold text for percentage and category names. This matches the export style. */
      font-size:20px;
      font-weight:700;
      color:var(--text);
      line-height:1.6;
      /* Remove top margin so it can sit flush next to chart when in a flex row */
      margin-top:0;
    }

    /* Layout for chart and its details to appear side by side */
    .pie-row{
      display:flex;
      align-items:center;
      gap:12px;
      flex-wrap:nowrap;
    }
    /* Ensure chart and details each occupy roughly half of the row */
    .pie-row .chart-wrap{
      flex:0 0 50%;
    }
    .pie-row .pie-details{
      flex:0 0 50%;
      min-width:0;
    }

    /* Recommendation section styling */
    .recommendations{
      border:1.5px solid rgba(255,255,255,.45);
      background: rgba(255,255,255,.30);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      border-radius:18px;
      padding:14px;
      margin-top:16px;
      box-shadow: 0 6px 24px rgba(80,40,120,.10),
                  inset 0 1px 0 rgba(255,255,255,.5);
    }
    .recommendations .rec-toggle{
      width:100%;
      display:flex;
      align-items:center;
      justify-content:space-between;
      background:none;
      border:none;
      font-size:14px;
      font-weight:600;
      color:var(--text);
      cursor:pointer;
      padding:6px 4px;
    }
    .recommendations .rec-toggle:hover{
      background: rgba(255,255,255,.70);
    }
    .recommendations.collapsed .rec-content{
      display:none;
    }
    .recommendations .rec-content p{
      margin:6px 0;
      font-size:14px;
      color:var(--text);
      line-height:1.5;
    }

    /* Collapsible card layout */
    .card.collapsed .card-body{
      /* When a card has the collapsed class, hide its body entirely. Use
         !important to ensure this takes precedence over any other display
         properties that might be applied by nested elements. */
      display:none !important;
    }
    .card-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      cursor:pointer;
      user-select:none;
    }
    .card-header h3{
      margin:0;
      font-size:14px;
    }
    .card-arrow{
      font-size:16px;
      transition:transform 0.2s ease;
    }
    .card.collapsed .card-arrow{
      transform:rotate(-90deg);
    }

    /* Toggle button used in learning cards for collapsing content */
    .card-toggle{
      background:none;
      border:none;
      font-size:16px;
      cursor:pointer;
      margin-left:auto;
      padding:0;
      line-height:1;
      user-select:none;
    }

    /* Home page layout */
    .home-page{
      display:flex;
      flex-direction:column;
      align-items:center;
      text-align:center;
      padding:40px 20px;
    }
    .home-page h1{
      font-size:28px;
      margin:0 0 16px;
    }
    .home-page p{
      font-size:16px;
      color:var(--muted);
      margin:0 0 24px;
    }
    .home-cats{
      display:flex;
      flex-direction:column;
      gap:12px;
      width:100%;
    }
    .home-cat{
      display:flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      padding:16px 20px;
      border:1.5px solid rgba(255,255,255,.50);
      border-radius:18px;
      background:rgba(255,255,255,.35);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      font-size:17px;
      font-weight:700;
      color:var(--text);
      cursor:pointer;
      box-shadow: 0 8px 24px rgba(80,40,120,.12),
                  inset 0 1px 0 rgba(255,255,255,.6);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .home-cat:hover{
      transform: translateY(-4px) scale(1.01);
      box-shadow: 0 16px 40px rgba(80,40,120,.18),
                  inset 0 1px 0 rgba(255,255,255,.7);
      border-color: rgba(255,255,255,.65);
    }
    .home-cat.glow{
      box-shadow:0 0 24px rgba(183,148,246,0.6),
                  0 8px 32px rgba(183,148,246,0.4),
                  inset 0 1px 0 rgba(255,255,255,.7);
      border-color:rgba(183,148,246,0.7);
      background:rgba(255,255,255,.45);
      animation: glow-pulse 2s ease-in-out infinite;
    }
    @keyframes glow-pulse {
      0%, 100% { box-shadow: 0 0 24px rgba(183,148,246,0.6), 0 8px 32px rgba(183,148,246,0.4), inset 0 1px 0 rgba(255,255,255,.7); }
      50% { box-shadow: 0 0 32px rgba(183,148,246,0.8), 0 12px 40px rgba(183,148,246,0.5), inset 0 1px 0 rgba(255,255,255,.8); }
    }
    .recommendations .rec-content p strong{
      font-weight:700;
    }
    .recommendations .disclaimer{
      font-size:11px;
      color:var(--muted);
      margin-top:8px;
    }
    .table{
      width:100%;
      border-collapse:separate;
      border-spacing:0 6px;
      font-size:12px;
    }
    .table th{
      text-align:left;
      color:var(--text);
      font-weight:700;
      padding:6px 12px;
      font-size:11px;
      letter-spacing: 0.5px;
      text-transform: uppercase;
    }
    .table td{
      padding:10px 14px;
      border:1.5px solid rgba(255,255,255,.40);
      background: rgba(255,255,255,.35);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      border-radius:12px;
      transition: all 0.25s ease;
      box-shadow: 0 1px 4px rgba(80,40,120,.06),
                  inset 0 0.5px 0 rgba(255,255,255,.4);
    }
    .table tr:hover td{
      background: rgba(255,255,255,.50);
      border-color: rgba(255,255,255,.55);
      box-shadow: 0 2px 8px rgba(80,40,120,.10),
                  inset 0 1px 0 rgba(255,255,255,.5);
    }
    .right{text-align:right;}
  </style>
</head>
<body>
<div class="app">
  <header class="topnav">
    <!-- Top navigation header with brand and toggle button -->
    <div class="topnav-header">
      <div class="brand">
        <div style="font-size:18px;line-height:1">üóÇÔ∏è</div>
        <div>
          <h1>Personal Log</h1>
          <p>ÂÅ•Ë∫´„ÉªÊó•Ë®ò„ÉªÂ≠∏Áøí„ÉªÊî∂ÊîØ<br/>Ë≥áÊñôÂÉÖÂ≠òÊñºÊú¨Ê©üÁÄèË¶ΩÂô®</p>
        </div>
      </div>
      <!-- Container for home and nav toggle buttons -->
      <div class="header-controls">
        <!-- Home button to return to the landing page -->
        <button id="homeBtn" class="home-toggle" aria-label="È¶ñÈ†Å">
          <svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true" focusable="false"><path d="M3 10 L12 3 L21 10 V21 H14 V14 H10 V21 H3 Z" fill="none" stroke="currentColor" stroke-width="2" stroke-linejoin="round" stroke-linecap="round"/></svg>
        </button>
        <!-- Hamburger button to collapse or expand navigation; text will toggle via JS -->
        <button id="navToggle" class="nav-toggle" aria-label="ÂàáÊèõÂ∞éËà™">‚ò∞</button>
      </div>
    </div>
    <!-- Collapsible navigation content: nav buttons, actions and hint -->
    <div class="nav-content">
      <div class="nav" id="nav">
        <!-- ÂàùÂßã‰∏çË®≠ÁΩÆ activeÔºåÈ¶ñÊ¨°ËºâÂÖ•ÊôÇÂ∞áÈ†êË®≠È°ØÁ§∫È¶ñÈ†ÅÔºàview-homeÔºâ -->
        <button data-view="fitness"><span class="dot fit"></span> üèãÔ∏è ÂÅ•Ë∫´ <span class="small">Workout</span></button>
        <button data-view="diary"><span class="dot diary"></span> üìì Êó•Ë®ò <span class="small">Diary</span></button>
        <button data-view="learning"><span class="dot learn"></span> üìö Â≠∏Áøí <span class="small">Learning</span></button>
        <button data-view="finance"><span class="dot money"></span> üí∞ Êî∂ÊîØ <span class="small">Finance</span></button>
        <button data-view="overview"><span class="dot overview"></span> üåü Á∏ΩË¶Ω <span class="small">Overview</span></button>
      </div>
      <div class="top-actions">
        <button id="btnExport">ÂåØÂá∫Ë≥áÊñô</button>
        <button id="btnExportImage">ÂåØÂá∫ÂúñÂÉè</button>
        <label for="importFile">ÂåØÂÖ•Ë≥áÊñô<input id="importFile" type="file" accept="application/json"/></label>
        <button id="btnReset" class="danger" style="flex-basis:100%">Ê∏ÖÈô§ÊâÄÊúâË≥áÊñô</button>
      </div>
      <div style="margin-top:8px" class="hint">Âª∫Ë≠∞ÔºöÂÅ∂ÁàæÂåØÂá∫ÂÇô‰ªΩ„ÄÇËã•Ê∏ÖÈô§ÁÄèË¶ΩÂô®Ë≥áÊñôÔºåÊú¨Á∂≤Á´ôË®òÈåÑ‰πüÊúÉ‰∏Ä‰ΩµÊ∂àÂ§±„ÄÇ</div>
    </div>
  </header>
  <main class="main">
    <div id="view-fitness" class="view"></div>
    <div id="view-diary" class="view" style="display:none"></div>
    <div id="view-learning" class="view" style="display:none"></div>
    <div id="view-finance" class="view" style="display:none"></div>
    <div id="view-overview" class="view" style="display:none"></div>
    <div id="view-home" class="view" style="display:none"></div>
  </main>

  <!-- Export Image Modal -->
  <div id="exportImageModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000; align-items:center; justify-content:center;">
    <div style="background:#fffaf5; border-radius:12px; padding:16px; width:90%; max-width:340px; box-shadow: var(--shadow2);">
      <h3 style="margin-top:0; font-size:16px;">ÈÅ∏ÊìáÂúñÂÉèÂåØÂá∫ÂàÜÈ°û</h3>
      <div style="display:flex; flex-direction:column; gap:8px; margin-bottom:12px;">
        <label style="display:flex; align-items:center; gap:6px;">
          <input type="checkbox" id="export_all" /> <span>ÂÖ®ÈÅ∏</span>
        </label>
        <label style="display:flex; align-items:center; gap:6px;">
          <input type="checkbox" class="export-cat" value="fitness" /> <span>ÂÅ•Ë∫´</span>
        </label>
        <label style="display:flex; align-items:center; gap:6px;">
          <input type="checkbox" class="export-cat" value="diary" /> <span>Êó•Ë®ò</span>
        </label>
        <label style="display:flex; align-items:center; gap:6px;">
          <input type="checkbox" class="export-cat" value="learning" /> <span>Â≠∏Áøí</span>
        </label>
        <label style="display:flex; align-items:center; gap:6px;">
          <input type="checkbox" class="export-cat" value="finance" /> <span>Êî∂ÊîØ</span>
        </label>
      </div>
      <div style="display:flex; gap:10px; justify-content:flex-end;">
        <button id="exportImageCancel" class="btn" style="padding:6px 12px; border:1px solid var(--border); border-radius:10px; background: rgba(255,255,255,.60);">ÂèñÊ∂à</button>
        <button id="exportImageConfirm" class="btn primary" style="padding:6px 12px; border:1px solid rgba(210,121,74,.35); border-radius:10px; background: rgba(210,121,74,.18);">ÂåØÂá∫</button>
      </div>
    </div>
  </div>
</div>

<script>
/* =========================
   Local Storage & State Management
   This mobile version stores all records in the browser's LocalStorage. Each
   category is stored as an array under a single key. There is no remote
   synchronisation.
========================= */
const STORAGE_KEY = 'personal_log_mobile_v1';
const defaultState = () => ({ workouts: [], diaries: [], learnings: [], transactions: [], subscriptions: [] });
let state = defaultState();
function saveStateLocal(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }
function loadStateLocal(){ try{ const raw = localStorage.getItem(STORAGE_KEY); if(!raw) return defaultState(); const parsed = JSON.parse(raw); return Object.assign(defaultState(), parsed); }catch(e){ return defaultState(); }}

/* =========================
   Utilities
========================= */
function uid(prefix='id'){ return prefix + '_' + Math.random().toString(16).slice(2) + '_' + Date.now().toString(16); }
function pad2(n){ return String(n).padStart(2,'0'); }
function toISODate(d){ const y=d.getFullYear(), m=pad2(d.getMonth()+1), day=pad2(d.getDate()); return `${y}-${m}-${day}`; }
function toMonthKey(dateStr){ const d=new Date(dateStr); const y=d.getFullYear(), m=pad2(d.getMonth()+1); return `${y}-${m}`; }
function fmtDateTime(dateStr){ const d=new Date(dateStr); if(Number.isNaN(d.getTime())) return dateStr; return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())} ${pad2(d.getHours())}:${pad2(d.getMinutes())}`; }
function fmtMinutes(min){ const h=Math.floor(min/60); const m=min%60; if(h<=0) return `${m} ÂàÜ`; if(m===0) return `${h} Â∞èÊôÇ`; return `${h} Â∞èÊôÇ ${m} ÂàÜ`; }
function diffMinutes(startHHMM,endHHMM){ const [sh,sm]=startHHMM.split(':').map(Number); const [eh,em]=endHHMM.split(':').map(Number); let start=sh*60+sm; let end=eh*60+em; if(end<start) end+=24*60; return end-start; }

/*
  Fallback stubs for external libraries
  ------------------------------------
  When this site is opened without an internet connection, the external
  scripts for Chart.js and Markmap may fail to load, leaving the
  constructors undefined. Accessing an undefined `Chart` or
  `markmap` will throw errors and prevent the rest of the application
  from running, resulting in an empty interface. To guard against this,
  we define lightweight stubs when these globals are missing. The stubs
  implement the minimal API used by this app (returning objects with
  no‚Äëop methods) so that chart and mind map rendering calls do not
  throw. When the real libraries are available, these stubs are
  automatically ignored.
*/
if(typeof window.Chart === 'undefined'){
  window.Chart = function(){
    return {
      destroy(){},
      update(){},
      // ensure charts can be referenced safely
      data:{},
      options:{}
    };
  };
}
if(typeof window.markmap === 'undefined'){
  window.markmap = {
    Transformer: function(){
      return {
        transform(){ return { root: {} }; }
      };
    },
    Markmap: {
      create(){ return {}; }
    }
  };
}
function sum(arr){ return arr.reduce((a,b)=>a+b,0); }
function groupBy(arr,keyFn){ return arr.reduce((acc,x)=>{ const k=keyFn(x); (acc[k] ||= []).push(x); return acc; },{}); }
function escapeHtml(str){ return String(str).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'",'&#39;'); }

/* =========================
   Visited tracking (per day)
   Store which categories the user has opened today to highlight others on the home page.
========================= */
let visitedDate = {};
function loadVisitedDate(){
  try{
    const raw = localStorage.getItem('visitedDate');
    visitedDate = raw ? JSON.parse(raw) : {};
  }catch(e){ visitedDate = {}; }
}
function saveVisitedDate(){
  try{
    localStorage.setItem('visitedDate', JSON.stringify(visitedDate));
  }catch(e){}
}
function updateVisited(view){
  // record that the given view has been visited today
  const today = toISODate(new Date());
  visitedDate[view] = today;
  saveVisitedDate();
}

/* =========================
   Update tracking (per category)
   Determine whether a category has been updated (i.e. a record created) today.
   Used to decide whether to apply the glow highlight on the home page buttons.
========================= */
function hasUpdatesToday(view){
  const today = toISODate(new Date());
  try{
    if(view === 'fitness'){
      return (state.workouts || []).some(w => w.date === today);
    }
    if(view === 'diary'){
      return (state.diaries || []).some(d => {
        const dt = new Date(d.time);
        return !Number.isNaN(dt.getTime()) && dt.toISOString().slice(0,10) === today;
      });
    }
    if(view === 'learning'){
      return (state.learnings || []).some(l => l.date === today);
    }
    if(view === 'finance'){
      return (state.transactions || []).some(t => t.date === today);
    }
    if(view === 'overview'){
      // Overview is considered updated only if all categories have updates
      return hasUpdatesToday('fitness') && hasUpdatesToday('diary') && hasUpdatesToday('learning') && hasUpdatesToday('finance');
    }
  }catch(e){ /* ignore */ }
  return false;
}

/* =========================
   Navigation & Top Controls
========================= */
// Current view tracking for mobile navigation
let currentView = 'home';

// Function to switch view
function switchToView(view, pushState = true){
  if(view === currentView) return;

  currentView = view;

  // record visited state (excluding home which has no nav button)
  if(view !== 'home') updateVisited(view);

  // set active nav button
  const targetBtn = document.querySelector(`.nav button[data-view="${view}"]`);
  document.querySelectorAll('.nav button').forEach(b=> b.classList.toggle('active', b===targetBtn));

  // hide all views including home
  document.querySelectorAll('.view').forEach(v=> v.style.display='none');

  // show selected view (home is also view-home)
  const viewEl = document.getElementById('view-'+view);
  if(viewEl) viewEl.style.display='block';

  // update page
  renderAll();

  // Push state to history for mobile back button support
  if(pushState){
    history.pushState({ view: view }, '', `#${view}`);
  }
}

// Handle browser/mobile back button
window.addEventListener('popstate', (e)=>{
  if(e.state && e.state.view){
    switchToView(e.state.view, false);
  }else{
    // Default to home if no state
    switchToView('home', false);
  }
});

// Initialize first state
history.replaceState({ view: 'home' }, '', '#home');

const nav = document.getElementById('nav');
nav.addEventListener('click', (e)=>{
  const btn = e.target.closest('button[data-view]');
  if(!btn) return;
  const view = btn.dataset.view;
  switchToView(view);
});

document.getElementById('btnExport').addEventListener('click', ()=>{
  const blob = new Blob([JSON.stringify(state,null,2)], {type:'application/json'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `personal_log_mobile_backup_${toISODate(new Date())}.json`;
  a.click();
  URL.revokeObjectURL(a.href);
});

document.getElementById('importFile').addEventListener('change', async (e)=>{
  const f = e.target.files?.[0];
  if(!f) return;
  try{
    const text = await f.text();
    const imported = JSON.parse(text);
    state = Object.assign(defaultState(), imported);
    saveStateLocal();
    renderAll();
    alert('ÂåØÂÖ•ÂÆåÊàê');
  }catch(err){ alert('ÂåØÂÖ•Â§±ÊïóÔºöÊ™îÊ°àÊ†ºÂºè‰∏çÊ≠£Á¢∫'); }
  finally{ e.target.value=''; }
});

document.getElementById('btnReset').addEventListener('click', ()=>{
  if(!confirm('Á¢∫ÂÆöË¶ÅÊ∏ÖÈô§ÊâÄÊúâË≥áÊñôÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÈÇÑÂéü„ÄÇ')) return;
  state = defaultState();
  saveStateLocal();
  renderAll();
});

// =========================
//   Export Image Feature
// =========================
document.getElementById('btnExportImage').addEventListener('click', ()=>{
  // Show modal and reset selections
  const modal = document.getElementById('exportImageModal');
  modal.style.display = 'flex';
  document.getElementById('export_all').checked = false;
  modal.querySelectorAll('.export-cat').forEach(ch => ch.checked = false);
});
// "Select All" checkbox toggles all categories
document.getElementById('export_all').addEventListener('change', (e)=>{
  const checked = e.target.checked;
  document.querySelectorAll('#exportImageModal .export-cat').forEach(ch => ch.checked = checked);
});
// Cancel export: hide modal
document.getElementById('exportImageCancel').addEventListener('click', ()=>{
  document.getElementById('exportImageModal').style.display = 'none';
});
// Confirm export: gather selected categories and export images
document.getElementById('exportImageConfirm').addEventListener('click', ()=>{
  const cats = [];
  document.querySelectorAll('#exportImageModal .export-cat:checked').forEach(ch => cats.push(ch.value));
  document.getElementById('exportImageModal').style.display = 'none';
  if(cats.length === 0){ alert('Ë´ãËá≥Â∞ëÈÅ∏Êìá‰∏ÄÂÄãÂàÜÈ°û'); return; }
  exportSelectedImages(cats);
});

function downloadURI(uri, name){
  const a = document.createElement('a');
  a.href = uri;
  a.download = name;
  a.click();
}
async function exportSelectedImages(cats){
  const date = toISODate(new Date());
  const tasks = [];
  // Export fitness chart as is
  if(cats.includes('fitness') && fitnessLineChart){
    try{
      const uri = fitnessLineChart.toBase64Image();
      downloadURI(uri, `fitness_chart_${date}.png`);
    }catch(err){ console.warn(err); }
  }
  // Export finance charts with details
  if(cats.includes('finance')){
    if(expensePie){ tasks.push(exportPieWithDetails('expense', `finance_expense_pie_${date}.png`)); }
    if(incomePie){ tasks.push(exportPieWithDetails('income', `finance_income_pie_${date}.png`)); }
  }
  // Wait for all async exports
  if(tasks.length){ await Promise.all(tasks); }
  // Notify for categories without charts
  const noChart = cats.filter(c => c === 'diary' || c === 'learning');
  if(noChart.length > 0){
    alert('ÊâÄÈÅ∏ÂàÜÈ°ûÔºà' + noChart.join('„ÄÅ') + 'ÔºâÁõÆÂâçÊ≤íÊúâÂúñË°®ÂèØ‰ª•ÂåØÂá∫„ÄÇ');
  }
}

// Helper: export pie chart with its details appended on the right.
function exportPieWithDetails(type, filename){
  return new Promise((resolve)=>{
    let chart = null;
    if(type === 'expense'){ chart = expensePie; }
    else if(type === 'income'){ chart = incomePie; }
    if(!chart){ resolve(); return; }
    const canvas = chart.canvas; // Chart.js instance exposes the underlying canvas
    const cw = canvas.width;
    const ch = canvas.height;
    // Compute details for this type from current state
    const items = state.transactions.filter(t => t.type === type);
    const byCat = groupBy(items, t => t.category);
    const labels = Object.keys(byCat).sort((a,b)=> a.localeCompare(b, 'zh-Hant'));
    const data = labels.map(l => sum(byCat[l].map(x => x.amount)));
    const total = data.reduce((a,b)=> a+b, 0) || 1;
    const detailLines = labels.map((lbl,i) => {
      const val = data[i];
      const perc = ((val/total)*100).toFixed(1);
      return `${lbl}: ${val} (${perc}%)`;
    });
    // Prepare new canvas: left half for chart, right half for details (50/50 split)
    const newCanvas = document.createElement('canvas');
    newCanvas.width = cw * 2;
    newCanvas.height = ch;
    const ctx = newCanvas.getContext('2d');
    // Fill background with white to avoid transparent background
    ctx.fillStyle = '#ffffff';
    ctx.fillRect(0, 0, newCanvas.width, newCanvas.height);
    const img = new Image();
    img.onload = function(){
      // Draw original chart in left half
      ctx.drawImage(img, 0, 0, cw, ch);
      // Draw details text occupying right half
      ctx.font = 'bold 20px sans-serif';
      ctx.fillStyle = '#000000';
      // Start drawing a bit lower to account for larger font
      let y = 50;
      const startX = cw + 20;
      const lineHeight = 34;
      detailLines.forEach(line => {
        ctx.fillText(line, startX, y);
        y += lineHeight;
      });
      const uri = newCanvas.toDataURL('image/png');
      downloadURI(uri, filename);
      resolve();
    };
    // Use Chart.js API to get image; fallback to canvas.toDataURL
    try{
      img.src = chart.toBase64Image();
    }catch(err){
      img.src = canvas.toDataURL('image/png');
    }
  });
}

/* =========================
   Recommendations
   This section generates simple next‚Äëstep suggestions for each category
   based on the user's existing data. Suggestions are categorised by
   timeframe (day/week/month) and can be collapsed to save space.
========================= */
let recCollapsed = {};
function loadRecCollapsed(){
  try{
    const raw = localStorage.getItem('recCollapsed');
    recCollapsed = raw ? JSON.parse(raw) : {};
  }catch(e){ recCollapsed = {}; }
}
function saveRecCollapsed(){
  localStorage.setItem('recCollapsed', JSON.stringify(recCollapsed));
}
function getRecommendations(view){
  const rec = { day:'', week:'', month:'' };
  if(view === 'fitness'){
    const items = state.workouts || [];
    if(items.length === 0){
      rec.day = 'ÈñãÂßãË®òÈåÑ‰Ω†ÁöÑÁ¨¨‰∏ÄÁ≠ÜÂÅ•Ë∫´Ë®ìÁ∑¥Âêß„ÄÇ';
      rec.week = 'Ë®àÂäÉÊØèÈÄ±Ëá≥Â∞ë 2‚Äì3 Ê¨°Ë®ìÁ∑¥Ôºå‰∏¶Ë®òÈåÑÊØèÊ¨°ÊàêÊûú„ÄÇ';
      rec.month = 'ÁÇ∫‰∏ãÂÄãÊúàË®≠ÂÆöË®ìÁ∑¥ÁõÆÊ®ôÔºå‰æãÂ¶ÇÂÆåÊàê 10 Ê¨°Ë®ìÁ∑¥ÊàñÊèêÈ´òÈáçÈáè„ÄÇ';
    }else{
      const last = items[0];
      const lastWeight = last.weight || 0;
      rec.day = `ÊúÄËøëË®ìÁ∑¥ÈáçÈáèÁÇ∫ ${lastWeight} kgÔºåË´ãÊ≥®ÊÑèÂßøÂã¢‰∏¶ÈÅ©Â∫¶Â¢ûÂä†ÊàñÁ∂≠ÊåÅÂº∑Â∫¶„ÄÇ`;
      const now = new Date();
      const weekAgo = new Date();
      weekAgo.setDate(now.getDate() - 7);
      const countWeek = items.filter(w => new Date(w.date) >= weekAgo).length;
      const targetWeek = Math.max(3, countWeek);
      rec.week = `ÈÅéÂéª‰∏ÄÈÄ±‰Ω†Ë®òÈåÑ‰∫Ü ${countWeek} Ê¨°Ë®ìÁ∑¥„ÄÇÊú¨ÈÄ±Âª∫Ë≠∞ÂÆâÊéíÁ¥Ñ ${targetWeek} Ê¨°ÔºåÊåÅÁ∫åÈ§äÊàêÁøíÊÖ£„ÄÇ`;
      rec.month = 'ÊåÅÁ∫åÊØèÊúàË®ìÁ∑¥‰∏¶ÂòóË©¶ÊåëÊà∞Êñ∞ÁöÑÈáçÈáèÊàñÂãï‰ΩúÔºåÊ≥®ÊÑèÂæ™Â∫èÊº∏ÈÄ≤ÈÅøÂÖçÂèóÂÇ∑„ÄÇ';
    }
  }else if(view === 'diary'){
    const items = state.diaries || [];
    if(items.length === 0){
      rec.day = 'ÂØ´‰∏ã‰ªäÂ§©ÁöÑÂøÉÊÉÖÊàñÂÄºÂæóÊÑüÊøÄÁöÑ‰∫ãÊÉÖÔºåÈñãÂßã‰Ω†ÁöÑÊó•Ë®òÊóÖÁ®ã„ÄÇ';
      rec.week = 'Êú¨ÈÄ±Ë©¶ËëóÊØèÂ§©Ë®òÈåÑÂøÉÊÉÖÔºåËßÄÂØüÊÉÖÁ∑íÁöÑËµ∑‰ºèËàáËß∏ÁôºÂõ†Á¥†„ÄÇ';
      rec.month = 'ÊØèÊúàÂõûÈ°ßÊó•Ë®ò‰∏¶Á∏ΩÁµêËá™Â∑±ÁöÑÊÑüÂèóËàáÊàêÈï∑Ôºå‰ΩúÁÇ∫ÂèçÊÄùÁ¥†Êùê„ÄÇ';
    }else{
      rec.day = '‰ªäÂ§©‰πüÂà•Âøò‰∫ÜË®òÈåÑÂøÉÊÉÖÂíåÁ∂ìÊ≠∑Ôºå‰øùÊåÅÂØ´Êó•Ë®òÁöÑÁøíÊÖ£„ÄÇ';
      rec.week = 'ÂõûÈ°ßÊú¨ÈÄ±ÁöÑÊó•Ë®òÔºåÊâæÂá∫ËÆì‰Ω†ÈñãÂøÉÊàñÂ£ìÂäõÁöÑ‰æÜÊ∫ê‰∏¶Ë™øÊï¥ÁîüÊ¥ª„ÄÇ';
      rec.month = 'Êï¥ÁêÜÈÅéÂéª‰∏ÄÂÄãÊúàÁöÑÊó•Ë®òÔºåÁ∏ΩÁµêÂ≠∏Âà∞ÁöÑÁ∂ìÈ©óÔºåË™øÊï¥‰∏ãÂÄãÊúàÁöÑÁõÆÊ®ô„ÄÇ';
    }
  }else if(view === 'learning'){
    const items = state.learnings || [];
    if(items.length === 0){
      rec.day = 'ÊåëÈÅ∏‰∏ÄÂÄãÊÉ≥Â≠∏ÁöÑ‰∏ªÈ°åÔºåË®òÈåÑÁ¨¨‰∏ÄÁ≠ÜÂ≠∏ÁøíÂÖßÂÆπ„ÄÇ';
      rec.week = 'Ë®≠ÂÆöÊú¨ÈÄ±ÁöÑÂ≠∏ÁøíË®àÁï´ÔºåÂÆâÊéíÂõ∫ÂÆöÁöÑÂ≠∏ÁøíÊôÇÈñì‰∏¶Ë®òÈåÑÈáçÈªû„ÄÇ';
      rec.month = '‰∏ãÂÄãÊúàÊåëÊà∞Êñ∞ÁöÑ‰∏ªÈ°åÊàñÊõ¥Ê∑±ÂÖ•ÁöÑÂÖßÂÆπÔºå‰∏¶Êõ¥Êñ∞ÂøÉÊô∫Âúñ„ÄÇ';
    }else{
      const last = items[0];
      rec.day = `Ë§áÁøíÊúÄËøëÂ≠∏ÁøíÁöÑ„Äå${last.title}„ÄçÔºåË©¶ËëóÁî®Ëá™Â∑±ÁöÑË©±Êï¥ÁêÜÈáçÈªû„ÄÇ`;
      rec.week = 'Êú¨ÈÄ±ÁÇ∫ÁõÆÂâçÁöÑÁßëÁõÆÂÆâÊéíÂ≠∏ÁøíË®àÁï´Ôºå‰øùÊåÅÊØèÈÄ±Ëá≥Â∞ëÂπæÊ¨°ÁöÑÁ∑¥ÁøíÊàñÈñ±ËÆÄ„ÄÇ';
      rec.month = 'ÊØèÊúàÊõ¥Êñ∞ÂøÉÊô∫ÂúñÔºåÊ¢≥ÁêÜÂ∑≤Â≠∏ÂÖßÂÆπÔºåË¶èÂäÉ‰∏ã‰∏ÄÊ≠•Â≠∏ÁøíË∑ØÂæë„ÄÇ';
    }
  }else if(view === 'finance'){
    const items = state.transactions || [];
    if(items.length === 0){
      rec.day = 'Ë®òÈåÑÁ¨¨‰∏ÄÁ≠ÜÊî∂ÊîØÔºåÈñãÂßãÊéåÊè°Ëá™Â∑±ÁöÑË≤°ÂãôÊÉÖÊ≥Å„ÄÇ';
      rec.week = 'Âà∂ÂÆöÊú¨ÈÄ±ÁöÑÈ†êÁÆóÔºå‰∏¶Ë®òÈåÑÊØè‰∏ÄÁ≠ÜËä±Ë≤ª‰ª•‰æøÊ™¢Ë¶ñ„ÄÇ';
      rec.month = 'Ë®≠ÂÆöÊú¨ÊúàÂÑ≤ËìÑÁõÆÊ®ô‰∏¶Ê™¢Ë¶ñ‰∏ªË¶ÅÊîØÂá∫ÂàÜÈ°ûÔºåË™øÊï¥Ê∂àË≤ªÁøíÊÖ£„ÄÇ';
    }else{
      // find largest expense category for next‚Äëday suggestion
      const expenses = items.filter(t => t.type === 'expense');
      let biggestCat = '';
      if(expenses.length > 0){
        const byCat = groupBy(expenses, t => t.category);
        let maxVal = 0;
        for(const cat in byCat){
          const sumVal = byCat[cat].reduce((a,b)=> a + b.amount, 0);
          if(sumVal > maxVal){ maxVal = sumVal; biggestCat = cat; }
        }
      }
      rec.day = biggestCat ? `Ê≥®ÊÑèÊéßÂà∂„Äå${biggestCat}„ÄçÈ°ûÂûãÁöÑÊîØÂá∫Ôºå‰ªäÂ§©ÂèØ‰ª•Ë©¶ËëóÊ∏õÂ∞ë‰∏çÂøÖË¶ÅÈñãÈä∑„ÄÇ` : '‰ªäÂ§©Ë®òÈåÑ‰Ω†ÁöÑËä±Ë≤ªÔºåÂØ©Ë¶ñÂøÖË¶ÅËàáÈùûÂøÖË¶ÅÊîØÂá∫„ÄÇ';
      // compute weekly total expenses
      const now = new Date();
      const weekAgo = new Date(); weekAgo.setDate(now.getDate() - 7);
      const weekExpenses = expenses.filter(t => new Date(t.date) >= weekAgo);
      const weekTotal = weekExpenses.reduce((a,b)=> a + b.amount, 0);
      rec.week = `ÈÅéÂéª‰∏ÄÈÄ±‰∏ªË¶ÅÊîØÂá∫Á∏ΩÈ°çÁÇ∫ ${weekTotal}„ÄÇÂª∫Ë≠∞Ë®≠ÂÆöÊØèÈÄ±ÊîØÂá∫‰∏äÈôêÔºåÊ™¢Ë¶ñÊúÄÂ§ßÁöÑËä±Ë≤ªÂàÜÈ°û„ÄÇ`;
      const totalExpense = expenses.reduce((a,b)=> a + b.amount, 0);
      rec.month = `Êú¨ÊúàÊîØÂá∫Á¥ØË®à ${totalExpense}„ÄÇËÄÉÊÖÆË®≠Á´ãÂÑ≤ËìÑÁõÆÊ®ôÔºå‰∏¶ÊÄùËÄÉ‰∏ãÊúàÂ¶Ç‰ΩïÂÑ™ÂåñÈ†êÁÆóÁµêÊßã„ÄÇ`;
    }
  } else if(view === 'overview'){
    /*
      For the overview page, we generate high‚Äëlevel suggestions that reflect
      the interplay between the four categories. We compute some basic
      metrics from the data and craft recommendations accordingly. The
      suggestions are separated by timeframe (day/week/month). Because this
      is a client‚Äëside app, we rely on simple heuristics rather than
      machine learning: counts of recent workouts, mood distributions,
      learning frequency and net finance balance are used to derive advice.
    */
    // Helper to compute the number of workouts in the past 7 days
    const now = new Date();
    const weekAgo = new Date(); weekAgo.setDate(now.getDate() - 7);
    const workoutsWeek = (state.workouts || []).filter(w => new Date(w.date) >= weekAgo).length;
    // Compute mood distribution in the past 7 days
    const diaryWeek = (state.diaries || []).filter(d => new Date(d.time) >= weekAgo);
    const moodCounts = {};
    diaryWeek.forEach(d => { moodCounts[d.mood] = (moodCounts[d.mood] || 0) + 1; });
    const totalDiaryWeek = diaryWeek.length || 1;
    // Determine negative mood ratio
    const negativeMoods = ['ÁÑ¶ÊÖÆ','‰ΩéËêΩ','ÊÜ§ÊÄí','Áñ≤ÂÄ¶','ÂÖ∂‰ªñ'];
    let negativeCount = 0;
    negativeMoods.forEach(m => { negativeCount += (moodCounts[m] || 0); });
    const negRatio = negativeCount / totalDiaryWeek;
    // Compute learning frequency in the past 7 days
    const learnWeek = (state.learnings || []).filter(l => new Date(l.date) >= weekAgo).length;
    // Compute finance balance for the past 30 days
    const monthAgo = new Date(); monthAgo.setDate(now.getDate() - 30);
    let incomeMonth = 0, expenseMonth = 0;
    (state.transactions || []).forEach(t => {
      const dt = new Date(t.date);
      if(dt >= monthAgo){
        if(t.type === 'income') incomeMonth += t.amount;
        else if(t.type === 'expense') expenseMonth += t.amount;
      }
    });
    const netMonth = incomeMonth - expenseMonth;
    // Build suggestions reflecting interplay between categories
    // Day: encourage small actions today based on current metrics.  When multiple
    // categories lag, suggest how‰∏Ä improvements in one mayÂΩ±Èüø others.
    const dayParts = [];
    if(workoutsWeek < 2) {
      dayParts.push('ÂÆâÊéí‰∏ÄÊ¨°Á∞°Áü≠ÁöÑÈÅãÂãïÔºåÊúâÂä©ÊñºÊèêÂçáÂøÉÊÉÖ‰∏¶Á∂≠ÊåÅÈ´îËÉΩ');
      if(negRatio > 0.5) dayParts.push('Â§öÈÅãÂãïÊúâÂä©ÊñºÊ∏õËºïË≤†Èù¢ÊÉÖÁ∑í');
    }
    if(negRatio > 0.5 && workoutsWeek >= 2) dayParts.push('ÂØ´‰∏ã‰ªäÂ§©ÁöÑÊÑüÂèóÔºå‰∏¶ÈÄèÈÅéÈÅãÂãïÊàñÈñ±ËÆÄ‰æÜÁ¥ìÂ£ì');
    if(learnWeek < 1) {
      dayParts.push('ÊäΩÁ©∫Èñ±ËÆÄÊàñË®òÈåÑ‰∏ÄÂâáÊñ∞Áü•Ë≠ò');
      if(netMonth < 0) dayParts.push('Â¢ûÂº∑ÊäÄËÉΩÂ∞áÊúâÂä©ÊñºÊîπÂñÑË≤°Âãô');
    }
    if(netMonth < 0 && learnWeek >= 1) dayParts.push('‰ªäÂ§©Áõ°ÈáèÈÅøÂÖç‰∏çÂøÖË¶ÅÁöÑÈñãÈä∑');
    rec.day = dayParts.length ? dayParts.join('Ôºõ') + '„ÄÇ' : 'ÊÅ≠ÂñúÔºÅ‰ªäÊó•ÂêÑÈ†ÖË®òÈåÑÂùáË°°Ôºå‰øùÊåÅËâØÂ•ΩÁøíÊÖ£„ÄÇ';
    // Week: summarise and reflect patterns from the past week and highlight cross‚Äëcategory influences
    const weekParts = [];
    weekParts.push(`ÈÅéÂéª‰∏ÄÈÄ±ÂÖ±Ë®òÈåÑË®ìÁ∑¥ ${workoutsWeek} Ê¨°`);
    weekParts.push(`Ë®òÈåÑÊó•Ë®ò ${diaryWeek.length} ÂâáÔºåÂÖ∂‰∏≠ÊÉÖÁ∑íÂÅèË≤†Èù¢ÊØî‰æãÁÇ∫ ${(negRatio*100).toFixed(0)}%`);
    weekParts.push(`Â≠∏ÁøíÁ¥ÄÈåÑ ${learnWeek} Á≠Ü`);
    weekParts.push(`Êú¨ÊúàÊî∂ÊîØÂ∑ÆÈ°ç ${netMonth}`);
    // Cross‚Äëcategory reflections
    if(workoutsWeek < 2 && negRatio > 0.5) weekParts.push('ÈÅãÂãï‰∏çË∂≥ËàáË≤†Èù¢ÊÉÖÁ∑íÂèØËÉΩ‰∫íÊúâÂΩ±ÈüøÔºåÂª∫Ë≠∞Êú¨ÈÄ±Â¢ûÂä†Ê¥ªÂãïÈáè');
    if(learnWeek < 1 && netMonth < 0) weekParts.push('Â≠∏ÁøíÊäïÂÖ•ÂÅè‰ΩéËàáË≤°ÂãôÂ£ìÂäõÂèØËÉΩÁõ∏ÈóúÔºåÂª∫Ë≠∞Ê™¢Ë¶ñÊäÄËÉΩÊäïË≥á');
    if(netMonth < 0 && negRatio > 0.5) weekParts.push('Ë≤°ÂãôÂ£ìÂäõÂèØËÉΩÂΩ±ÈüøÊÉÖÁ∑íÔºåÂèØÂòóË©¶Âà∂ÂÆöÈ†êÁÆó‰∏¶Â∞ãÊ±ÇÊ∏õÂ£ìÊñπÊ≥ï');
    weekParts.push('Âª∫Ë≠∞Êú¨ÈÄ±ÂõûÈ°ß‰ª•‰∏äÊï∏ÊìöÔºåÊâæÂá∫ÈúÄË¶ÅË™øÊï¥ÁöÑÈ†òÂüü');
    rec.week = weekParts.join('Ôºõ') + '„ÄÇ';
    // Month: set longer‚Äëterm adjustments and goals focusing on balance across categories
    const monthParts = [];
    monthParts.push('Á∂úÂêàÂÅ•Ë∫´„ÄÅÊó•Ë®ò„ÄÅÂ≠∏Áøí„ÄÅÊî∂ÊîØË≥áÊñôÔºåË©ï‰º∞ÂêÑÈ†ÖÊòØÂê¶Âπ≥Ë°°');
    if(workoutsWeek < 2) monthParts.push('‰∏ãÊúàÂèØË®≠ÂÆöÊØèÈÄ±Ëá≥Â∞ë 2 Ê¨°Ë®ìÁ∑¥ÁõÆÊ®ô');
    if(negRatio > 0.5) monthParts.push('ÊåÅÁ∫åÊé¢Á¥¢Ê≠£ÂêëÁ¥ìÂ£ìÊñπÂºèÔºåÂ¶ÇÈÅãÂãï„ÄÅÈñ±ËÆÄÊàñÂÜ•ÊÉ≥');
    if(learnWeek < 2) monthParts.push('Ë¶èÂäÉ‰∏ÄÂÄãÊñ∞ÁöÑÂ≠∏Áøí‰∏ªÈ°åÊàñÊäÄËÉΩÔºåÊèêÂçáËá™ÊàëÂÉπÂÄº');
    if(netMonth < 0) monthParts.push('Ê™¢Ë®éÈ†êÁÆó‰∏¶Ë®ÇÂÆöÂÑ≤ËìÑÁõÆÊ®ôÔºå‰ª•Ê∏õÂ∞ëË≤°ÂãôÂ£ìÂäõ');
    // Additional cross‚Äëcategory goals
    if(workoutsWeek < 2 && learnWeek < 2) monthParts.push('ÂòóË©¶Â∞áÂÅ•Ë∫´ËàáÂ≠∏ÁøíÁµêÂêàÔºå‰æãÂ¶ÇÊî∂ËÅΩÂÅ•Ë∫´ÊàñÁêÜË≤°Áõ∏ÈóúÁöÑÊïôÊùê');
    rec.month = monthParts.join('Ôºõ') + '„ÄÇ';
  }
  return rec;
}
function renderRecommendations(view){
  const root = document.getElementById('view-' + view);
  if(!root) return;
  // remove existing recommendations for this view
  const old = root.querySelector('.recommendations');
  if(old) old.remove();
  const recs = getRecommendations(view);
  const collapsed = recCollapsed[view] === true;
  // Build container
  const container = document.createElement('div');
  container.className = 'recommendations' + (collapsed ? ' collapsed' : '');
  container.setAttribute('data-view', view);
  const arrowChar = collapsed ? '‚ñ∂' : '‚ñº';
  container.innerHTML = `\
    <button class="rec-toggle">${arrowChar} Ë°åÂãïÂª∫Ë≠∞</button>\
    <div class="rec-content">\
      <p><strong>1Â§©Ôºö</strong>${escapeHtml(recs.day)}</p>\
      <p><strong>1ÈÄ±Ôºö</strong>${escapeHtml(recs.week)}</p>\
      <p><strong>1ÂÄãÊúàÔºö</strong>${escapeHtml(recs.month)}</p>\
      <p class="disclaimer">‰ª•‰∏äÂª∫Ë≠∞Áî±Á≥ªÁµ±‰æùÊìöË®òÈåÑËá™ÂãïÁî¢ÁîüÔºåÂÉÖ‰æõÂèÉËÄÉ„ÄÇ</p>\
    </div>`;
  // Toggle collapse on click
  container.querySelector('.rec-toggle').addEventListener('click', ()=>{
    const isCollapsed = !container.classList.contains('collapsed');
    container.classList.toggle('collapsed', isCollapsed);
    const newArrow = isCollapsed ? '‚ñ∂' : '‚ñº';
    container.querySelector('.rec-toggle').textContent = `${newArrow} Ë°åÂãïÂª∫Ë≠∞`;
    recCollapsed[view] = isCollapsed;
    saveRecCollapsed();
  });
  root.appendChild(container);
}

/* =========================
   Collapsible Card Utility
   This helper rewrites each .card inside the given view to support
   collapsible headers. Cards that already contain a .card-header are
   skipped. The arrow rotates based on the collapsed state. Toggling
   simply adds or removes the 'collapsed' class on the card element.
========================= */
function applyCardCollapse(view){
  const root = document.getElementById('view-' + view);
  if(!root) return;
  const cards = root.querySelectorAll('.card');
  cards.forEach(card => {
    // Skip if already transformed
    if(card.querySelector('.card-header')) return;
    const titleEl = card.querySelector('h3');
    if(!titleEl) return;
    // Create header and arrow
    const header = document.createElement('div');
    header.className = 'card-header';
    const arrow = document.createElement('span');
    arrow.className = 'card-arrow';
    arrow.textContent = '‚ñº';
    // Move title element into header
    header.appendChild(titleEl);
    header.appendChild(arrow);
    // Create body and move remaining child nodes
    const body = document.createElement('div');
    body.className = 'card-body';
    while(card.firstChild){
      const node = card.firstChild;
      if(node !== header){
        body.appendChild(node);
      } else {
        break;
      }
    }
    // Empty original card and append header and body
    card.innerHTML = '';
    card.appendChild(header);
    card.appendChild(body);
    // Click toggle
    header.addEventListener('click', () => {
      const collapsed = card.classList.toggle('collapsed');
      arrow.textContent = collapsed ? '‚ñ∂' : '‚ñº';
      // Explicitly hide or show the card body to ensure collapse works
      if (collapsed) {
        body.style.display = 'none';
      } else {
        body.style.display = '';
      }
    });
  });
}

/* =========================
   Home Page Rendering
   The landing page presents a friendly prompt and category buttons. Categories
   not visited today receive a glowing highlight. Clicking a button opens the
   corresponding view and records the visit.
========================= */
function renderHome(){
  const root = document.getElementById('view-home');
  if(!root) return;
  // Determine today's date for highlighting
  const today = toISODate(new Date());
  // Build HTML
  const cats = [
    {view:'fitness', icon:'üèãÔ∏è', label:'ÂÅ•Ë∫´'},
    {view:'diary', icon:'üìì', label:'Êó•Ë®ò'},
    {view:'learning', icon:'üìö', label:'Â≠∏Áøí'},
    {view:'finance', icon:'üí∞', label:'Êî∂ÊîØ'},
    {view:'overview', icon:'üåü', label:'Á∏ΩË¶Ω'}
  ];
  let html = '<div class="home-page">';
  html += '<h1>Personal Log</h1>';
  html += '<p>‰Ω†‰ªäÂ§©ÊÉ≥ÂÅö‰∫õ‰ªÄÈ∫ºÔºü</p>';
  html += '<div class="home-cats">';
  cats.forEach(cat => {
    // Determine highlight based on whether the category has been updated today
    const updated = hasUpdatesToday(cat.view);
    // If not updated today, apply glow highlight to prompt the user to add data
    const glowClass = updated ? '' : ' glow';
    html += `<div class="home-cat${glowClass}" data-view="${cat.view}">${cat.icon} ${cat.label}</div>`;
  });
  html += '</div></div>';
  root.innerHTML = html;
  // Attach click handlers to category buttons
  root.querySelectorAll('.home-cat').forEach(btn => {
    btn.addEventListener('click', () => {
      const view = btn.getAttribute('data-view');
      switchToView(view);
    });
  });
}

/* =========================
   Overview (‰∫∫ÁîüÁ∏ΩË¶Ω) Page
   Combines data from all sections to show an overall picture. Displays
   bar charts for record counts and finance totals, and summarises
   recommendations across categories.
========================= */
let overviewCountChart = null;
let overviewFinanceChart = null;
function overviewTemplate(){
  return `\
    <div class="header">\
      <div class="title">\
        <h2>üåü ‰∫∫ÁîüÁ∏ΩË¶Ω</h2>\
        <p>Êï¥ÂêàÂÅ•Ë∫´„ÄÅÊó•Ë®ò„ÄÅÂ≠∏Áøí„ÄÅÊî∂ÊîØÔºåÊ¥ûÂØüÂΩºÊ≠§ÁöÑÂΩ±Èüø</p>\
      </div>\
      <span class="pill overview">Overview</span>\
    </div>\
    <div class="card">\
      <h3>Á¥ÄÈåÑÊï∏ÈáèÊ¶ÇË¶Ω</h3>\
      <canvas id="overview_count_chart" style="width:100%;height:240px;"></canvas>\
    </div>\
    <div class="card">\
      <h3>Êî∂ÊîØÁ∏ΩÈ°çÔºàÊî∂ÂÖ• vs ÊîØÂá∫Ôºâ</h3>\
      <canvas id="overview_finance_chart" style="width:100%;height:240px;"></canvas>\
    </div>\
    <div class="card">\
      <h3>ÂøÉÊÉÖÂàÜÂ∏ÉÔºàÈÅéÂéª7Â§©Ôºâ</h3>\
      <canvas id="overview_mood_chart" style="width:100%;height:240px;"></canvas>\
    </div>\
    <div class="card">\
      <h3>Ë∑®ÂàÜÈ°ûË°åÂãïÂª∫Ë≠∞</h3>\
      <div class="overview-recs">\
        <p><strong>1Â§©Ôºö</strong><span id="overview_rec_day"></span></p>\
        <p><strong>1ÈÄ±Ôºö</strong><span id="overview_rec_week"></span></p>\
        <p><strong>1ÂÄãÊúàÔºö</strong><span id="overview_rec_month"></span></p>\
        <p class="disclaimer">‰ª•‰∏äÂª∫Ë≠∞Áî±Á≥ªÁµ±Êï¥ÂêàÂêÑÈ°ûÂà•Âª∫Ë≠∞Ëá™ÂãïÁî¢ÁîüÔºåÂÉÖ‰æõÂèÉËÄÉ„ÄÇ</p>\
      </div>\
    </div>`;
}
function renderOverview(){
  const root = document.getElementById('view-overview');
  if(!root) return;
  // Inject template
  root.innerHTML = overviewTemplate();
  // Compute counts per category
  const counts = {
    ÂÅ•Ë∫´: state.workouts.length,
    Êó•Ë®ò: state.diaries.length,
    Â≠∏Áøí: state.learnings.length,
    Êî∂ÊîØ: state.transactions.length
  };
  // Destroy previous charts if exist
  if(overviewCountChart){ overviewCountChart.destroy(); overviewCountChart = null; }
  if(overviewFinanceChart){ overviewFinanceChart.destroy(); overviewFinanceChart = null; }
  // Draw counts bar chart
  const ctx1 = document.getElementById('overview_count_chart').getContext('2d');
  overviewCountChart = new Chart(ctx1, {
    type:'bar',
    data:{
      labels:Object.keys(counts),
      datasets:[{ label:'Á¥ÄÈåÑÊï∏Èáè', data:Object.values(counts) }]
    },
    options:{
      plugins:{ legend:{ display:false }, tooltip:{ callbacks:{ label: ctx => ` ${ctx.parsed.y}` } } },
      scales:{ y:{ beginAtZero:true, precision:0 } }
    }
  });
  // Compute finance totals
  const incomes = state.transactions.filter(t => t.type==='income').reduce((sum,t) => sum + t.amount, 0);
  const expenses = state.transactions.filter(t => t.type==='expense').reduce((sum,t) => sum + t.amount, 0);
  const ctx2 = document.getElementById('overview_finance_chart').getContext('2d');
  overviewFinanceChart = new Chart(ctx2, {
    type:'bar',
    data:{ labels:['Êî∂ÂÖ•','ÊîØÂá∫'], datasets:[{ label:'ÈáëÈ°ç', data:[incomes, expenses] }] },
    options:{ plugins:{ legend:{ display:false }, tooltip:{ callbacks:{ label: ctx => ` ${ctx.parsed.y}` } } }, scales:{ y:{ beginAtZero:true } } }
  });

  // Draw mood distribution chart: counts of moods in the past 7 days
  const moodCtx = document.getElementById('overview_mood_chart').getContext('2d');
  // Gather diary entries in past 7 days
  const now = new Date();
  const weekAgo2 = new Date(); weekAgo2.setDate(now.getDate() - 7);
  const recentDiaries = (state.diaries || []).filter(d => new Date(d.time) >= weekAgo2);
  const moodCounts2 = {};
  recentDiaries.forEach(d => { moodCounts2[d.mood] = (moodCounts2[d.mood] || 0) + 1; });
  const moodLabels = Object.keys(moodCounts2).sort((a,b)=> a.localeCompare(b,'zh-Hant'));
  const moodData = moodLabels.map(l => moodCounts2[l]);
  // Destroy previous mood chart if exists
  if(window.overviewMoodChart){ window.overviewMoodChart.destroy(); window.overviewMoodChart = null; }
  window.overviewMoodChart = new Chart(moodCtx, {
    type:'bar',
    data:{ labels: moodLabels.length ? moodLabels : ['ÔºàÂ∞öÁÑ°Á¥ÄÈåÑÔºâ'], datasets:[{ label:'Ê¨°Êï∏', data: moodLabels.length ? moodData : [1] }] },
    options:{ plugins:{ legend:{ display:false }, tooltip:{ callbacks:{ label:ctx=>` ${ctx.parsed.y}` } } }, scales:{ y:{ beginAtZero:true, precision:0 } } }
  });
  // Set recommendations
  const rec = getRecommendations('overview');
  document.getElementById('overview_rec_day').innerHTML = rec.day;
  document.getElementById('overview_rec_week').innerHTML = rec.week;
  document.getElementById('overview_rec_month').innerHTML = rec.month;
  // After rendering, apply card collapse behaviour on overview
  applyCardCollapse('overview');
}

/* =========================
   Fitness (Workout) Section
========================= */
let fitnessLineChart = null;
function fitnessTemplate(){
  return `\
    <div class="header">\
      <div class="title">\
        <h2>üèãÔ∏è ÂÅ•Ë∫´Á¥ÄÈåÑ</h2>\
        <p>Ëº∏ÂÖ•ÈñãÂßã/ÁµêÊùü/‰ºëÊÅØÔºåÁ≥ªÁµ±Ëá™ÂãïÁÆóÂØ¶ÈöõË®ìÁ∑¥ÊôÇÈñìÔºå‰∏¶‰ª•„ÄåÊúà„ÄçÁÇ∫ÂñÆ‰ΩçÊï¥ÁêÜÈáçÈáèÈÄ≤Ê≠•„ÄÇ</p>\
      </div>\
      <span class="pill fit">Workout</span>\
    </div>\
    <div class="grid">\
      <div class="card">\
        <h3>Êñ∞Â¢ûË®ìÁ∑¥</h3>\
        <div class="form">\
          <div class="row"><label>Êó•Êúü</label><input id="fit_date" type="date" /></div>\
          <div class="row"><label>Âãï‰Ωú/È†ÖÁõÆ</label><select id="fit_exercise">\
            <optgroup label="ËÉ∏ÈÉ®">\
              <option value="ÂïûÈà¥Ëá•Êé®">ÂïûÈà¥Ëá•Êé®</option>\
              <option value="‰∏äÊñúÂïûÈà¥Ëá•Êé®">‰∏äÊñúÂïûÈà¥Ëá•Êé®</option>\
              <option value="‰∏ãÊñúÂïûÈà¥Ëá•Êé®">‰∏ãÊñúÂïûÈà¥Ëá•Êé®</option>\
              <option value="ÂïûÈà¥È£õÈ≥•">ÂïûÈà¥È£õÈ≥•</option>\
              <option value="‰∏äÊñúÂïûÈà¥È£õÈ≥•">‰∏äÊñúÂïûÈà¥È£õÈ≥•</option>\
            </optgroup>\
            <optgroup label="ËÉåÈÉ®">\
              <option value="ÂïûÈà¥ÂñÆËáÇÂàíËàπ">ÂïûÈà¥ÂñÆËáÇÂàíËàπ</option>\
              <option value="ÂïûÈà¥ÈõôËáÇÂàíËàπ">ÂïûÈà¥ÈõôËáÇÂàíËàπ</option>\
              <option value="ÂïûÈà¥Á°¨Ëàâ">ÂïûÈà¥Á°¨Ëàâ</option>\
              <option value="ÂïûÈà¥ÁæÖÈ¶¨Â∞º‰∫ûÁ°¨Ëàâ">ÂïûÈà¥ÁæÖÈ¶¨Â∞º‰∫ûÁ°¨Ëàâ</option>\
              <option value="ÂïûÈà¥ËÅ≥ËÇ©">ÂïûÈà¥ËÅ≥ËÇ©</option>\
              <option value="ÂïûÈà¥ÂèçÂêëÈ£õÈ≥•">ÂïûÈà¥ÂèçÂêëÈ£õÈ≥•</option>\
            </optgroup>\
            <optgroup label="ËÖøÈÉ®">\
              <option value="ÂïûÈà¥Ê∑±Ëπ≤">ÂïûÈà¥Ê∑±Ëπ≤</option>\
              <option value="ÂïûÈà¥È´òËÖ≥ÊùØÊ∑±Ëπ≤">ÂïûÈà¥È´òËÖ≥ÊùØÊ∑±Ëπ≤</option>\
              <option value="ÂïûÈà¥ÂºìÁÆ≠Ê≠•">ÂïûÈà¥ÂºìÁÆ≠Ê≠•</option>\
              <option value="ÂïûÈà¥‰øùÂä†Âà©‰∫ûÂàÜËÖøËπ≤">ÂïûÈà¥‰øùÂä†Âà©‰∫ûÂàÜËÖøËπ≤</option>\
              <option value="ÂïûÈà¥ÂÅ¥ÂºìÊ≠•">ÂïûÈà¥ÂÅ¥ÂºìÊ≠•</option>\
              <option value="ÂïûÈà¥ÊèêË∏µ">ÂïûÈà¥ÊèêË∏µ</option>\
              <option value="ÂïûÈà¥ÂñÆËÖøÁ°¨Ëàâ">ÂïûÈà¥ÂñÆËÖøÁ°¨Ëàâ</option>\
            </optgroup>\
            <optgroup label="ËÇ©ËÜÄ">\
              <option value="ÂïûÈà¥ËÇ©Êé®">ÂïûÈà¥ËÇ©Êé®</option>\
              <option value="ÂïûÈà¥ÈòøË´æÊé®Ëàâ">ÂïûÈà¥ÈòøË´æÊé®Ëàâ</option>\
              <option value="ÂïûÈà¥ÂÅ¥Âπ≥Ëàâ">ÂïûÈà¥ÂÅ¥Âπ≥Ëàâ</option>\
              <option value="ÂïûÈà¥ÂâçÂπ≥Ëàâ">ÂïûÈà¥ÂâçÂπ≥Ëàâ</option>\
              <option value="ÂïûÈà¥‰øØË∫´ÂÅ¥Âπ≥Ëàâ">ÂïûÈà¥‰øØË∫´ÂÅ¥Âπ≥Ëàâ</option>\
              <option value="ÂïûÈà¥Áõ¥Á´ãÂàíËàπ">ÂïûÈà¥Áõ¥Á´ãÂàíËàπ</option>\
            </optgroup>\
            <optgroup label="ÊâãËáÇ - ‰∫åÈ†≠ËÇå">\
              <option value="ÂïûÈà¥ÂΩéËàâ">ÂïûÈà¥ÂΩéËàâ</option>\
              <option value="ÂïûÈà¥ÈåòÂºèÂΩéËàâ">ÂïûÈà¥ÈåòÂºèÂΩéËàâ</option>\
              <option value="ÂïûÈà¥‰∫§ÊõøÂΩéËàâ">ÂïûÈà¥‰∫§ÊõøÂΩéËàâ</option>\
              <option value="ÂïûÈà¥ÈõÜ‰∏≠ÂΩéËàâ">ÂïûÈà¥ÈõÜ‰∏≠ÂΩéËàâ</option>\
              <option value="ÂïûÈà¥ÊñúÊùøÂΩéËàâ">ÂïûÈà¥ÊñúÊùøÂΩéËàâ</option>\
            </optgroup>\
            <optgroup label="ÊâãËáÇ - ‰∏âÈ†≠ËÇå">\
              <option value="ÂïûÈà¥ÈÅéÈ†≠ËáÇÂ±à‰º∏">ÂïûÈà¥ÈÅéÈ†≠ËáÇÂ±à‰º∏</option>\
              <option value="ÂïûÈà¥‰øØË∫´ËáÇÂ±à‰º∏">ÂïûÈà¥‰øØË∫´ËáÇÂ±à‰º∏</option>\
              <option value="ÂïûÈà¥‰ª∞Ëá•ËáÇÂ±à‰º∏">ÂïûÈà¥‰ª∞Ëá•ËáÇÂ±à‰º∏</option>\
            </optgroup>\
            <optgroup label="Ê†∏ÂøÉ">\
              <option value="ÂïûÈà¥‰øÑÁæÖÊñØËΩâÈ´î">ÂïûÈà¥‰øÑÁæÖÊñØËΩâÈ´î</option>\
              <option value="ÂïûÈà¥ÂÅ¥ÂΩé">ÂïûÈà¥ÂÅ¥ÂΩé</option>\
              <option value="ÂïûÈà¥Ëæ≤Â§´Ëµ∞Ë∑Ø">ÂïûÈà¥Ëæ≤Â§´Ëµ∞Ë∑Ø</option>\
              <option value="ÂïûÈà¥‰ºêÊú®">ÂïûÈà¥‰ºêÊú®</option>\
            </optgroup>\
            <optgroup label="Ë§áÂêàÂãï‰Ωú">\
              <option value="ÂïûÈà¥ÊäìËàâ">ÂïûÈà¥ÊäìËàâ</option>\
              <option value="ÂïûÈà¥Êå∫Ëàâ">ÂïûÈà¥Êå∫Ëàâ</option>\
              <option value="ÂïûÈà¥ÂúüËÄ≥ÂÖ∂Ëµ∑Á´ã">ÂïûÈà¥ÂúüËÄ≥ÂÖ∂Ëµ∑Á´ã</option>\
              <option value="ÂïûÈà¥Ê≥¢ÊØîË∑≥">ÂïûÈà¥Ê≥¢ÊØîË∑≥</option>\
            </optgroup>\
            <optgroup label="ÂÖ∂‰ªñ">\
              <option value="Ëá™Ë®ÇÂãï‰Ωú">Ëá™Ë®ÇÂãï‰Ωú</option>\
            </optgroup>\
          </select></div>\
          <div class="row"><label>ÈñãÂßãÊôÇÈñì</label><input id="fit_start" type="time" /></div>\
          <div class="row"><label>ÁµêÊùüÊôÇÈñì</label><input id="fit_end" type="time" /></div>\
          <div class="row"><label>‰ºëÊÅØÊôÇÈñì</label><input id="fit_rest" type="number" min="0" step="1" placeholder="ÂàÜÈêò" /></div>\
          <div class="row"><label>ÈáçÈáè</label><input id="fit_weight" type="number" min="0" step="0.5" placeholder="kg" /></div>\
          <div class="row"><label>ÂÇôË®ª</label><input id="fit_note" placeholder="ÂèØÈÅ∏" /></div>\
          <div class="btns">\
            <button class="btn primary" id="fit_add">Êñ∞Â¢û</button>\
            <button class="btn" id="fit_fill_now">Ëá™ÂãïÂ∏∂ÂÖ•‰ªäÂ§©</button>\
          </div>\
          <div class="hint">\
            ÂØ¶ÈöõË®ìÁ∑¥ÊôÇÈñì = (ÁµêÊùü-ÈñãÂßã) - ‰ºëÊÅØÊôÇÈñì„ÄÇ<br/>\
            Ëã•ÁµêÊùüÊôÇÈñìÊó©ÊñºÈñãÂßãÊôÇÈñìÔºåË¶ñÁÇ∫Ë∑®Êó•Ôºà‰æãÂ¶Ç 23:30 Âà∞ 00:30Ôºâ„ÄÇ\
          </div>\
        </div>\
      </div>\
      <div class="card">\
        <div class="split">\
          <div>\
            <h3>ÈÄ≤Ê≠•ÊäòÁ∑öÂúñÔºàÈáçÈáè / ÊúàÔºâ</h3>\
            <div class="row" style="gap:8px">\
              <label style="width:80px">ÈÅ∏ÊìáÂãï‰Ωú</label>\
              <select id="fit_chart_exercise"></select>\
            </div>\
            <div class="chart-wrap"><canvas id="fit_line"></canvas></div>\
          </div>\
          <div>\
            <h3>ÊúàÂ∫¶ÊëòË¶Å</h3>\
            <div class="hint" style="margin-bottom:6px;">Âè≥Ë°®È°ØÁ§∫ÊØèÊúà„ÄåÊúÄÈ´òÈáçÈáè„ÄçËàáÁõ∏Â∞ç‰∏äÊúàÈÄ≤Ê≠•ÂπÖÂ∫¶ÔºàŒîÔºâ„ÄÇ</div>\
            <table class="table" id="fit_table">\
              <thead><tr><th>Êúà‰ªΩ</th><th>ÈáçÈáè</th><th>Œî</th></tr></thead>\
              <tbody></tbody>\
            </table>\
          </div>\
        </div>\
        <div style="margin-top:10px">\
          <h3>ÊúÄËøëÁ¥ÄÈåÑ</h3>\
          <div class="list" id="fit_list"></div>\
        </div>\
      </div>\
    </div>\
  `;
}
function renderFitness(){
  const root = document.getElementById('view-fitness');
  root.innerHTML = fitnessTemplate();
  // defaults
  const today = new Date();
  document.getElementById('fit_date').value = toISODate(today);
  document.getElementById('fit_rest').value = 0;
  document.getElementById('fit_fill_now').addEventListener('click', ()=>{ document.getElementById('fit_date').value = toISODate(new Date()); });
  document.getElementById('fit_add').addEventListener('click', ()=>{
    const date = document.getElementById('fit_date').value;
    const exercise = document.getElementById('fit_exercise').value.trim();
    const start = document.getElementById('fit_start').value;
    const end = document.getElementById('fit_end').value;
    const rest = Number(document.getElementById('fit_rest').value || 0);
    const weight = Number(document.getElementById('fit_weight').value || 0);
    const note = document.getElementById('fit_note').value.trim();
    if(!date || !exercise || !start || !end){ alert('Ë´ãËá≥Â∞ëÂ°´ÔºöÊó•Êúü„ÄÅÂãï‰Ωú„ÄÅÈñãÂßãÊôÇÈñì„ÄÅÁµêÊùüÊôÇÈñì'); return; }
    const duration = Math.max(0, diffMinutes(start, end) - rest);
    const item = { id: uid('w'), date, exercise, start, end, restMinutes: rest, durationMinutes: duration, weight, note, createdAt: new Date().toISOString() };
    state.workouts.unshift(item);
    saveStateLocal();
    renderFitness();
  });
  // chart exercise dropdown
  const exSet = new Set(state.workouts.map(w=> w.exercise));
  const exList = Array.from(exSet).sort((a,b)=> a.localeCompare(b, 'zh-Hant'));
  const sel = document.getElementById('fit_chart_exercise');
  if(exList.length === 0){ sel.innerHTML = `<option value="">ÔºàÂ∞öÁÑ°Ë≥áÊñôÔºâ</option>`; }
  else{ sel.innerHTML = exList.map(x=> `<option value="${escapeHtml(x)}">${escapeHtml(x)}</option>`).join(''); }
  sel.addEventListener('change', ()=> drawFitnessChart(sel.value));
  drawFitnessChart(exList[0] || '');
  renderFitnessList();
  // After rendering lists, show recommendations section
  renderRecommendations('fitness');
}
function renderFitnessList(){
  const list = document.getElementById('fit_list');
  const items = state.workouts.slice(0, 12);
  list.innerHTML = items.map(w=>{
    const meta = [
      `<span class="tag"><b>${escapeHtml(w.exercise)}</b></span>`,
      `<span class="tag">${escapeHtml(w.date)}</span>`,
      `<span class="tag">${escapeHtml(w.start)}‚Äì${escapeHtml(w.end)}</span>`,
      `<span class="tag">‰ºëÊÅØ ${escapeHtml(String(w.restMinutes))} ÂàÜ</span>`,
      `<span class="tag">ÂØ¶Èöõ ${fmtMinutes(w.durationMinutes)}</span>`,
      `<span class="tag">ÈáçÈáè ${escapeHtml(String(w.weight))} kg</span>`
    ].join(' ');
    return `\
      <div class="item">\
        <div class="meta">${meta}</div>\
        ${w.note ? `<div class="hint">${escapeHtml(w.note)}</div>` : `<div class="hint">ÔºàÁÑ°ÂÇôË®ªÔºâ</div>`}\
        <div class="btns" style="margin-top:6px"><button class="btn danger" onclick="deleteWorkout('${w.id}')">Âà™Èô§</button></div>\
      </div>\
    `;
  }).join('') || `<div class="hint">Â∞öÁÑ°ÂÅ•Ë∫´Á¥ÄÈåÑ„ÄÇ</div>`;
}
function deleteWorkout(id){ state.workouts = state.workouts.filter(w=> w.id!==id); saveStateLocal(); renderAll(); }
function drawFitnessChart(exercise){
  if(fitnessLineChart){ fitnessLineChart.destroy(); fitnessLineChart = null; }
  const canvas = document.getElementById('fit_line');
  if(!exercise){ canvas.getContext('2d').clearRect(0,0,canvas.width,canvas.height); document.querySelector('#fit_table tbody').innerHTML = ''; return; }
  const filtered = state.workouts.filter(w=> w.exercise === exercise);
  const byMonth = groupBy(filtered, w=> toMonthKey(w.date));
  const months = Object.keys(byMonth).sort();
  const weights = months.map(m=>{
    const maxW = Math.max(...byMonth[m].map(x=> Number(x.weight || 0)));
    return maxW;
  });
  // build table
  const tbody = document.querySelector('#fit_table tbody');
  let prev = null;
  tbody.innerHTML = months.map((m,i)=>{
    const w = weights[i];
    const delta = (prev === null) ? '' : (w - prev);
    const deltaTxt = (prev === null) ? '‚Äî' : (delta >= 0 ? `+${delta}` : `${delta}`);
    prev = w;
    return `<tr><td>${escapeHtml(m)}</td><td>${escapeHtml(String(w))} kg</td><td>${escapeHtml(deltaTxt)} kg</td></tr>`;
  }).join('');
  fitnessLineChart = new Chart(canvas, { type:'line', data:{ labels: months, datasets:[{ label:'ÊúàÊúÄÈ´òÈáçÈáè (kg)', data: weights, tension:0.25, pointRadius:3, pointHoverRadius:4, fill:false }] }, options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{ display:true }, tooltip:{ callbacks:{ label:(ctx)=>` ${ctx.parsed.y} kg` } } }, scales:{ y:{ beginAtZero:true } } } });
  canvas.parentElement.style.height = '240px';
}

/* =========================
   Diary Section
========================= */
let diaryFilter = { month:'ALL', mood:'ALL' };
function diaryTemplate(){
  return `\
    <div class="header">\
      <div class="title">\
        <h2>üìì Êó•Ë®ò</h2>\
        <p>Ëá™ÂãïÊåâ„ÄåÊúà‰ªΩ„ÄçËàá„ÄåÂøÉÊÉÖ„ÄçÂª∫Á´ãË≥áÊñôÂ§æÔºåÊñπ‰æøÂõûÊ∫ØËàáÊü•Êâæ„ÄÇ</p>\
      </div>\
      <span class="pill diary">Diary</span>\
    </div>\
    <div class="grid">\
      <div class="card">\
        <h3>Êñ∞Â¢ûÊó•Ë®ò</h3>\
        <div class="form">\
          <div class="row"><label>ÊôÇÈñì</label><input id="diary_time" type="datetime-local" /></div>\
          <div class="row"><label>ÂøÉÊÉÖ</label><select id="diary_mood">\
            <option value="ÈñãÂøÉ">ÈñãÂøÉ</option><option value="Âπ≥Èùú">Âπ≥Èùú</option><option value="ÁÑ¶ÊÖÆ">ÁÑ¶ÊÖÆ</option><option value="‰ΩéËêΩ">‰ΩéËêΩ</option><option value="ÊÜ§ÊÄí">ÊÜ§ÊÄí</option><option value="Áñ≤ÂÄ¶">Áñ≤ÂÄ¶</option><option value="Â∞àÊ≥®">Â∞àÊ≥®</option><option value="ÂÖ∂‰ªñ">ÂÖ∂‰ªñ</option>\
          </select></div>\
          <div class="row"><label>ÂÖßÂÆπ</label><textarea id="diary_text" placeholder="ÂØ´Èªû‰ªÄÈ∫º‚Ä¶"></textarea></div>\
          <div class="btns"><button class="btn primary" id="diary_add">Êñ∞Â¢û</button></div>\
        </div>\
      </div>\
      <div class="card">\
        <div class="split">\
          <div class="folder">\
            <h4>Ë≥áÊñôÂ§æÔºàÊúà‰ªΩ / ÂøÉÊÉÖÔºâ</h4>\
            <div class="tree" id="diary_tree"></div>\
            <div class="hint" style="margin-top:6px;">ÈªûÈÅ∏Ë≥áÊñôÂ§æÂç≥ÂèØÂ•óÁî®ÁØ©ÈÅ∏„ÄÇ</div>\
          </div>\
          <div>\
            <h3>Ê∏ÖÂñÆ</h3>\
            <div class="kpi">\
              <div class="box"><div class="t">ÁõÆÂâçÁØ©ÈÅ∏</div><div class="n" id="diary_kpi_filter">‚Äî</div></div>\
              <div class="box"><div class="t">Á≠ÜÊï∏</div><div class="n" id="diary_kpi_count">0</div></div>\
              <div class="box"><div class="t">ÊúÄÊó©</div><div class="n" id="diary_kpi_min">‚Äî</div></div>\
              <div class="box"><div class="t">ÊúÄËøë</div><div class="n" id="diary_kpi_max">‚Äî</div></div>\
            </div>\
            <div class="btns" style="margin-top:8px"><button class="btn" id="diary_clear_filter">Ê∏ÖÈô§ÁØ©ÈÅ∏</button></div>\
            <div class="list" id="diary_list" style="margin-top:8px"></div>\
          </div>\
        </div>\
      </div>\
    </div>\
  `;
}
function renderDiary(){
  const root = document.getElementById('view-diary');
  root.innerHTML = diaryTemplate();
  const now = new Date();
  const dt = `${toISODate(now)}T${pad2(now.getHours())}:${pad2(now.getMinutes())}`;
  document.getElementById('diary_time').value = dt;
  document.getElementById('diary_add').addEventListener('click', ()=>{
    const time = document.getElementById('diary_time').value;
    const mood = document.getElementById('diary_mood').value;
    const text = document.getElementById('diary_text').value.trim();
    if(!time || !text){ alert('Ë´ãËá≥Â∞ëÂ°´ÔºöÊôÇÈñì„ÄÅÂÖßÂÆπ'); return; }
    state.diaries.unshift({ id: uid('d'), time: new Date(time).toISOString(), mood, text, createdAt: new Date().toISOString() });
    saveStateLocal();
    renderDiary();
  });
  document.getElementById('diary_clear_filter').addEventListener('click', ()=>{ diaryFilter = { month:'ALL', mood:'ALL' }; renderDiary(); });
  renderDiaryTree();
  renderDiaryList();
  // Show recommendations section for diary
  renderRecommendations('diary');
}
function renderDiaryTree(){
  const tree = document.getElementById('diary_tree');
  const diaries = state.diaries.slice().sort((a,b)=> new Date(b.time) - new Date(a.time));
  const byMonth = groupBy(diaries, d=> toMonthKey(d.time));
  const months = Object.keys(byMonth).sort().reverse();
  const buttons = [];
  buttons.push({ label:'ÂÖ®ÈÉ®', month:'ALL', mood:'ALL' });
  for(const m of months){
    buttons.push({ label:`üìÅ ${m}`, month:m, mood:'ALL' });
    const byMood = groupBy(byMonth[m], d=> d.mood);
    const moods = Object.keys(byMood).sort((a,b)=> a.localeCompare(b,'zh-Hant'));
    for(const mood of moods){
      buttons.push({ label:`‚îî‚îÄ ${mood} (${byMood[mood].length})`, month:m, mood });
    }
  }
  tree.innerHTML = buttons.map(b=>{
    const active = (diaryFilter.month===b.month && diaryFilter.mood===b.mood) ? 'active' : '';
    return `<button class="${active}" data-month="${escapeHtml(b.month)}" data-mood="${escapeHtml(b.mood)}">${escapeHtml(b.label)}</button>`;
  }).join('') || `<div class="hint">Â∞öÁÑ°Êó•Ë®ò„ÄÇ</div>`;
  tree.addEventListener('click', (e)=>{
    const btn = e.target.closest('button[data-month]');
    if(!btn) return;
    diaryFilter.month = btn.dataset.month;
    diaryFilter.mood = btn.dataset.mood;
    renderDiary();
  }, { once:true });
}
function renderDiaryList(){
  const list = document.getElementById('diary_list');
  let diaries = state.diaries.slice().sort((a,b)=> new Date(b.time) - new Date(a.time));
  if(diaryFilter.month !== 'ALL'){ diaries = diaries.filter(d=> toMonthKey(d.time)===diaryFilter.month); }
  if(diaryFilter.mood !== 'ALL'){ diaries = diaries.filter(d=> d.mood === diaryFilter.mood); }
  document.getElementById('diary_kpi_filter').textContent = (diaryFilter.month==='ALL' && diaryFilter.mood==='ALL') ? 'ÂÖ®ÈÉ®' : `${diaryFilter.month==='ALL' ? 'ÂÖ®ÈÉ®Êúà‰ªΩ' : diaryFilter.month} / ${diaryFilter.mood==='ALL' ? 'ÂÖ®ÈÉ®ÂøÉÊÉÖ' : diaryFilter.mood}`;
  document.getElementById('diary_kpi_count').textContent = String(diaries.length);
  if(diaries.length){
    const times = diaries.map(d=> new Date(d.time).getTime()).sort((a,b)=> a - b);
    document.getElementById('diary_kpi_min').textContent = new Date(times[0]).toISOString().slice(0,10);
    document.getElementById('diary_kpi_max').textContent = new Date(times[times.length-1]).toISOString().slice(0,10);
  } else {
    document.getElementById('diary_kpi_min').textContent = '‚Äî';
    document.getElementById('diary_kpi_max').textContent = '‚Äî';
  }
  list.innerHTML = diaries.slice(0, 30).map(d=>{
    return `\
      <div class="item">\
        <div class="meta">\
          <span class="tag"><b>${escapeHtml(d.mood)}</b></span>\
          <span class="tag">${escapeHtml(fmtDateTime(d.time))}</span>\
          <span class="tag">${escapeHtml(toMonthKey(d.time))}</span>\
        </div>\
        <div style="white-space:pre-wrap; line-height:1.4">${escapeHtml(d.text)}</div>\
        <div class="btns" style="margin-top:6px"><button class="btn danger" onclick="deleteDiary('${d.id}')">Âà™Èô§</button></div>\
      </div>\
    `;
  }).join('') || `<div class="hint">Ê≠§ÁØ©ÈÅ∏‰∏ãÊ≤íÊúâÊó•Ë®ò„ÄÇ</div>`;
}
function deleteDiary(id){ state.diaries = state.diaries.filter(d=> d.id!==id); saveStateLocal(); renderAll(); }

/* =========================
   Learning Section
========================= */
let learnSubjectFilter = 'ALL';
let markmapInstance = null;
function learningTemplate(){
  // The learning template uses a simple card structure with an <h3> at the top of
  // each card. The generic applyCardCollapse() function will wrap the <h3>
  // into a collapsible header and move the remainder of the card into the
  // card-body automatically. Sub-headings within cards use <h4> so that
  // applyCardCollapse() does not treat them as separate headers. See
  // applyCardCollapse() for details on how the collapse is applied.
  return `\
<div class="header">
  <div class="title">
    <h2>üìö Â≠∏ÁøíÁ¥ÄÈåÑ</h2>
    <p>‰ª•„ÄåÁßëÁõÆ„ÄçËá™ÂãïÂª∫Á´ãË≥áÊñôÂ§æÔºõÂèØ‰∏ÄÈçµÁîüÊàêÂøÉÊô∫ÂúñÔºàÁßëÁõÆ ‚Üí Ê¢ùÁõÆÔºâ„ÄÇ</p>
  </div>
  <span class="pill learn">Learning</span>
</div>
<div class="grid">
  <!-- Card for adding a new learning entry -->
  <div class="card">
    <div class="card-header">
      <h3>Êñ∞Â¢ûÂ≠∏Áøí</h3>
      <span class="card-arrow">‚ñº</span>
    </div>
    <div class="card-body">
      <div class="form">
        <div class="row"><label>Êó•Êúü</label><input id="learn_date" type="date" /></div>
        <div class="row"><label>ÁßëÁõÆ</label><input id="learn_subject" placeholder="‰æãÔºöËã±Êñá / ÊäïË≥á / Á®ãÂºè / ÂíñÂï°" /></div>
        <div class="row"><label>Ê®ôÈ°å</label><input id="learn_title" placeholder="‰æãÔºöETF ÂÜçÂπ≥Ë°°ÂéüÂâá" /></div>
        <div class="row"><label>ÂÖßÂÆπ</label><textarea id="learn_notes" placeholder="ÊëòË¶Å„ÄÅÈáçÈªû„ÄÅÈÄ£Áµê‚Ä¶"></textarea></div>
        <div class="btns"><button class="btn primary" id="learn_add">Êñ∞Â¢û</button></div>
      </div>
    </div>
  </div>
  <!-- Card for listing subjects and mind map -->
  <div class="card">
    <div class="card-header">
      <h3>ÁßëÁõÆÊ∏ÖÂñÆËàáÂøÉÊô∫Âúñ</h3>
      <span class="card-arrow">‚ñº</span>
    </div>
    <div class="card-body">
      <div class="split">
        <div class="folder">
          <h4>ÁßëÁõÆË≥áÊñôÂ§æ</h4>
          <div class="tree" id="learn_tree"></div>
          <div class="btns" style="margin-top:8px">
            <button class="btn" id="learn_clear_filter">Ê∏ÖÈô§ÁØ©ÈÅ∏</button>
            <button class="btn primary" id="learn_render_mindmap">ÁîüÊàêÂøÉÊô∫Âúñ</button>
          </div>
          <div class="hint" style="margin-top:6px;">ÂøÉÊô∫Âúñ‰ª•„ÄåÁßëÁõÆ ‚Üí Ê®ôÈ°å„ÄçÁµÑÁπîÔºåÈÅ©ÂêàÂÅöÂõûÈ°ßÁ¥¢Âºï„ÄÇ</div>
        </div>
        <div>
          <h4>Ê∏ÖÂñÆ</h4>
          <div class="list" id="learn_list"></div>
          <h4 style="margin-top:10px;">ÂøÉÊô∫Âúñ</h4>
          <div class="chart-wrap" style="height:280px; overflow:hidden;">
            <svg id="mindmap" style="width:100%;height:100%;"></svg>
          </div>
        </div>
      </div>
    </div>
  </div>
  <!-- Card for uploading an image and generating a note via OCR -->
  <div class="card">
    <div class="card-header">
      <h3>ÂúñÁâáÁ≠ÜË®ò</h3>
      <span class="card-arrow">‚ñº</span>
    </div>
    <div class="card-body">
      <div class="form">
        <div class="row"><label>‰∏äÂÇ≥ÂúñÁâá</label><input id="learn_photo" type="file" accept="image/*" /></div>
        <div class="hint" style="margin-top:6px;">ÈÅ∏Êìá‰∏ÄÂºµÁÖßÁâáÂæåÔºåÁ≥ªÁµ±ÊúÉËá™ÂãïË≠òÂà•ÂÖ∂‰∏≠ÁöÑÊñáÂ≠ó‰∏¶ÁîüÊàêÁ≠ÜË®òÊëòË¶Å„ÄÇ</div>
        <div id="learn_photo_status" class="hint" style="margin-top:4px;"></div>
      </div>
    </div>
  </div>
</div>`;
}
function renderLearning(){
  const root = document.getElementById('view-learning');
  root.innerHTML = learningTemplate();
  document.getElementById('learn_date').value = toISODate(new Date());
  document.getElementById('learn_add').addEventListener('click', ()=>{
    const date = document.getElementById('learn_date').value;
    const subject = document.getElementById('learn_subject').value.trim();
    const title = document.getElementById('learn_title').value.trim();
    const notes = document.getElementById('learn_notes').value.trim();
    if(!date || !subject || !title){ alert('Ë´ãËá≥Â∞ëÂ°´ÔºöÊó•Êúü„ÄÅÁßëÁõÆ„ÄÅÊ®ôÈ°å'); return; }
    state.learnings.unshift({ id: uid('l'), date, subject, title, notes, createdAt: new Date().toISOString() });
    saveStateLocal();
    renderLearning();
  });
  document.getElementById('learn_clear_filter').addEventListener('click', ()=>{ learnSubjectFilter = 'ALL'; renderLearning(); });
  document.getElementById('learn_render_mindmap').addEventListener('click', ()=>{ renderMindMap(); });
  renderLearningTree();
  renderLearningList();
  renderMindMap();
  // Show recommendations section for learning
  renderRecommendations('learning');

  // No manual collapse handlers are necessary. applyCardCollapse() will
  // transform the cards and attach the appropriate toggle behaviour. We
  // intentionally omit any direct binding here to avoid duplicating
  // event listeners or interfering with the generic collapse logic.


  // We rely on the generic applyCardCollapse() utility to transform
  // the learning cards into collapsible panels. The first <h3> in
  // each card will be wrapped into a header and the remainder into
  // a body automatically. See applyCardCollapse() for details.

  // Handle image upload and OCR for generating a learning note
  const photoInput = document.getElementById('learn_photo');
  if(photoInput){
    photoInput.addEventListener('change', ()=>{
      const statusEl = document.getElementById('learn_photo_status');
      const file = photoInput.files && photoInput.files[0];
      if(!file){ return; }
      // Display processing status
      if(statusEl) statusEl.textContent = 'Ê≠£Âú®Ë≠òÂà•ÔºåË´ãÁ®çÂÄô...';
      const reader = new FileReader();
      reader.onload = function(){
        const dataURL = reader.result;
        // Default to English; tesseract.js will auto load traineddata
        const lang = 'eng';
        Tesseract.recognize(dataURL, lang, { logger: m => {} })
          .then(({ data }) => {
            const rawText = (data && data.text) ? data.text.trim() : '';
            // Generate a concise summary from the recognized text. We split
            // the OCR result into lines, filter out empty ones, and take
            // the first few lines to form a short summary. If the text is
            // long, this helps condense the content into a manageable
            // length for the note field. If no text is recognised, we
            // provide a default message.
            let summary = '';
            if(rawText){
              const lines = rawText.split(/\r?\n/).map(l => l.trim()).filter(l => l);
              summary = lines.slice(0, 5).join(' / ');
              // If summary is still too long, truncate to 300 characters with ellipsis
              if(summary.length > 300){
                summary = summary.slice(0, 297) + '...';
              }
            }
            // Derive title from the filename without extension
            let title = file.name ? file.name.replace(/\.[^/.]+$/, '') : 'ÂúñÁâáÁ≠ÜË®ò';
            const date = toISODate(new Date());
            const note = summary || '(ÁÑ°ÊñáÂ≠óË≠òÂà•ÁµêÊûú)';
            state.learnings.unshift({ id: uid('l'), date, subject:'ÂúñÁâáÁ≠ÜË®ò', title, notes: note, createdAt: new Date().toISOString() });
            saveStateLocal();
            if(statusEl) statusEl.textContent = 'Ë≠òÂà•ÂÆåÊàêÔºåÂ∑≤Êñ∞Â¢ûÁ≠ÜË®ò„ÄÇ';
            // Re-render the learning page to show the new entry and rebind events
            renderLearning();
          })
          .catch(err => {
            if(statusEl) statusEl.textContent = 'Ë≠òÂà•Â§±ÊïóÔºåË´ãÈáçÊñ∞ÂòóË©¶„ÄÇ';
          });
      };
      reader.readAsDataURL(file);
    });
  }

  // Attach collapse behaviour to learning cards using the unified card-header structure
  const headers = root.querySelectorAll('.card-header');
  headers.forEach(header => {
    header.addEventListener('click', () => {
      const card = header.closest('.card');
      const arrow = header.querySelector('.card-arrow');
      card.classList.toggle('collapsed');
      if(arrow){
        arrow.textContent = card.classList.contains('collapsed') ? '‚ñ∂' : '‚ñº';
      }
    });
  });
}
function renderLearningTree(){
  const tree = document.getElementById('learn_tree');
  const subjects = Array.from(new Set(state.learnings.map(x=> x.subject))).sort((a,b)=> a.localeCompare(b,'zh-Hant'));
  const items = [{ label:`ÂÖ®ÈÉ® (${state.learnings.length})`, subject:'ALL' }].concat(subjects.map(s=>{ const n = state.learnings.filter(x=> x.subject===s).length; return { label:`üìÅ ${s} (${n})`, subject:s }; }));
  tree.innerHTML = items.map(it=>{
    const active = (learnSubjectFilter===it.subject) ? 'active' : '';
    return `<button class="${active}" data-subject="${escapeHtml(it.subject)}">${escapeHtml(it.label)}</button>`;
  }).join('') || `<div class="hint">Â∞öÁÑ°Â≠∏ÁøíÁ¥ÄÈåÑ„ÄÇ</div>`;
  tree.addEventListener('click', (e)=>{
    const btn = e.target.closest('button[data-subject]');
    if(!btn) return;
    learnSubjectFilter = btn.dataset.subject;
    renderLearning();
  }, { once:true });
}
function renderLearningList(){
  const list = document.getElementById('learn_list');
  let arr = state.learnings.slice().sort((a,b)=> new Date(b.date) - new Date(a.date));
  if(learnSubjectFilter !== 'ALL'){ arr = arr.filter(x=> x.subject === learnSubjectFilter); }
  list.innerHTML = arr.slice(0,30).map(x=>{
    return `\
      <div class="item">\
        <div class="meta">\
          <span class="tag"><b>${escapeHtml(x.subject)}</b></span>\
          <span class="tag">${escapeHtml(x.date)}</span>\
        </div>\
        <div style="font-weight:700; margin-bottom:4px">${escapeHtml(x.title)}</div>\
        <div class="hint" style="white-space:pre-wrap">${x.notes ? escapeHtml(x.notes) : 'ÔºàÁÑ°ÂÖßÂÆπÔºâ'}</div>\
        <div class="btns" style="margin-top:6px"><button class="btn danger" onclick="deleteLearning('${x.id}')">Âà™Èô§</button></div>\
      </div>\
    `;
  }).join('') || `<div class="hint">Ê≠§ÁØ©ÈÅ∏‰∏ãÊ≤íÊúâÂ≠∏ÁøíÁ¥ÄÈåÑ„ÄÇ</div>`;
}
function deleteLearning(id){ state.learnings = state.learnings.filter(x=> x.id !== id); saveStateLocal(); renderAll(); }
function renderMindMap(){
  const svg = document.getElementById('mindmap');
  if(!svg) return;
  const bySubject = groupBy(state.learnings, x=> x.subject);
  const subjects = Object.keys(bySubject).sort((a,b)=> a.localeCompare(b,'zh-Hant'));
  let md = '# Â≠∏ÁøíÁ∏ΩË¶Ω\n';
  for(const s of subjects){ md += `## ${s}\n`; const items = bySubject[s].slice().sort((a,b)=> new Date(b.date)-new Date(a.date)).slice(0,20); for(const it of items){ md += `- ${it.title} (${it.date})\n`; } }
  svg.innerHTML = '';
  const { Transformer } = window.markmap;
  const transformer = new Transformer();
  const { root } = transformer.transform(md);
  markmapInstance = window.markmap.Markmap.create(svg,{ autoFit:true, duration:0, maxWidth:240 }, root);
}

/* =========================
   Finance Section
========================= */
let incomePie = null;
let expensePie = null;
function financeTemplate(){
  return `\
    <div class="header">\
      <div class="title">\
        <h2>üí∞ Êî∂ÊîØÁ¥ÄÈåÑ</h2>\
        <p>Êî∂ÂÖ•/ÊîØÂá∫ÂàÜÈñãÂëàÁèæÂúìÈ§ÖÂúñÔºõÊîØÊè¥Ë®ÇÈñ±Ëá™ÂãïÊâ£Ê¨æÔºàÊØèÊúàÊåáÂÆöÊó•Ôºâ„ÄÇ</p>\
      </div>\
      <span class="pill money">Finance</span>\
    </div>\
    <div class="grid">\
      <div class="card">\
        <h3>Êñ∞Â¢û‰∫§Êòì</h3>\
        <div class="form">\
          <div class="row"><label>Êó•Êúü</label><input id="fin_date" type="date" /></div>\
          <div class="row"><label>È°ûÂûã</label><select id="fin_type"><option value="expense">ÊîØÂá∫</option><option value="income">Êî∂ÂÖ•</option></select></div>\
          <div class="row"><label>ÂàÜÈ°û</label><input id="fin_category" placeholder="‰æãÔºöÈ§êÈ£≤ / ‰∫§ÈÄö / ÊàøÁßü / Ëñ™Ë≥á" /></div>\
          <div class="row"><label>ÈáëÈ°ç</label><input id="fin_amount" type="number" min="0" step="1" /></div>\
          <div class="row"><label>ÂÇôË®ª</label><input id="fin_note" placeholder="ÂèØÈÅ∏" /></div>\
          <div class="btns"><button class="btn primary" id="fin_add">Êñ∞Â¢û</button></div>\
        </div>\
        <h3 style="margin-top:12px;">Ë®ÇÈñ±Êâ£Ê¨æÔºàÊØèÊúàÔºâ</h3>\
        <div class="form">\
          <div class="row"><label>ÂêçÁ®±</label><input id="sub_name" placeholder="‰æãÔºöNetflix / iCloud / ÂÅ•Ë∫´Êàø" /></div>\
          <div class="row"><label>ÂàÜÈ°û</label><input id="sub_category" placeholder="‰æãÔºöË®ÇÈñ± / Â∑•ÂÖ∑ / ÂÅ•Ë∫´" /></div>\
          <div class="row"><label>Êâ£Ê¨æÊó•</label><input id="sub_day" type="number" min="1" max="28" step="1" placeholder="Âª∫Ë≠∞ 1-28" /></div>\
          <div class="row"><label>ÈáëÈ°ç</label><input id="sub_amount" type="number" min="0" step="1" /></div>\
          <div class="btns">\
            <button class="btn primary" id="sub_add">Êñ∞Â¢ûË®ÇÈñ±</button>\
            <button class="btn" id="sub_run">ÁîüÊàêÊú¨ÊúàË®ÇÈñ±Êâ£Ê¨æ</button>\
          </div>\
          <div class="hint">Á≥ªÁµ±ÊúÉÂú®‰Ω†ÈñãÂïüÁ∂≤Á´ôÊôÇËá™ÂãïÊ™¢Êü•ÔºöËã•„Äå‰ªäÂ§©Â∑≤Âà∞Êâ£Ê¨æÊó•„Äç‰∏îÊú¨ÊúàÂ∞öÊú™ÁîüÊàêÔºåÂ∞áËá™ÂãïÊñ∞Â¢û‰∏ÄÁ≠ÜÊîØÂá∫„ÄÇ</div>\
        </div>\
      </div>\
      <div class="card">\
        <div class="split">\
          <div>\
            <h3>ÂúìÈ§ÖÂúñÔºöÊîØÂá∫ÂàÜÈ°û</h3>\
            <div class="pie-row">\
              <div class="chart-wrap" style="height:240px;"><canvas id="expense_pie"></canvas></div>\
              <div class="pie-details" id="expense_details"></div>\
            </div>\
          </div>\
          <div>\
            <h3>ÂúìÈ§ÖÂúñÔºöÊî∂ÂÖ•ÂàÜÈ°û</h3>\
            <div class="pie-row">\
              <div class="chart-wrap" style="height:240px;"><canvas id="income_pie"></canvas></div>\
              <div class="pie-details" id="income_details"></div>\
            </div>\
          </div>\
        </div>\
        <div style="margin-top:10px"><h3>ÊúÄËøë‰∫§Êòì</h3><div class="list" id="fin_list"></div></div>\
        <div style="margin-top:10px"><h3>Ë®ÇÈñ±Ê∏ÖÂñÆ</h3><div class="list" id="sub_list"></div></div>\
      </div>\
    </div>\
  `;
}
function renderFinance(){
  const root = document.getElementById('view-finance');
  root.innerHTML = financeTemplate();
  document.getElementById('fin_date').value = toISODate(new Date());
  document.getElementById('fin_add').addEventListener('click', ()=>{
    const date = document.getElementById('fin_date').value;
    const type = document.getElementById('fin_type').value;
    const category = document.getElementById('fin_category').value.trim();
    const amount = Number(document.getElementById('fin_amount').value || 0);
    const note = document.getElementById('fin_note').value.trim();
    if(!date || !category || amount<=0){ alert('Ë´ãËá≥Â∞ëÂ°´ÔºöÊó•Êúü„ÄÅÂàÜÈ°û„ÄÅÈáëÈ°ç(>0)'); return; }
    state.transactions.unshift({ id: uid('t'), date, type, category, amount, note, createdAt: new Date().toISOString() });
    saveStateLocal();
    renderFinance();
  });
  document.getElementById('sub_add').addEventListener('click', ()=>{
    const name = document.getElementById('sub_name').value.trim();
    const category = document.getElementById('sub_category').value.trim();
    const day = Number(document.getElementById('sub_day').value || 0);
    const amount = Number(document.getElementById('sub_amount').value || 0);
    if(!name || !category || day<1 || day>28 || amount<=0){ alert('Ë®ÇÈñ±ÈúÄÂ°´ÔºöÂêçÁ®±„ÄÅÂàÜÈ°û„ÄÅÊâ£Ê¨æÊó•(1-28)„ÄÅÈáëÈ°ç(>0)'); return; }
    state.subscriptions.unshift({ id: uid('s'), name, category, dayOfMonth: day, amount, lastGeneratedMonth: null });
    saveStateLocal();
    renderFinance();
  });
  document.getElementById('sub_run').addEventListener('click', ()=>{ runSubscriptionAutopost(true); renderFinance(); });
  // auto run subscription generation
  runSubscriptionAutopost(false);
  renderFinanceCharts();
  renderFinanceList();
  renderSubscriptionList();
  // Show recommendations section for finance
  renderRecommendations('finance');
}
function runSubscriptionAutopost(manual){
  const now = new Date();
  const month = `${now.getFullYear()}-${pad2(now.getMonth()+1)}`;
  const day = now.getDate();
  let generated = 0;
  for(const s of state.subscriptions){
    const shouldGenerate = (day >= s.dayOfMonth) && (s.lastGeneratedMonth !== month);
    if(shouldGenerate){
      state.transactions.unshift({ id: uid('t'), date: toISODate(now), type:'expense', category: s.category, amount: s.amount, note: `Ë®ÇÈñ±Ôºö${s.name}Ôºà${month}Ôºâ`, createdAt: new Date().toISOString() });
      s.lastGeneratedMonth = month;
      generated++;
    }
  }
  if(generated>0){ saveStateLocal(); if(manual) alert(`Â∑≤ÁîüÊàê ${generated} Á≠ÜÊú¨ÊúàË®ÇÈñ±Êâ£Ê¨æ„ÄÇ`); }
  else{ if(manual) alert('Êú¨ÊúàË®ÇÈñ±Êâ£Ê¨æÁÑ°ÈúÄÁîüÊàêÔºàÂèØËÉΩÂ∞öÊú™Âà∞Êâ£Ê¨æÊó•ÔºåÊàñÂ∑≤ÁîüÊàêÔºâ„ÄÇ'); }
}
function renderFinanceCharts(){
  if(incomePie){ incomePie.destroy(); incomePie = null; }
  if(expensePie){ expensePie.destroy(); expensePie = null; }
  const expenses = state.transactions.filter(t=> t.type==='expense');
  const income = state.transactions.filter(t=> t.type==='income');
  const expenseByCat = groupBy(expenses, t=> t.category);
  const incomeByCat = groupBy(income, t=> t.category);
  const expLabels = Object.keys(expenseByCat).sort((a,b)=> a.localeCompare(b,'zh-Hant'));
  const incLabels = Object.keys(incomeByCat).sort((a,b)=> a.localeCompare(b,'zh-Hant'));
  const expData = expLabels.map(k=> sum(expenseByCat[k].map(x=> x.amount)));
  const incData = incLabels.map(k=> sum(incomeByCat[k].map(x=> x.amount)));
  const expCanvas = document.getElementById('expense_pie');
  const incCanvas = document.getElementById('income_pie');
  expensePie = new Chart(expCanvas, {
    type:'pie',
    data:{ labels: expLabels.length ? expLabels : ['ÔºàÂ∞öÁÑ°ÊîØÂá∫Ôºâ'], datasets:[{ data: expLabels.length ? expData : [1] }] },
    options:{
      plugins:{
        tooltip:{ callbacks:{ label:(ctx)=>{ if(!expLabels.length) return 'Â∞öÁÑ°Ë≥áÊñô'; const v = ctx.parsed; return ` ${ctx.label}: ${v}`; } } }
      }
    }
  });
  incomePie = new Chart(incCanvas, {
    type:'pie',
    data:{ labels: incLabels.length ? incLabels : ['ÔºàÂ∞öÁÑ°Êî∂ÂÖ•Ôºâ'], datasets:[{ data: incLabels.length ? incData : [1] }] },
    options:{
      plugins:{
        tooltip:{ callbacks:{ label:(ctx)=>{ if(!incLabels.length) return 'Â∞öÁÑ°Ë≥áÊñô'; const v = ctx.parsed; return ` ${ctx.label}: ${v}`; } } }
      }
    }
  });
  // update details lists
  const expDetailEl = document.getElementById('expense_details');
  const incDetailEl = document.getElementById('income_details');
  if(expDetailEl){
    if(expLabels.length){
      const totalExp = expData.reduce((a,b)=> a+b, 0) || 1;
      expDetailEl.innerHTML = expLabels.map((lbl, i)=>{
        const val = expData[i];
        const perc = totalExp ? ((val/totalExp)*100).toFixed(1) : '0.0';
        return `<div>${escapeHtml(lbl)}: ${escapeHtml(String(val))} (${perc}%)</div>`;
      }).join('');
    }else{
      expDetailEl.innerHTML = '<div>‚Äî</div>';
    }
  }
  if(incDetailEl){
    if(incLabels.length){
      const totalInc = incData.reduce((a,b)=> a+b, 0) || 1;
      incDetailEl.innerHTML = incLabels.map((lbl, i)=>{
        const val = incData[i];
        const perc = totalInc ? ((val/totalInc)*100).toFixed(1) : '0.0';
        return `<div>${escapeHtml(lbl)}: ${escapeHtml(String(val))} (${perc}%)</div>`;
      }).join('');
    }else{
      incDetailEl.innerHTML = '<div>‚Äî</div>';
    }
  }
}
function renderFinanceList(){
  const list = document.getElementById('fin_list');
  const items = state.transactions.slice().sort((a,b)=> new Date(b.date) - new Date(a.date)).slice(0, 16);
  list.innerHTML = items.map(t=>{
    const sign = (t.type==='expense') ? '-' : '+';
    const tag = (t.type==='expense') ? 'ÊîØÂá∫' : 'Êî∂ÂÖ•';
    return `\
      <div class="item">\
        <div class="meta">\
          <span class="tag"><b>${escapeHtml(tag)}</b></span>\
          <span class="tag">${escapeHtml(t.date)}</span>\
          <span class="tag">${escapeHtml(t.category)}</span>\
          <span class="tag">${sign}${escapeHtml(String(t.amount))}</span>\
        </div>\
        <div class="hint">${t.note ? escapeHtml(t.note) : 'ÔºàÁÑ°ÂÇôË®ªÔºâ'}</div>\
        <div class="btns" style="margin-top:6px"><button class="btn danger" onclick="deleteTransaction('${t.id}')">Âà™Èô§</button></div>\
      </div>\
    `;
  }).join('') || `<div class="hint">Â∞öÁÑ°‰∫§ÊòìÁ¥ÄÈåÑ„ÄÇ</div>`;
}
function deleteTransaction(id){ state.transactions = state.transactions.filter(t=> t.id!==id); saveStateLocal(); renderAll(); }
function renderSubscriptionList(){
  const list = document.getElementById('sub_list');
  const subs = state.subscriptions.slice();
  list.innerHTML = subs.map(s=>{
    return `\
      <div class="item">\
        <div class="meta">\
          <span class="tag"><b>${escapeHtml(s.name)}</b></span>\
          <span class="tag">${escapeHtml(s.category)}</span>\
          <span class="tag">ÊØèÊúà ${escapeHtml(String(s.dayOfMonth))} Êó•</span>\
          <span class="tag">${escapeHtml(String(s.amount))}</span>\
        </div>\
        <div class="hint">Êú¨ÊúàÁîüÊàêÁãÄÊÖãÔºö${s.lastGeneratedMonth ? escapeHtml(s.lastGeneratedMonth) : 'Â∞öÊú™ÁîüÊàê'}</div>\
        <div class="btns" style="margin-top:6px"><button class="btn danger" onclick="deleteSubscription('${s.id}')">Âà™Èô§</button></div>\
      </div>\
    `;
  }).join('') || `<div class="hint">Â∞öÁÑ°Ë®ÇÈñ±„ÄÇ</div>`;
}
function deleteSubscription(id){ state.subscriptions = state.subscriptions.filter(s=> s.id!==id); saveStateLocal(); renderAll(); }

/* =========================
   Render All
========================= */
function renderAll(){
  const active = document.querySelector('.nav button.active')?.dataset.view || 'home';
  if(active === 'fitness') renderFitness();
  else if(active === 'diary') renderDiary();
  else if(active === 'learning') renderLearning();
  else if(active === 'finance') renderFinance();
  else if(active === 'overview') renderOverview();
  else if(active === 'home') renderHome();
  // After rendering, apply collapsible card functionality for sections
  // other than home and learning. The learning section uses its own
  // manual collapse logic defined in renderLearning(), so we skip
  // calling applyCardCollapse for 'learning'.
  if(active !== 'home' && active !== 'learning'){
    applyCardCollapse(active);
  }
}

// On initial load, ensure the home page is visible. Without this, the
// home view remains hidden because it has display:none set in the HTML.
// We call this after renderAll in the boot sequence below.
function showHomeView(){
  const homeEl = document.getElementById('view-home');
  if(homeEl){ homeEl.style.display = 'block'; }
}

// Boot: load collapsed state for recommendations, load data and render
// Boot: load collapse and visited state, then render
loadRecCollapsed();
loadVisitedDate();
state = loadStateLocal();
renderAll();
// Ensure the home page is visible on initial load
showHomeView();
// Initialize navigation collapse toggle and restore previous state
(() => {
  const navBtn = document.getElementById('navToggle');
  const topnavEl = document.querySelector('.topnav');
  if(navBtn && topnavEl){
    // restore collapsed state from localStorage
    let collapsed = false;
    try{
      collapsed = localStorage.getItem('navCollapsed') === '1';
    }catch(e){ collapsed = false; }
    if(collapsed){ topnavEl.classList.add('collapsed'); navBtn.textContent = '‚ò∞'; }
    else{ navBtn.textContent = '‚úï'; }
    navBtn.addEventListener('click', ()=>{
      const isCollapsed = !topnavEl.classList.contains('collapsed');
      topnavEl.classList.toggle('collapsed', isCollapsed);
      navBtn.textContent = isCollapsed ? '‚ò∞' : '‚úï';
      try{
        localStorage.setItem('navCollapsed', isCollapsed ? '1' : '0');
      }catch(e){}
    });
  }
})();

// Attach click handler for the Home button to return to the landing page.
// This handler hides all other views, deselects any active nav buttons,
// shows the home view and re-renders it to update glow status based on
// whether each category has new entries today. It runs immediately
// during boot once the DOM is ready. Without this, clicking the home
// button would have no effect.
(function(){
  const homeBtn = document.getElementById('homeBtn');
  if(homeBtn){
    homeBtn.addEventListener('click', () => {
      switchToView('home');
    });
  }
})();
</script>
</body>
</html>