<!doctype html>
<!--
  Personal Log (Mobile Only)

  This singleâ€‘page web application replicates the functionality and design of the
  original multiâ€‘device Personal Log, but is simplified to run entirely on a
  single device with no dependencies on Firebase or any external backend.
  All data is stored in the browser's LocalStorage. The UI remains
  responsive but focuses on mobile usage â€” the layout defaults to a single
  column on small screens and collapses navigation into a simple list at
  the top of the page.

  To deploy this site for personal use, simply upload this file as
  index.html to any static host (GitHub Pages, Netlify, Vercel) or open it
  directly on your phone.
-->
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Personal Log (Mobile) | å¥èº«ãƒ»æ—¥è¨˜ãƒ»å­¸ç¿’ãƒ»æ”¶æ”¯</title>

  <!-- Chart.js for charts -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <!-- Markmap for mind maps -->
  <script src="https://cdn.jsdelivr.net/npm/markmap-lib@0.17.2/dist/browser/index.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/markmap-view@0.17.2/dist/browser/index.min.js"></script>

  <style>
    /*
      THEME & VARIABLES

      A warm palette with moderate brightness and lowâ€“medium saturation. Each
      functional category has its own accent colour. The layout adapts to
      mobile first: on small screens, content is presented in a single
      column, and navigation controls are stacked for easy thumb reach.
    */
    :root{
      --bg: #f6f2ee;
      --panel: #fffaf5;
      --card: #ffffff;
      --text: #2a2521;
      --muted: #6f655c;
      --border: rgba(60,45,35,.12);
      --shadow: 0 8px 20px rgba(30,20,10,.10);
      --shadow2: 0 4px 12px rgba(30,20,10,.08);

      --fit: #ffb277;
      --diary: #ff8ea1;
      --learn: #7fd2b8;
      --money: #7bb2ff;
      --accent: #d2794a;
      --danger: #c84c4c;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans TC", "PingFang TC", "Microsoft JhengHei", Arial, sans-serif;
      background: radial-gradient(900px 500px at 30% -5%, rgba(210,121,74,.12), transparent 55%),
                  radial-gradient(700px 400px at 90% 15%, rgba(123,178,255,.12), transparent 50%),
                  var(--bg);
      color:var(--text);
    }
    /* Layout container: sidebar replaced by top nav for mobile. */
    .app{
      display:flex;
      flex-direction:column;
      min-height:100vh;
    }
    /* Top navigation bar */
    .topnav{
      display:flex;
      flex-direction:column;
      padding:12px 16px;
      background: linear-gradient(180deg, rgba(255,250,245,.92), rgba(246,242,238,.90));
      border-bottom:1px solid var(--border);
      position:sticky;
      top:0;
      z-index:10;
      backdrop-filter:blur(6px);
    }
    .brand{
      display:flex;
      align-items:center;
      gap:10px;
    }
    .brand h1{
      font-size:16px;
      margin:0;
    }
    .brand p{
      margin:2px 0 0;
      font-size:12px;
      color:var(--muted);
      line-height:1.4;
    }
    .nav{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-top:10px;
    }
    .nav button{
      flex:1 1 calc(50% - 8px);
      display:flex;
      align-items:center;
      gap:8px;
      padding:8px 12px;
      border-radius:12px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.60);
      cursor:pointer;
      text-align:left;
      transition:.15s transform, .15s background;
    }
    .nav button:hover{transform: translateY(-1px); background: rgba(255,255,255,.75);}    
    .nav button.active{
      background: rgba(255,255,255,.92);
      border-color: rgba(210,121,74,.35);
      box-shadow: var(--shadow2);
    }
    .dot{width:8px;height:8px;border-radius:99px;}
    .dot.fit{background:var(--fit)}
    .dot.diary{background:var(--diary)}
    .dot.learn{background:var(--learn)}
    .dot.money{background:var(--money)}
    .small{font-size:11px;color:var(--muted)}
    .top-actions{
      display:flex;
      gap:6px;
      margin-top:10px;
      flex-wrap:wrap;
    }
    .top-actions button, .top-actions label{
      flex:1 1 calc(50% - 6px);
      border:1px solid var(--border);
      background: rgba(255,255,255,.55);
      border-radius:10px;
      padding:8px 10px;
      cursor:pointer;
      font-size:12px;
      text-align:center;
    }
    .top-actions button:hover, .top-actions label:hover{background: rgba(255,255,255,.70);}    
    .top-actions input{display:none}

    .main{
      flex:1;
      padding:16px;
      width:100%;
      max-width:900px;
      margin:0 auto;
    }
    .header{
      display:flex;
      justify-content:space-between;
      align-items:flex-end;
      margin-bottom:12px;
    }
    .title h2{margin:0;font-size:20px;letter-spacing:.2px}
    .title p{margin:4px 0 0;color:var(--muted);font-size:12px}
    .pill{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:4px 8px;
      border-radius:99px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.65);
      font-size:12px;
      color:var(--muted);
    }
    .pill.fit{border-color:rgba(255,178,119,.35)}
    .pill.diary{border-color:rgba(255,142,161,.35)}
    .pill.learn{border-color:rgba(127,210,184,.35)}
    .pill.money{border-color:rgba(123,178,255,.35)}
    .grid{
      display:flex;
      flex-direction:column;
      gap:14px;
    }
    .card{
      border:1px solid var(--border);
      background: rgba(255,255,255,.78);
      border-radius:16px;
      box-shadow: var(--shadow2);
      padding:12px;
    }
    .form{
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .row{
      display:flex;
      gap:8px;
      align-items:center;
    }
    .row label{
      width:90px;
      font-size:12px;
      color:var(--muted);
    }
    input, select, textarea{
      flex:1;
      border:1px solid var(--border);
      border-radius:10px;
      padding:8px 8px;
      background: rgba(255,255,255,.85);
      color:var(--text);
      outline:none;
      font-size:13px;
    }
    textarea{min-height:80px; resize:vertical; line-height:1.4}
    .btns{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
    }
    .btn{
      flex:1;
      border:1px solid var(--border);
      border-radius:10px;
      padding:8px 10px;
      cursor:pointer;
      background: rgba(255,255,255,.75);
      font-size:12px;
    }
    .btn.primary{
      background: rgba(210,121,74,.18);
      border-color: rgba(210,121,74,.35);
    }
    .btn.danger{
      background: rgba(200,76,76,.14);
      border-color: rgba(200,76,76,.30);
      color:#7a1f1f;
    }
    .btn:hover{background: rgba(255,255,255,.88)}
    .btn.primary:hover{background: rgba(210,121,74,.22)}
    .btn.danger:hover{background: rgba(200,76,76,.18)}

    .list{display:flex;flex-direction:column;gap:8px;}
    .item{
      border:1px solid var(--border);
      background: rgba(255,255,255,.78);
      border-radius:14px;
      padding:10px;
      box-shadow: var(--shadow2);
    }
    .meta{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      font-size:11px;
      color:var(--muted);
      margin-bottom:4px;
    }
    .meta b{color:var(--text); font-weight:600;}
    .tag{
      display:inline-flex;
      align-items:center;
      gap:4px;
      padding:2px 6px;
      border-radius:99px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.65);
      font-size:11px;
      color:var(--muted);
    }
    .kpi{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
    }
    .kpi .box{
      flex:1;
      border:1px solid var(--border);
      background: rgba(255,255,255,.70);
      border-radius:14px;
      padding:8px;
      min-width:70px;
    }
    .kpi .n{font-size:14px;font-weight:700;margin-top:2px}
    .kpi .t{font-size:11px;color:var(--muted)}

    .split{
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .folder{
      border:1px solid var(--border);
      border-radius:14px;
      background: rgba(255,255,255,.65);
      padding:8px;
    }
    .folder h4{
      margin:0 0 6px;
      font-size:11px;
      color:var(--muted);
      letter-spacing:.2px;
    }
    .tree{
      display:flex;
      flex-direction:column;
      gap:6px;
      max-height:260px;
      overflow:auto;
      padding-right:2px;
    }
    .tree button{
      border:1px solid var(--border);
      background: rgba(255,255,255,.70);
      border-radius:10px;
      padding:6px 8px;
      cursor:pointer;
      font-size:11px;
      color:var(--text);
      text-align:left;
    }
    .tree button.active{
      border-color: rgba(210,121,74,.35);
      background: rgba(255,255,255,.85);
    }
    .hint{font-size:11px;color:var(--muted);line-height:1.4}
    canvas{max-width:100%;}
    .chart-wrap{
      border:1px solid var(--border);
      background: rgba(255,255,255,.70);
      border-radius:14px;
      padding:8px;
      box-shadow: var(--shadow2);
    }

    /* Details list next to pie charts */
    .pie-details{
      /* Use larger, bold text for clarity */
      font-size:18px;
      font-weight:700;
      color:var(--text);
      line-height:1.6;
      /* Remove top margin so it can sit flush next to chart when in a flex row */
      margin-top:0;
    }

    /* Layout for chart and its details to appear side by side */
    .pie-row{
      display:flex;
      align-items:center;
      gap:12px;
      flex-wrap:nowrap;
    }
    /* Ensure chart and details each occupy roughly half of the row */
    .pie-row .chart-wrap{
      flex:0 0 50%;
    }
    .pie-row .pie-details{
      flex:0 0 50%;
      min-width:0;
    }
    .table{
      width:100%;
      border-collapse:separate;
      border-spacing:0 4px;
      font-size:11px;
    }
    .table th{
      text-align:left;
      color:var(--muted);
      font-weight:600;
      padding:0 4px;
    }
    .table td{
      padding:6px 4px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.68);
      border-radius:8px;
    }
    .right{text-align:right;}
  </style>
</head>
<body>
<div class="app">
  <header class="topnav">
    <div class="brand">
      <div style="font-size:18px;line-height:1">ğŸ—‚ï¸</div>
      <div>
        <h1>Personal Log</h1>
        <p>å¥èº«ãƒ»æ—¥è¨˜ãƒ»å­¸ç¿’ãƒ»æ”¶æ”¯<br/>è³‡æ–™åƒ…å­˜æ–¼æœ¬æ©Ÿç€è¦½å™¨</p>
      </div>
    </div>
    <div class="nav" id="nav">
      <button data-view="fitness" class="active"><span class="dot fit"></span> ğŸ‹ï¸ å¥èº« <span class="small">Workout</span></button>
      <button data-view="diary"><span class="dot diary"></span> ğŸ““ æ—¥è¨˜ <span class="small">Diary</span></button>
      <button data-view="learning"><span class="dot learn"></span> ğŸ“š å­¸ç¿’ <span class="small">Learning</span></button>
      <button data-view="finance"><span class="dot money"></span> ğŸ’° æ”¶æ”¯ <span class="small">Finance</span></button>
    </div>
    <div class="top-actions">
      <button id="btnExport">åŒ¯å‡ºè³‡æ–™</button>
      <button id="btnExportImage">åŒ¯å‡ºåœ–åƒ</button>
      <label for="importFile">åŒ¯å…¥è³‡æ–™<input id="importFile" type="file" accept="application/json"/></label>
      <button id="btnReset" class="danger" style="flex-basis:100%">æ¸…é™¤æ‰€æœ‰è³‡æ–™</button>
    </div>
    <div style="margin-top:8px" class="hint">å»ºè­°ï¼šå¶çˆ¾åŒ¯å‡ºå‚™ä»½ã€‚è‹¥æ¸…é™¤ç€è¦½å™¨è³‡æ–™ï¼Œæœ¬ç¶²ç«™è¨˜éŒ„ä¹Ÿæœƒä¸€ä½µæ¶ˆå¤±ã€‚</div>
  </header>
  <main class="main">
    <div id="view-fitness" class="view"></div>
    <div id="view-diary" class="view" style="display:none"></div>
    <div id="view-learning" class="view" style="display:none"></div>
    <div id="view-finance" class="view" style="display:none"></div>
  </main>

  <!-- Export Image Modal -->
  <div id="exportImageModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000; align-items:center; justify-content:center;">
    <div style="background:#fffaf5; border-radius:12px; padding:16px; width:90%; max-width:340px; box-shadow: var(--shadow2);">
      <h3 style="margin-top:0; font-size:16px;">é¸æ“‡åœ–åƒåŒ¯å‡ºåˆ†é¡</h3>
      <div style="display:flex; flex-direction:column; gap:8px; margin-bottom:12px;">
        <label style="display:flex; align-items:center; gap:6px;">
          <input type="checkbox" id="export_all" /> <span>å…¨é¸</span>
        </label>
        <label style="display:flex; align-items:center; gap:6px;">
          <input type="checkbox" class="export-cat" value="fitness" /> <span>å¥èº«</span>
        </label>
        <label style="display:flex; align-items:center; gap:6px;">
          <input type="checkbox" class="export-cat" value="diary" /> <span>æ—¥è¨˜</span>
        </label>
        <label style="display:flex; align-items:center; gap:6px;">
          <input type="checkbox" class="export-cat" value="learning" /> <span>å­¸ç¿’</span>
        </label>
        <label style="display:flex; align-items:center; gap:6px;">
          <input type="checkbox" class="export-cat" value="finance" /> <span>æ”¶æ”¯</span>
        </label>
      </div>
      <div style="display:flex; gap:10px; justify-content:flex-end;">
        <button id="exportImageCancel" class="btn" style="padding:6px 12px; border:1px solid var(--border); border-radius:10px; background: rgba(255,255,255,.60);">å–æ¶ˆ</button>
        <button id="exportImageConfirm" class="btn primary" style="padding:6px 12px; border:1px solid rgba(210,121,74,.35); border-radius:10px; background: rgba(210,121,74,.18);">åŒ¯å‡º</button>
      </div>
    </div>
  </div>
</div>

<script>
/* =========================
   Local Storage & State Management
   This mobile version stores all records in the browser's LocalStorage. Each
   category is stored as an array under a single key. There is no remote
   synchronisation.
========================= */
const STORAGE_KEY = 'personal_log_mobile_v1';
const defaultState = () => ({ workouts: [], diaries: [], learnings: [], transactions: [], subscriptions: [] });
let state = defaultState();
function saveStateLocal(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }
function loadStateLocal(){ try{ const raw = localStorage.getItem(STORAGE_KEY); if(!raw) return defaultState(); const parsed = JSON.parse(raw); return Object.assign(defaultState(), parsed); }catch(e){ return defaultState(); }}

/* =========================
   Utilities
========================= */
function uid(prefix='id'){ return prefix + '_' + Math.random().toString(16).slice(2) + '_' + Date.now().toString(16); }
function pad2(n){ return String(n).padStart(2,'0'); }
function toISODate(d){ const y=d.getFullYear(), m=pad2(d.getMonth()+1), day=pad2(d.getDate()); return `${y}-${m}-${day}`; }
function toMonthKey(dateStr){ const d=new Date(dateStr); const y=d.getFullYear(), m=pad2(d.getMonth()+1); return `${y}-${m}`; }
function fmtDateTime(dateStr){ const d=new Date(dateStr); if(Number.isNaN(d.getTime())) return dateStr; return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())} ${pad2(d.getHours())}:${pad2(d.getMinutes())}`; }
function fmtMinutes(min){ const h=Math.floor(min/60); const m=min%60; if(h<=0) return `${m} åˆ†`; if(m===0) return `${h} å°æ™‚`; return `${h} å°æ™‚ ${m} åˆ†`; }
function diffMinutes(startHHMM,endHHMM){ const [sh,sm]=startHHMM.split(':').map(Number); const [eh,em]=endHHMM.split(':').map(Number); let start=sh*60+sm; let end=eh*60+em; if(end<start) end+=24*60; return end-start; }
function sum(arr){ return arr.reduce((a,b)=>a+b,0); }
function groupBy(arr,keyFn){ return arr.reduce((acc,x)=>{ const k=keyFn(x); (acc[k] ||= []).push(x); return acc; },{}); }
function escapeHtml(str){ return String(str).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'",'&#39;'); }

/* =========================
   Navigation & Top Controls
========================= */
const nav = document.getElementById('nav');
nav.addEventListener('click', (e)=>{
  const btn = e.target.closest('button[data-view]');
  if(!btn) return;
  const view = btn.dataset.view;
  document.querySelectorAll('.nav button').forEach(b=> b.classList.toggle('active', b===btn));
  document.querySelectorAll('.view').forEach(v=> v.style.display='none');
  document.getElementById('view-'+view).style.display='block';
  renderAll();
});

document.getElementById('btnExport').addEventListener('click', ()=>{
  const blob = new Blob([JSON.stringify(state,null,2)], {type:'application/json'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `personal_log_mobile_backup_${toISODate(new Date())}.json`;
  a.click();
  URL.revokeObjectURL(a.href);
});

document.getElementById('importFile').addEventListener('change', async (e)=>{
  const f = e.target.files?.[0];
  if(!f) return;
  try{
    const text = await f.text();
    const imported = JSON.parse(text);
    state = Object.assign(defaultState(), imported);
    saveStateLocal();
    renderAll();
    alert('åŒ¯å…¥å®Œæˆ');
  }catch(err){ alert('åŒ¯å…¥å¤±æ•—ï¼šæª”æ¡ˆæ ¼å¼ä¸æ­£ç¢º'); }
  finally{ e.target.value=''; }
});

document.getElementById('btnReset').addEventListener('click', ()=>{
  if(!confirm('ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰è³‡æ–™ï¼Ÿæ­¤æ“ä½œä¸å¯é‚„åŸã€‚')) return;
  state = defaultState();
  saveStateLocal();
  renderAll();
});

// =========================
//   Export Image Feature
// =========================
document.getElementById('btnExportImage').addEventListener('click', ()=>{
  // Show modal and reset selections
  const modal = document.getElementById('exportImageModal');
  modal.style.display = 'flex';
  document.getElementById('export_all').checked = false;
  modal.querySelectorAll('.export-cat').forEach(ch => ch.checked = false);
});
// "Select All" checkbox toggles all categories
document.getElementById('export_all').addEventListener('change', (e)=>{
  const checked = e.target.checked;
  document.querySelectorAll('#exportImageModal .export-cat').forEach(ch => ch.checked = checked);
});
// Cancel export: hide modal
document.getElementById('exportImageCancel').addEventListener('click', ()=>{
  document.getElementById('exportImageModal').style.display = 'none';
});
// Confirm export: gather selected categories and export images
document.getElementById('exportImageConfirm').addEventListener('click', ()=>{
  const cats = [];
  document.querySelectorAll('#exportImageModal .export-cat:checked').forEach(ch => cats.push(ch.value));
  document.getElementById('exportImageModal').style.display = 'none';
  if(cats.length === 0){ alert('è«‹è‡³å°‘é¸æ“‡ä¸€å€‹åˆ†é¡'); return; }
  exportSelectedImages(cats);
});

function downloadURI(uri, name){
  const a = document.createElement('a');
  a.href = uri;
  a.download = name;
  a.click();
}
async function exportSelectedImages(cats){
  const date = toISODate(new Date());
  const tasks = [];
  // Export fitness chart as is
  if(cats.includes('fitness') && fitnessLineChart){
    try{
      const uri = fitnessLineChart.toBase64Image();
      downloadURI(uri, `fitness_chart_${date}.png`);
    }catch(err){ console.warn(err); }
  }
  // Export finance charts with details
  if(cats.includes('finance')){
    if(expensePie){ tasks.push(exportPieWithDetails('expense', `finance_expense_pie_${date}.png`)); }
    if(incomePie){ tasks.push(exportPieWithDetails('income', `finance_income_pie_${date}.png`)); }
  }
  // Wait for all async exports
  if(tasks.length){ await Promise.all(tasks); }
  // Notify for categories without charts
  const noChart = cats.filter(c => c === 'diary' || c === 'learning');
  if(noChart.length > 0){
    alert('æ‰€é¸åˆ†é¡ï¼ˆ' + noChart.join('ã€') + 'ï¼‰ç›®å‰æ²’æœ‰åœ–è¡¨å¯ä»¥åŒ¯å‡ºã€‚');
  }
}

// Helper: export pie chart with its details appended on the right.
function exportPieWithDetails(type, filename){
  return new Promise((resolve)=>{
    let chart = null;
    if(type === 'expense'){ chart = expensePie; }
    else if(type === 'income'){ chart = incomePie; }
    if(!chart){ resolve(); return; }
    const canvas = chart.canvas; // Chart.js instance exposes the underlying canvas
    const cw = canvas.width;
    const ch = canvas.height;
    // Compute details for this type from current state
    const items = state.transactions.filter(t => t.type === type);
    const byCat = groupBy(items, t => t.category);
    const labels = Object.keys(byCat).sort((a,b)=> a.localeCompare(b, 'zh-Hant'));
    const data = labels.map(l => sum(byCat[l].map(x => x.amount)));
    const total = data.reduce((a,b)=> a+b, 0) || 1;
    const detailLines = labels.map((lbl,i) => {
      const val = data[i];
      const perc = ((val/total)*100).toFixed(1);
      return `${lbl}: ${val} (${perc}%)`;
    });
    // Prepare new canvas: left half for chart, right half for details (50/50 split)
    const newCanvas = document.createElement('canvas');
    newCanvas.width = cw * 2;
    newCanvas.height = ch;
    const ctx = newCanvas.getContext('2d');
    // Fill background with white to avoid transparent background
    ctx.fillStyle = '#ffffff';
    ctx.fillRect(0, 0, newCanvas.width, newCanvas.height);
    const img = new Image();
    img.onload = function(){
      // Draw original chart in left half
      ctx.drawImage(img, 0, 0, cw, ch);
      // Draw details text occupying right half
      ctx.font = 'bold 20px sans-serif';
      ctx.fillStyle = '#000000';
      // Start drawing a bit lower to account for larger font
      let y = 50;
      const startX = cw + 20;
      const lineHeight = 34;
      detailLines.forEach(line => {
        ctx.fillText(line, startX, y);
        y += lineHeight;
      });
      const uri = newCanvas.toDataURL('image/png');
      downloadURI(uri, filename);
      resolve();
    };
    // Use Chart.js API to get image; fallback to canvas.toDataURL
    try{
      img.src = chart.toBase64Image();
    }catch(err){
      img.src = canvas.toDataURL('image/png');
    }
  });
}

/* =========================
   Fitness (Workout) Section
========================= */
let fitnessLineChart = null;
function fitnessTemplate(){
  return `\
    <div class="header">\
      <div class="title">\
        <h2>ğŸ‹ï¸ å¥èº«ç´€éŒ„</h2>\
        <p>è¼¸å…¥é–‹å§‹/çµæŸ/ä¼‘æ¯ï¼Œç³»çµ±è‡ªå‹•ç®—å¯¦éš›è¨“ç·´æ™‚é–“ï¼Œä¸¦ä»¥ã€Œæœˆã€ç‚ºå–®ä½æ•´ç†é‡é‡é€²æ­¥ã€‚</p>\
      </div>\
      <span class="pill fit">Workout</span>\
    </div>\
    <div class="grid">\
      <div class="card">\
        <h3>æ–°å¢è¨“ç·´</h3>\
        <div class="form">\
          <div class="row"><label>æ—¥æœŸ</label><input id="fit_date" type="date" /></div>\
          <div class="row"><label>å‹•ä½œ/é …ç›®</label><input id="fit_exercise" placeholder="ä¾‹ï¼šæ·±è¹² / å§æ¨ / ç¡¬èˆ‰" /></div>\
          <div class="row"><label>é–‹å§‹æ™‚é–“</label><input id="fit_start" type="time" /></div>\
          <div class="row"><label>çµæŸæ™‚é–“</label><input id="fit_end" type="time" /></div>\
          <div class="row"><label>ä¼‘æ¯æ™‚é–“</label><input id="fit_rest" type="number" min="0" step="1" placeholder="åˆ†é˜" /></div>\
          <div class="row"><label>é‡é‡</label><input id="fit_weight" type="number" min="0" step="0.5" placeholder="kg" /></div>\
          <div class="row"><label>å‚™è¨»</label><input id="fit_note" placeholder="å¯é¸" /></div>\
          <div class="btns">\
            <button class="btn primary" id="fit_add">æ–°å¢</button>\
            <button class="btn" id="fit_fill_now">è‡ªå‹•å¸¶å…¥ä»Šå¤©</button>\
          </div>\
          <div class="hint">\
            å¯¦éš›è¨“ç·´æ™‚é–“ = (çµæŸ-é–‹å§‹) - ä¼‘æ¯æ™‚é–“ã€‚<br/>\
            è‹¥çµæŸæ™‚é–“æ—©æ–¼é–‹å§‹æ™‚é–“ï¼Œè¦–ç‚ºè·¨æ—¥ï¼ˆä¾‹å¦‚ 23:30 åˆ° 00:30ï¼‰ã€‚\
          </div>\
        </div>\
      </div>\
      <div class="card">\
        <div class="split">\
          <div>\
            <h3>é€²æ­¥æŠ˜ç·šåœ–ï¼ˆé‡é‡ / æœˆï¼‰</h3>\
            <div class="row" style="gap:8px">\
              <label style="width:80px">é¸æ“‡å‹•ä½œ</label>\
              <select id="fit_chart_exercise"></select>\
            </div>\
            <div class="chart-wrap"><canvas id="fit_line"></canvas></div>\
          </div>\
          <div>\
            <h3>æœˆåº¦æ‘˜è¦</h3>\
            <div class="hint" style="margin-bottom:6px;">å³è¡¨é¡¯ç¤ºæ¯æœˆã€Œæœ€é«˜é‡é‡ã€èˆ‡ç›¸å°ä¸Šæœˆé€²æ­¥å¹…åº¦ï¼ˆÎ”ï¼‰ã€‚</div>\
            <table class="table" id="fit_table">\
              <thead><tr><th>æœˆä»½</th><th>é‡é‡</th><th>Î”</th></tr></thead>\
              <tbody></tbody>\
            </table>\
          </div>\
        </div>\
        <div style="margin-top:10px">\
          <h3>æœ€è¿‘ç´€éŒ„</h3>\
          <div class="list" id="fit_list"></div>\
        </div>\
      </div>\
    </div>\
  `;
}
function renderFitness(){
  const root = document.getElementById('view-fitness');
  root.innerHTML = fitnessTemplate();
  // defaults
  const today = new Date();
  document.getElementById('fit_date').value = toISODate(today);
  document.getElementById('fit_rest').value = 0;
  document.getElementById('fit_fill_now').addEventListener('click', ()=>{ document.getElementById('fit_date').value = toISODate(new Date()); });
  document.getElementById('fit_add').addEventListener('click', ()=>{
    const date = document.getElementById('fit_date').value;
    const exercise = document.getElementById('fit_exercise').value.trim();
    const start = document.getElementById('fit_start').value;
    const end = document.getElementById('fit_end').value;
    const rest = Number(document.getElementById('fit_rest').value || 0);
    const weight = Number(document.getElementById('fit_weight').value || 0);
    const note = document.getElementById('fit_note').value.trim();
    if(!date || !exercise || !start || !end){ alert('è«‹è‡³å°‘å¡«ï¼šæ—¥æœŸã€å‹•ä½œã€é–‹å§‹æ™‚é–“ã€çµæŸæ™‚é–“'); return; }
    const duration = Math.max(0, diffMinutes(start, end) - rest);
    const item = { id: uid('w'), date, exercise, start, end, restMinutes: rest, durationMinutes: duration, weight, note, createdAt: new Date().toISOString() };
    state.workouts.unshift(item);
    saveStateLocal();
    renderFitness();
  });
  // chart exercise dropdown
  const exSet = new Set(state.workouts.map(w=> w.exercise));
  const exList = Array.from(exSet).sort((a,b)=> a.localeCompare(b, 'zh-Hant'));
  const sel = document.getElementById('fit_chart_exercise');
  if(exList.length === 0){ sel.innerHTML = `<option value="">ï¼ˆå°šç„¡è³‡æ–™ï¼‰</option>`; }
  else{ sel.innerHTML = exList.map(x=> `<option value="${escapeHtml(x)}">${escapeHtml(x)}</option>`).join(''); }
  sel.addEventListener('change', ()=> drawFitnessChart(sel.value));
  drawFitnessChart(exList[0] || '');
  renderFitnessList();
}
function renderFitnessList(){
  const list = document.getElementById('fit_list');
  const items = state.workouts.slice(0, 12);
  list.innerHTML = items.map(w=>{
    const meta = [
      `<span class="tag"><b>${escapeHtml(w.exercise)}</b></span>`,
      `<span class="tag">${escapeHtml(w.date)}</span>`,
      `<span class="tag">${escapeHtml(w.start)}â€“${escapeHtml(w.end)}</span>`,
      `<span class="tag">ä¼‘æ¯ ${escapeHtml(String(w.restMinutes))} åˆ†</span>`,
      `<span class="tag">å¯¦éš› ${fmtMinutes(w.durationMinutes)}</span>`,
      `<span class="tag">é‡é‡ ${escapeHtml(String(w.weight))} kg</span>`
    ].join(' ');
    return `\
      <div class="item">\
        <div class="meta">${meta}</div>\
        ${w.note ? `<div class="hint">${escapeHtml(w.note)}</div>` : `<div class="hint">ï¼ˆç„¡å‚™è¨»ï¼‰</div>`}\
        <div class="btns" style="margin-top:6px"><button class="btn danger" onclick="deleteWorkout('${w.id}')">åˆªé™¤</button></div>\
      </div>\
    `;
  }).join('') || `<div class="hint">å°šç„¡å¥èº«ç´€éŒ„ã€‚</div>`;
}
function deleteWorkout(id){ state.workouts = state.workouts.filter(w=> w.id!==id); saveStateLocal(); renderAll(); }
function drawFitnessChart(exercise){
  if(fitnessLineChart){ fitnessLineChart.destroy(); fitnessLineChart = null; }
  const canvas = document.getElementById('fit_line');
  if(!exercise){ canvas.getContext('2d').clearRect(0,0,canvas.width,canvas.height); document.querySelector('#fit_table tbody').innerHTML = ''; return; }
  const filtered = state.workouts.filter(w=> w.exercise === exercise);
  const byMonth = groupBy(filtered, w=> toMonthKey(w.date));
  const months = Object.keys(byMonth).sort();
  const weights = months.map(m=>{
    const maxW = Math.max(...byMonth[m].map(x=> Number(x.weight || 0)));
    return maxW;
  });
  // build table
  const tbody = document.querySelector('#fit_table tbody');
  let prev = null;
  tbody.innerHTML = months.map((m,i)=>{
    const w = weights[i];
    const delta = (prev === null) ? '' : (w - prev);
    const deltaTxt = (prev === null) ? 'â€”' : (delta >= 0 ? `+${delta}` : `${delta}`);
    prev = w;
    return `<tr><td>${escapeHtml(m)}</td><td>${escapeHtml(String(w))} kg</td><td>${escapeHtml(deltaTxt)} kg</td></tr>`;
  }).join('');
  fitnessLineChart = new Chart(canvas, { type:'line', data:{ labels: months, datasets:[{ label:'æœˆæœ€é«˜é‡é‡ (kg)', data: weights, tension:0.25, pointRadius:3, pointHoverRadius:4, fill:false }] }, options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{ display:true }, tooltip:{ callbacks:{ label:(ctx)=>` ${ctx.parsed.y} kg` } } }, scales:{ y:{ beginAtZero:true } } } });
  canvas.parentElement.style.height = '240px';
}

/* =========================
   Diary Section
========================= */
let diaryFilter = { month:'ALL', mood:'ALL' };
function diaryTemplate(){
  return `\
    <div class="header">\
      <div class="title">\
        <h2>ğŸ““ æ—¥è¨˜</h2>\
        <p>è‡ªå‹•æŒ‰ã€Œæœˆä»½ã€èˆ‡ã€Œå¿ƒæƒ…ã€å»ºç«‹è³‡æ–™å¤¾ï¼Œæ–¹ä¾¿å›æº¯èˆ‡æŸ¥æ‰¾ã€‚</p>\
      </div>\
      <span class="pill diary">Diary</span>\
    </div>\
    <div class="grid">\
      <div class="card">\
        <h3>æ–°å¢æ—¥è¨˜</h3>\
        <div class="form">\
          <div class="row"><label>æ™‚é–“</label><input id="diary_time" type="datetime-local" /></div>\
          <div class="row"><label>å¿ƒæƒ…</label><select id="diary_mood">\
            <option value="é–‹å¿ƒ">é–‹å¿ƒ</option><option value="å¹³éœ">å¹³éœ</option><option value="ç„¦æ…®">ç„¦æ…®</option><option value="ä½è½">ä½è½</option><option value="æ†¤æ€’">æ†¤æ€’</option><option value="ç–²å€¦">ç–²å€¦</option><option value="å°ˆæ³¨">å°ˆæ³¨</option><option value="å…¶ä»–">å…¶ä»–</option>\
          </select></div>\
          <div class="row"><label>å…§å®¹</label><textarea id="diary_text" placeholder="å¯«é»ä»€éº¼â€¦"></textarea></div>\
          <div class="btns"><button class="btn primary" id="diary_add">æ–°å¢</button></div>\
        </div>\
      </div>\
      <div class="card">\
        <div class="split">\
          <div class="folder">\
            <h4>è³‡æ–™å¤¾ï¼ˆæœˆä»½ / å¿ƒæƒ…ï¼‰</h4>\
            <div class="tree" id="diary_tree"></div>\
            <div class="hint" style="margin-top:6px;">é»é¸è³‡æ–™å¤¾å³å¯å¥—ç”¨ç¯©é¸ã€‚</div>\
          </div>\
          <div>\
            <h3>æ¸…å–®</h3>\
            <div class="kpi">\
              <div class="box"><div class="t">ç›®å‰ç¯©é¸</div><div class="n" id="diary_kpi_filter">â€”</div></div>\
              <div class="box"><div class="t">ç­†æ•¸</div><div class="n" id="diary_kpi_count">0</div></div>\
              <div class="box"><div class="t">æœ€æ—©</div><div class="n" id="diary_kpi_min">â€”</div></div>\
              <div class="box"><div class="t">æœ€è¿‘</div><div class="n" id="diary_kpi_max">â€”</div></div>\
            </div>\
            <div class="btns" style="margin-top:8px"><button class="btn" id="diary_clear_filter">æ¸…é™¤ç¯©é¸</button></div>\
            <div class="list" id="diary_list" style="margin-top:8px"></div>\
          </div>\
        </div>\
      </div>\
    </div>\
  `;
}
function renderDiary(){
  const root = document.getElementById('view-diary');
  root.innerHTML = diaryTemplate();
  const now = new Date();
  const dt = `${toISODate(now)}T${pad2(now.getHours())}:${pad2(now.getMinutes())}`;
  document.getElementById('diary_time').value = dt;
  document.getElementById('diary_add').addEventListener('click', ()=>{
    const time = document.getElementById('diary_time').value;
    const mood = document.getElementById('diary_mood').value;
    const text = document.getElementById('diary_text').value.trim();
    if(!time || !text){ alert('è«‹è‡³å°‘å¡«ï¼šæ™‚é–“ã€å…§å®¹'); return; }
    state.diaries.unshift({ id: uid('d'), time: new Date(time).toISOString(), mood, text, createdAt: new Date().toISOString() });
    saveStateLocal();
    renderDiary();
  });
  document.getElementById('diary_clear_filter').addEventListener('click', ()=>{ diaryFilter = { month:'ALL', mood:'ALL' }; renderDiary(); });
  renderDiaryTree();
  renderDiaryList();
}
function renderDiaryTree(){
  const tree = document.getElementById('diary_tree');
  const diaries = state.diaries.slice().sort((a,b)=> new Date(b.time) - new Date(a.time));
  const byMonth = groupBy(diaries, d=> toMonthKey(d.time));
  const months = Object.keys(byMonth).sort().reverse();
  const buttons = [];
  buttons.push({ label:'å…¨éƒ¨', month:'ALL', mood:'ALL' });
  for(const m of months){
    buttons.push({ label:`ğŸ“ ${m}`, month:m, mood:'ALL' });
    const byMood = groupBy(byMonth[m], d=> d.mood);
    const moods = Object.keys(byMood).sort((a,b)=> a.localeCompare(b,'zh-Hant'));
    for(const mood of moods){
      buttons.push({ label:`â””â”€ ${mood} (${byMood[mood].length})`, month:m, mood });
    }
  }
  tree.innerHTML = buttons.map(b=>{
    const active = (diaryFilter.month===b.month && diaryFilter.mood===b.mood) ? 'active' : '';
    return `<button class="${active}" data-month="${escapeHtml(b.month)}" data-mood="${escapeHtml(b.mood)}">${escapeHtml(b.label)}</button>`;
  }).join('') || `<div class="hint">å°šç„¡æ—¥è¨˜ã€‚</div>`;
  tree.addEventListener('click', (e)=>{
    const btn = e.target.closest('button[data-month]');
    if(!btn) return;
    diaryFilter.month = btn.dataset.month;
    diaryFilter.mood = btn.dataset.mood;
    renderDiary();
  }, { once:true });
}
function renderDiaryList(){
  const list = document.getElementById('diary_list');
  let diaries = state.diaries.slice().sort((a,b)=> new Date(b.time) - new Date(a.time));
  if(diaryFilter.month !== 'ALL'){ diaries = diaries.filter(d=> toMonthKey(d.time)===diaryFilter.month); }
  if(diaryFilter.mood !== 'ALL'){ diaries = diaries.filter(d=> d.mood === diaryFilter.mood); }
  document.getElementById('diary_kpi_filter').textContent = (diaryFilter.month==='ALL' && diaryFilter.mood==='ALL') ? 'å…¨éƒ¨' : `${diaryFilter.month==='ALL' ? 'å…¨éƒ¨æœˆä»½' : diaryFilter.month} / ${diaryFilter.mood==='ALL' ? 'å…¨éƒ¨å¿ƒæƒ…' : diaryFilter.mood}`;
  document.getElementById('diary_kpi_count').textContent = String(diaries.length);
  if(diaries.length){
    const times = diaries.map(d=> new Date(d.time).getTime()).sort((a,b)=> a - b);
    document.getElementById('diary_kpi_min').textContent = new Date(times[0]).toISOString().slice(0,10);
    document.getElementById('diary_kpi_max').textContent = new Date(times[times.length-1]).toISOString().slice(0,10);
  } else {
    document.getElementById('diary_kpi_min').textContent = 'â€”';
    document.getElementById('diary_kpi_max').textContent = 'â€”';
  }
  list.innerHTML = diaries.slice(0, 30).map(d=>{
    return `\
      <div class="item">\
        <div class="meta">\
          <span class="tag"><b>${escapeHtml(d.mood)}</b></span>\
          <span class="tag">${escapeHtml(fmtDateTime(d.time))}</span>\
          <span class="tag">${escapeHtml(toMonthKey(d.time))}</span>\
        </div>\
        <div style="white-space:pre-wrap; line-height:1.4">${escapeHtml(d.text)}</div>\
        <div class="btns" style="margin-top:6px"><button class="btn danger" onclick="deleteDiary('${d.id}')">åˆªé™¤</button></div>\
      </div>\
    `;
  }).join('') || `<div class="hint">æ­¤ç¯©é¸ä¸‹æ²’æœ‰æ—¥è¨˜ã€‚</div>`;
}
function deleteDiary(id){ state.diaries = state.diaries.filter(d=> d.id!==id); saveStateLocal(); renderAll(); }

/* =========================
   Learning Section
========================= */
let learnSubjectFilter = 'ALL';
let markmapInstance = null;
function learningTemplate(){
  return `\
    <div class="header">\
      <div class="title">\
        <h2>ğŸ“š å­¸ç¿’ç´€éŒ„</h2>\
        <p>ä»¥ã€Œç§‘ç›®ã€è‡ªå‹•å»ºç«‹è³‡æ–™å¤¾ï¼›å¯ä¸€éµç”Ÿæˆå¿ƒæ™ºåœ–ï¼ˆç§‘ç›® â†’ æ¢ç›®ï¼‰ã€‚</p>\
      </div>\
      <span class="pill learn">Learning</span>\
    </div>\
    <div class="grid">\
      <div class="card">\
        <h3>æ–°å¢å­¸ç¿’</h3>\
        <div class="form">\
          <div class="row"><label>æ—¥æœŸ</label><input id="learn_date" type="date" /></div>\
          <div class="row"><label>ç§‘ç›®</label><input id="learn_subject" placeholder="ä¾‹ï¼šè‹±æ–‡ / æŠ•è³‡ / ç¨‹å¼ / å’–å•¡" /></div>\
          <div class="row"><label>æ¨™é¡Œ</label><input id="learn_title" placeholder="ä¾‹ï¼šETF å†å¹³è¡¡åŸå‰‡" /></div>\
          <div class="row"><label>å…§å®¹</label><textarea id="learn_notes" placeholder="æ‘˜è¦ã€é‡é»ã€é€£çµâ€¦"></textarea></div>\
          <div class="btns"><button class="btn primary" id="learn_add">æ–°å¢</button></div>\
        </div>\
      </div>\
      <div class="card">\
        <div class="split">\
          <div class="folder">\
            <h4>ç§‘ç›®è³‡æ–™å¤¾</h4>\
            <div class="tree" id="learn_tree"></div>\
            <div class="btns" style="margin-top:8px">\
              <button class="btn" id="learn_clear_filter">æ¸…é™¤ç¯©é¸</button>\
              <button class="btn primary" id="learn_render_mindmap">ç”Ÿæˆå¿ƒæ™ºåœ–</button>\
            </div>\
            <div class="hint" style="margin-top:6px;">å¿ƒæ™ºåœ–ä»¥ã€Œç§‘ç›® â†’ æ¨™é¡Œã€çµ„ç¹”ï¼Œé©åˆåšå›é¡§ç´¢å¼•ã€‚</div>\
          </div>\
          <div>\
            <h3>æ¸…å–®</h3>\
            <div class="list" id="learn_list"></div>\
            <h3 style="margin-top:10px;">å¿ƒæ™ºåœ–</h3>\
            <div class="chart-wrap" style="height:280px; overflow:hidden;">\
              <svg id="mindmap" style="width:100%;height:100%;"></svg>\
            </div>\
          </div>\
        </div>\
      </div>\
    </div>\
  `;
}
function renderLearning(){
  const root = document.getElementById('view-learning');
  root.innerHTML = learningTemplate();
  document.getElementById('learn_date').value = toISODate(new Date());
  document.getElementById('learn_add').addEventListener('click', ()=>{
    const date = document.getElementById('learn_date').value;
    const subject = document.getElementById('learn_subject').value.trim();
    const title = document.getElementById('learn_title').value.trim();
    const notes = document.getElementById('learn_notes').value.trim();
    if(!date || !subject || !title){ alert('è«‹è‡³å°‘å¡«ï¼šæ—¥æœŸã€ç§‘ç›®ã€æ¨™é¡Œ'); return; }
    state.learnings.unshift({ id: uid('l'), date, subject, title, notes, createdAt: new Date().toISOString() });
    saveStateLocal();
    renderLearning();
  });
  document.getElementById('learn_clear_filter').addEventListener('click', ()=>{ learnSubjectFilter = 'ALL'; renderLearning(); });
  document.getElementById('learn_render_mindmap').addEventListener('click', ()=>{ renderMindMap(); });
  renderLearningTree();
  renderLearningList();
  renderMindMap();
}
function renderLearningTree(){
  const tree = document.getElementById('learn_tree');
  const subjects = Array.from(new Set(state.learnings.map(x=> x.subject))).sort((a,b)=> a.localeCompare(b,'zh-Hant'));
  const items = [{ label:`å…¨éƒ¨ (${state.learnings.length})`, subject:'ALL' }].concat(subjects.map(s=>{ const n = state.learnings.filter(x=> x.subject===s).length; return { label:`ğŸ“ ${s} (${n})`, subject:s }; }));
  tree.innerHTML = items.map(it=>{
    const active = (learnSubjectFilter===it.subject) ? 'active' : '';
    return `<button class="${active}" data-subject="${escapeHtml(it.subject)}">${escapeHtml(it.label)}</button>`;
  }).join('') || `<div class="hint">å°šç„¡å­¸ç¿’ç´€éŒ„ã€‚</div>`;
  tree.addEventListener('click', (e)=>{
    const btn = e.target.closest('button[data-subject]');
    if(!btn) return;
    learnSubjectFilter = btn.dataset.subject;
    renderLearning();
  }, { once:true });
}
function renderLearningList(){
  const list = document.getElementById('learn_list');
  let arr = state.learnings.slice().sort((a,b)=> new Date(b.date) - new Date(a.date));
  if(learnSubjectFilter !== 'ALL'){ arr = arr.filter(x=> x.subject === learnSubjectFilter); }
  list.innerHTML = arr.slice(0,30).map(x=>{
    return `\
      <div class="item">\
        <div class="meta">\
          <span class="tag"><b>${escapeHtml(x.subject)}</b></span>\
          <span class="tag">${escapeHtml(x.date)}</span>\
        </div>\
        <div style="font-weight:700; margin-bottom:4px">${escapeHtml(x.title)}</div>\
        <div class="hint" style="white-space:pre-wrap">${x.notes ? escapeHtml(x.notes) : 'ï¼ˆç„¡å…§å®¹ï¼‰'}</div>\
        <div class="btns" style="margin-top:6px"><button class="btn danger" onclick="deleteLearning('${x.id}')">åˆªé™¤</button></div>\
      </div>\
    `;
  }).join('') || `<div class="hint">æ­¤ç¯©é¸ä¸‹æ²’æœ‰å­¸ç¿’ç´€éŒ„ã€‚</div>`;
}
function deleteLearning(id){ state.learnings = state.learnings.filter(x=> x.id !== id); saveStateLocal(); renderAll(); }
function renderMindMap(){
  const svg = document.getElementById('mindmap');
  if(!svg) return;
  const bySubject = groupBy(state.learnings, x=> x.subject);
  const subjects = Object.keys(bySubject).sort((a,b)=> a.localeCompare(b,'zh-Hant'));
  let md = '# å­¸ç¿’ç¸½è¦½\n';
  for(const s of subjects){ md += `## ${s}\n`; const items = bySubject[s].slice().sort((a,b)=> new Date(b.date)-new Date(a.date)).slice(0,20); for(const it of items){ md += `- ${it.title} (${it.date})\n`; } }
  svg.innerHTML = '';
  const { Transformer } = window.markmap;
  const transformer = new Transformer();
  const { root } = transformer.transform(md);
  markmapInstance = window.markmap.Markmap.create(svg,{ autoFit:true, duration:0, maxWidth:240 }, root);
}

/* =========================
   Finance Section
========================= */
let incomePie = null;
let expensePie = null;
function financeTemplate(){
  return `\
    <div class="header">\
      <div class="title">\
        <h2>ğŸ’° æ”¶æ”¯ç´€éŒ„</h2>\
        <p>æ”¶å…¥/æ”¯å‡ºåˆ†é–‹å‘ˆç¾åœ“é¤…åœ–ï¼›æ”¯æ´è¨‚é–±è‡ªå‹•æ‰£æ¬¾ï¼ˆæ¯æœˆæŒ‡å®šæ—¥ï¼‰ã€‚</p>\
      </div>\
      <span class="pill money">Finance</span>\
    </div>\
    <div class="grid">\
      <div class="card">\
        <h3>æ–°å¢äº¤æ˜“</h3>\
        <div class="form">\
          <div class="row"><label>æ—¥æœŸ</label><input id="fin_date" type="date" /></div>\
          <div class="row"><label>é¡å‹</label><select id="fin_type"><option value="expense">æ”¯å‡º</option><option value="income">æ”¶å…¥</option></select></div>\
          <div class="row"><label>åˆ†é¡</label><input id="fin_category" placeholder="ä¾‹ï¼šé¤é£² / äº¤é€š / æˆ¿ç§Ÿ / è–ªè³‡" /></div>\
          <div class="row"><label>é‡‘é¡</label><input id="fin_amount" type="number" min="0" step="1" /></div>\
          <div class="row"><label>å‚™è¨»</label><input id="fin_note" placeholder="å¯é¸" /></div>\
          <div class="btns"><button class="btn primary" id="fin_add">æ–°å¢</button></div>\
        </div>\
        <h3 style="margin-top:12px;">è¨‚é–±æ‰£æ¬¾ï¼ˆæ¯æœˆï¼‰</h3>\
        <div class="form">\
          <div class="row"><label>åç¨±</label><input id="sub_name" placeholder="ä¾‹ï¼šNetflix / iCloud / å¥èº«æˆ¿" /></div>\
          <div class="row"><label>åˆ†é¡</label><input id="sub_category" placeholder="ä¾‹ï¼šè¨‚é–± / å·¥å…· / å¥èº«" /></div>\
          <div class="row"><label>æ‰£æ¬¾æ—¥</label><input id="sub_day" type="number" min="1" max="28" step="1" placeholder="å»ºè­° 1-28" /></div>\
          <div class="row"><label>é‡‘é¡</label><input id="sub_amount" type="number" min="0" step="1" /></div>\
          <div class="btns">\
            <button class="btn primary" id="sub_add">æ–°å¢è¨‚é–±</button>\
            <button class="btn" id="sub_run">ç”Ÿæˆæœ¬æœˆè¨‚é–±æ‰£æ¬¾</button>\
          </div>\
          <div class="hint">ç³»çµ±æœƒåœ¨ä½ é–‹å•Ÿç¶²ç«™æ™‚è‡ªå‹•æª¢æŸ¥ï¼šè‹¥ã€Œä»Šå¤©å·²åˆ°æ‰£æ¬¾æ—¥ã€ä¸”æœ¬æœˆå°šæœªç”Ÿæˆï¼Œå°‡è‡ªå‹•æ–°å¢ä¸€ç­†æ”¯å‡ºã€‚</div>\
        </div>\
      </div>\
      <div class="card">\
        <div class="split">\
          <div>\
            <h3>åœ“é¤…åœ–ï¼šæ”¯å‡ºåˆ†é¡</h3>\
            <div class="pie-row">\
              <div class="chart-wrap" style="height:240px;"><canvas id="expense_pie"></canvas></div>\
              <div class="pie-details" id="expense_details"></div>\
            </div>\
          </div>\
          <div>\
            <h3>åœ“é¤…åœ–ï¼šæ”¶å…¥åˆ†é¡</h3>\
            <div class="pie-row">\
              <div class="chart-wrap" style="height:240px;"><canvas id="income_pie"></canvas></div>\
              <div class="pie-details" id="income_details"></div>\
            </div>\
          </div>\
        </div>\
        <div style="margin-top:10px"><h3>æœ€è¿‘äº¤æ˜“</h3><div class="list" id="fin_list"></div></div>\
        <div style="margin-top:10px"><h3>è¨‚é–±æ¸…å–®</h3><div class="list" id="sub_list"></div></div>\
      </div>\
    </div>\
  `;
}
function renderFinance(){
  const root = document.getElementById('view-finance');
  root.innerHTML = financeTemplate();
  document.getElementById('fin_date').value = toISODate(new Date());
  document.getElementById('fin_add').addEventListener('click', ()=>{
    const date = document.getElementById('fin_date').value;
    const type = document.getElementById('fin_type').value;
    const category = document.getElementById('fin_category').value.trim();
    const amount = Number(document.getElementById('fin_amount').value || 0);
    const note = document.getElementById('fin_note').value.trim();
    if(!date || !category || amount<=0){ alert('è«‹è‡³å°‘å¡«ï¼šæ—¥æœŸã€åˆ†é¡ã€é‡‘é¡(>0)'); return; }
    state.transactions.unshift({ id: uid('t'), date, type, category, amount, note, createdAt: new Date().toISOString() });
    saveStateLocal();
    renderFinance();
  });
  document.getElementById('sub_add').addEventListener('click', ()=>{
    const name = document.getElementById('sub_name').value.trim();
    const category = document.getElementById('sub_category').value.trim();
    const day = Number(document.getElementById('sub_day').value || 0);
    const amount = Number(document.getElementById('sub_amount').value || 0);
    if(!name || !category || day<1 || day>28 || amount<=0){ alert('è¨‚é–±éœ€å¡«ï¼šåç¨±ã€åˆ†é¡ã€æ‰£æ¬¾æ—¥(1-28)ã€é‡‘é¡(>0)'); return; }
    state.subscriptions.unshift({ id: uid('s'), name, category, dayOfMonth: day, amount, lastGeneratedMonth: null });
    saveStateLocal();
    renderFinance();
  });
  document.getElementById('sub_run').addEventListener('click', ()=>{ runSubscriptionAutopost(true); renderFinance(); });
  // auto run subscription generation
  runSubscriptionAutopost(false);
  renderFinanceCharts();
  renderFinanceList();
  renderSubscriptionList();
}
function runSubscriptionAutopost(manual){
  const now = new Date();
  const month = `${now.getFullYear()}-${pad2(now.getMonth()+1)}`;
  const day = now.getDate();
  let generated = 0;
  for(const s of state.subscriptions){
    const shouldGenerate = (day >= s.dayOfMonth) && (s.lastGeneratedMonth !== month);
    if(shouldGenerate){
      state.transactions.unshift({ id: uid('t'), date: toISODate(now), type:'expense', category: s.category, amount: s.amount, note: `è¨‚é–±ï¼š${s.name}ï¼ˆ${month}ï¼‰`, createdAt: new Date().toISOString() });
      s.lastGeneratedMonth = month;
      generated++;
    }
  }
  if(generated>0){ saveStateLocal(); if(manual) alert(`å·²ç”Ÿæˆ ${generated} ç­†æœ¬æœˆè¨‚é–±æ‰£æ¬¾ã€‚`); }
  else{ if(manual) alert('æœ¬æœˆè¨‚é–±æ‰£æ¬¾ç„¡éœ€ç”Ÿæˆï¼ˆå¯èƒ½å°šæœªåˆ°æ‰£æ¬¾æ—¥ï¼Œæˆ–å·²ç”Ÿæˆï¼‰ã€‚'); }
}
function renderFinanceCharts(){
  if(incomePie){ incomePie.destroy(); incomePie = null; }
  if(expensePie){ expensePie.destroy(); expensePie = null; }
  const expenses = state.transactions.filter(t=> t.type==='expense');
  const income = state.transactions.filter(t=> t.type==='income');
  const expenseByCat = groupBy(expenses, t=> t.category);
  const incomeByCat = groupBy(income, t=> t.category);
  const expLabels = Object.keys(expenseByCat).sort((a,b)=> a.localeCompare(b,'zh-Hant'));
  const incLabels = Object.keys(incomeByCat).sort((a,b)=> a.localeCompare(b,'zh-Hant'));
  const expData = expLabels.map(k=> sum(expenseByCat[k].map(x=> x.amount)));
  const incData = incLabels.map(k=> sum(incomeByCat[k].map(x=> x.amount)));
  const expCanvas = document.getElementById('expense_pie');
  const incCanvas = document.getElementById('income_pie');
  expensePie = new Chart(expCanvas, {
    type:'pie',
    data:{ labels: expLabels.length ? expLabels : ['ï¼ˆå°šç„¡æ”¯å‡ºï¼‰'], datasets:[{ data: expLabels.length ? expData : [1] }] },
    options:{
      plugins:{
        tooltip:{ callbacks:{ label:(ctx)=>{ if(!expLabels.length) return 'å°šç„¡è³‡æ–™'; const v = ctx.parsed; return ` ${ctx.label}: ${v}`; } } }
      }
    }
  });
  incomePie = new Chart(incCanvas, {
    type:'pie',
    data:{ labels: incLabels.length ? incLabels : ['ï¼ˆå°šç„¡æ”¶å…¥ï¼‰'], datasets:[{ data: incLabels.length ? incData : [1] }] },
    options:{
      plugins:{
        tooltip:{ callbacks:{ label:(ctx)=>{ if(!incLabels.length) return 'å°šç„¡è³‡æ–™'; const v = ctx.parsed; return ` ${ctx.label}: ${v}`; } } }
      }
    }
  });
  // update details lists
  const expDetailEl = document.getElementById('expense_details');
  const incDetailEl = document.getElementById('income_details');
  if(expDetailEl){
    if(expLabels.length){
      const totalExp = expData.reduce((a,b)=> a+b, 0) || 1;
      expDetailEl.innerHTML = expLabels.map((lbl, i)=>{
        const val = expData[i];
        const perc = totalExp ? ((val/totalExp)*100).toFixed(1) : '0.0';
        return `<div>${escapeHtml(lbl)}: ${escapeHtml(String(val))} (${perc}%)</div>`;
      }).join('');
    }else{
      expDetailEl.innerHTML = '<div>â€”</div>';
    }
  }
  if(incDetailEl){
    if(incLabels.length){
      const totalInc = incData.reduce((a,b)=> a+b, 0) || 1;
      incDetailEl.innerHTML = incLabels.map((lbl, i)=>{
        const val = incData[i];
        const perc = totalInc ? ((val/totalInc)*100).toFixed(1) : '0.0';
        return `<div>${escapeHtml(lbl)}: ${escapeHtml(String(val))} (${perc}%)</div>`;
      }).join('');
    }else{
      incDetailEl.innerHTML = '<div>â€”</div>';
    }
  }
}
function renderFinanceList(){
  const list = document.getElementById('fin_list');
  const items = state.transactions.slice().sort((a,b)=> new Date(b.date) - new Date(a.date)).slice(0, 16);
  list.innerHTML = items.map(t=>{
    const sign = (t.type==='expense') ? '-' : '+';
    const tag = (t.type==='expense') ? 'æ”¯å‡º' : 'æ”¶å…¥';
    return `\
      <div class="item">\
        <div class="meta">\
          <span class="tag"><b>${escapeHtml(tag)}</b></span>\
          <span class="tag">${escapeHtml(t.date)}</span>\
          <span class="tag">${escapeHtml(t.category)}</span>\
          <span class="tag">${sign}${escapeHtml(String(t.amount))}</span>\
        </div>\
        <div class="hint">${t.note ? escapeHtml(t.note) : 'ï¼ˆç„¡å‚™è¨»ï¼‰'}</div>\
        <div class="btns" style="margin-top:6px"><button class="btn danger" onclick="deleteTransaction('${t.id}')">åˆªé™¤</button></div>\
      </div>\
    `;
  }).join('') || `<div class="hint">å°šç„¡äº¤æ˜“ç´€éŒ„ã€‚</div>`;
}
function deleteTransaction(id){ state.transactions = state.transactions.filter(t=> t.id!==id); saveStateLocal(); renderAll(); }
function renderSubscriptionList(){
  const list = document.getElementById('sub_list');
  const subs = state.subscriptions.slice();
  list.innerHTML = subs.map(s=>{
    return `\
      <div class="item">\
        <div class="meta">\
          <span class="tag"><b>${escapeHtml(s.name)}</b></span>\
          <span class="tag">${escapeHtml(s.category)}</span>\
          <span class="tag">æ¯æœˆ ${escapeHtml(String(s.dayOfMonth))} æ—¥</span>\
          <span class="tag">${escapeHtml(String(s.amount))}</span>\
        </div>\
        <div class="hint">æœ¬æœˆç”Ÿæˆç‹€æ…‹ï¼š${s.lastGeneratedMonth ? escapeHtml(s.lastGeneratedMonth) : 'å°šæœªç”Ÿæˆ'}</div>\
        <div class="btns" style="margin-top:6px"><button class="btn danger" onclick="deleteSubscription('${s.id}')">åˆªé™¤</button></div>\
      </div>\
    `;
  }).join('') || `<div class="hint">å°šç„¡è¨‚é–±ã€‚</div>`;
}
function deleteSubscription(id){ state.subscriptions = state.subscriptions.filter(s=> s.id!==id); saveStateLocal(); renderAll(); }

/* =========================
   Render All
========================= */
function renderAll(){
  const active = document.querySelector('.nav button.active')?.dataset.view || 'fitness';
  if(active === 'fitness') renderFitness();
  if(active === 'diary') renderDiary();
  if(active === 'learning') renderLearning();
  if(active === 'finance') renderFinance();
}

// Boot: load state and perform initial render
state = loadStateLocal();
renderAll();
</script>
</body>
</html>